<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>陳萬龍診所門診線上預約</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
  /* ====== 小型「診別載入中…」提示 ====== */
  .slots-loading{ font-size:.95rem; color:#6b7b8c; margin-top:6px; }
  .slots-loading .dots::after{
    content:""; display:inline-block; width:1.4em; text-align:left;
    animation: slotDots 1.1s steps(3,end) infinite;
  }
  @keyframes slotDots{
    0%{content:"";}
    33%{content:".";}
    66%{content:"..";}
    100%{content:"...";}
  }

  /* ====== 全螢幕「預約中」遮罩 ====== */
  #submitOverlay[hidden]{ display:none; }
  #submitOverlay{
    position:fixed; inset:0; z-index:9999;
    background:rgba(255,255,255,.9);
    display:grid; place-items:center;
    backdrop-filter: blur(2px);
    font-size:18px; color:#2e5a79;
  }
  #submitOverlay .box{
    text-align:center; padding:20px 26px;
    background:#fff; border:1px solid #e3eef6; border-radius:14px;
    box-shadow:0 10px 28px rgba(17,45,78,.12);
  }
  #submitOverlay .title{ font-weight:800; font-size:20px; }
  #submitOverlay .sub{ margin-top:6px; color:#6b7b8c; font-size:14px; }
  #submitOverlay .dots::after{
    content:""; display:inline-block; width:1.6em; text-align:left;
    animation: submitDots 1.2s steps(3,end) infinite;
  }
  @keyframes submitDots{
    0%{content:"";}
    33%{content:".";}
    66%{content:"..";}
    100%{content:"...";}
  }
</style>
</head>
<body>
<div class="card">
  <div class="header">
    <div class="logo">＋</div>
    <h1>陳萬龍診所門診線上預約</h1>
  </div>

  <!-- 預約日期 -->
  <div class="mb-3">
    <label class="form-label">預約日期 *</label>
    <div class="d-flex align-items-center flex-nowrap">
      <input type="date" id="date" class="form-control" style="max-width:70%;">
      <span id="weekday" class="ms-2"></span>
    </div>
  </div>

  <!-- 診別 -->
  <div class="mb-1">
    <label class="form-label">診別 *</label>
    <select id="slot" class="form-select">
      <option value="">請先選擇日期</option>
    </select>
    <div id="slotsLoading" class="slots-loading" style="display:none">
      <span class="dots">讀取中請稍等</span>
    </div>
  </div>

  <!-- 姓名 -->
  <div class="mb-3">
    <label class="form-label">姓名 *</label>
    <input type="text" id="name" class="form-control">
  </div>

  <!-- 生日 -->
  <div class="mb-3">
    <label class="form-label">出生年月日 *</label>
    <input type="date" id="birthday" class="form-control">
  </div>

  <!-- 身分證字號 -->
  <div class="mb-3">
    <label class="form-label">身分證字號 *</label>
    <input type="text" id="idnum" class="form-control" maxlength="10" placeholder="A123456789">
  </div>

  <!-- 電話 -->
  <div class="mb-3">
    <label class="form-label">連絡電話 *</label>
    <input type="text" id="phone" class="form-control" maxlength="10" placeholder="0958xxxxxx">
  </div>

  <!-- 預約須知 -->
  <div class="form-check mb-4">
    <input type="checkbox" id="agree" class="form-check-input">
    <label for="agree" class="form-check-label">
      我已閱讀並同意 <a href="#" id="showNotice">預約須知</a>
    </label>
  </div>

  <button id="submitBtn" class="btn-main w-100">送出預約</button>
  <a href="query.html" class="d-block mt-3 text-center text-decoration-underline" style="color:#3b7096;">查詢／取消預約</a>
</div>

<!-- Modal：預約須知 -->
<div class="modal fade" id="noticeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5>預約須知與個資告知</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="text-align:left;">
        <p>1. 本院蒐集之個人資料僅用於醫療與聯繫用途。</p>
        <p>2. 請於預約時段內準時報到，逾時視同放棄。</p>
        <p>3. 如需取消，請於前一日線上辦理；當日請電話。</p>
        <p>4. 本院保留看診順序調整權利。</p>
      </div>
    </div>
  </div>
</div>

<!-- 全螢幕：預約中 -->
<div id="submitOverlay" hidden>
  <div class="box">
    <div class="title"><span class="dots">預約中</span></div>
    <div class="sub">請勿離開網頁或重新整理</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ====== GAS API ====== */
const API = "https://script.google.com/macros/s/AKfycbzknf2k03PsltF5RXXVLUwKsLTkPQeVPQNDcWpV5eeGzIeYKv99Ju_8yWlX1UKoJ9RY/exec";

/* ====== DOM ====== */
const dateInput = document.getElementById("date");
const weekdayEl = document.getElementById("weekday");
const slotSel   = document.getElementById("slot");
const slotsHint = document.getElementById("slotsLoading");
const nameEl    = document.getElementById("name");
const birthdayEl= document.getElementById("birthday");
const idEl      = document.getElementById("idnum");
const phoneEl   = document.getElementById("phone");
const agreeEl   = document.getElementById("agree");
const submitBtn = document.getElementById("submitBtn");
const overlay   = document.getElementById("submitOverlay");

/* ====== 日期限制（明天～15天） ====== */
const today=new Date(),min=new Date(today.getTime()+86400000),max=new Date(today.getTime()+15*86400000);
dateInput.min=min.toISOString().split("T")[0];
dateInput.max=max.toISOString().split("T")[0];
dateInput.value = dateInput.min;

/* ====== 工具 ====== */
const wtxt=['日','一','二','三','四','五','六'];
function updateWeekday(d){
  weekdayEl.textContent = d ? `（星期${wtxt[new Date(d).getDay()]}）` : '';
}
updateWeekday(dateInput.value);

const debounce=(fn,ms=200)=>{let t;return (...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),ms)}};

// axios 取消前一次請求
let slotsAbortCtl = null;
async function loadSlots(dateStr){
  if(!dateStr) return;
  if(slotsAbortCtl) slotsAbortCtl.abort();
  slotsAbortCtl = new AbortController();

  slotsHint.style.display='block';
  slotSel.innerHTML='<option value="">讀取中…</option>';
  try{
    const r=await axios.get(API,{params:{action:'getSlots',date:dateStr},signal:slotsAbortCtl.signal});
    const arr=Array.isArray(r.data)?r.data:[];
    let html='<option value="">請選診別</option>';
    arr.forEach(o=>{
      const remain=Math.max(0,Number(o.limit||0)-Number(o.used||0));
      if(Number(o.limit)>0 && remain>0){
        html+=`<option value="${o.label}" data-time="${o.time||''}" data-start="${o.startNo||''}">
                  ${o.label}（${o.time||''}，剩 ${remain}/${o.limit}）
               </option>`;
      }
    });
    if(html==='﻿<option value="">請選診別</option>') html='<option value="">當天未開放</option>';
    slotSel.innerHTML=html;
  }catch(e){
    if(e.name!=='CanceledError'){
      console.error(e);
      slotSel.innerHTML='<option value="">讀取失敗</option>';
    }
  }finally{
    slotsHint.style.display='none';
  }
}
dateInput.addEventListener('change', ()=>{
  updateWeekday(dateInput.value);
  debounce(()=>loadSlots(dateInput.value),150)();
});

/* ====== 輸入限制 ====== */
idEl.addEventListener("input",e=>{
  e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,10)
});
phoneEl.addEventListener("input",e=>{
  e.target.value=e.target.value.replace(/\D/g,'').slice(0,10)
});

/* ====== 彈窗 ====== */
document.getElementById('showNotice').onclick=(e)=>{e.preventDefault(); new bootstrap.Modal(document.getElementById('noticeModal')).show();};

/* ====== 「預約中」遮罩 ====== */
function showOverlay(show){ overlay.hidden = !show; }

/* ====== 送出 ====== */
submitBtn.onclick=async()=>{
  const d=dateInput.value, s=slotSel.value,
        opt=slotSel.options[slotSel.selectedIndex],
        t=opt?.dataset.time||"",
        startNo=opt?.dataset.start||"",
        n=nameEl.value.trim(),
        b=birthdayEl.value,
        id=idEl.value.trim().toUpperCase(),
        ph=phoneEl.value.trim(),
        ag=agreeEl.checked;

  if(!d||!s||!n||!b||!id||!ph||!ag) return alert("資料未填完整");
  if(!/^[A-Z][12]\d{8}$/.test(id))   return alert("身分證格式錯誤");
  if(ph.length<8||ph.length>10)     return alert("電話長度不符");

  submitBtn.disabled=true; showOverlay(true);
  try{
    const r=await axios.get(API,{params:{action:'submit',date:d,slot:s,name:n,birthday:b,id:id,phone:ph,startNo:startNo}});
    location=`success.html?id=${encodeURIComponent(r.data.id)}`;
  }catch(e){
    console.error(e);
    alert("送出失敗，請再試一次");
  }finally{
    showOverlay(false); submitBtn.disabled=false;
  }
};

/* 初次載入明天時段 */
loadSlots(dateInput.value);
</script>
</body>
</html>
