<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>陳萬龍診所門診線上預約</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="favicon.png">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<script>
const API = "https://script.google.com/macros/s/AKfycbzRmUag-TbdRifSp0xB2i4VSH12d3bx5QqawHF0LUM9wqs1iIcRhZX62B0xqqPnX7o9/exec";
const RECAPTCHA_SITE_KEY = "6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu";

let recaptchaLoaded=false, recaptchaLoading=null;
function loadRecaptcha(){
  if(!RECAPTCHA_SITE_KEY) return Promise.resolve();
  if(recaptchaLoaded) return Promise.resolve();
  if(recaptchaLoading) return recaptchaLoading;
  recaptchaLoading = new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src="https://www.google.com/recaptcha/api.js?render="+encodeURIComponent(RECAPTCHA_SITE_KEY);
    s.async=true; s.defer=true;
    s.onload=()=>{recaptchaLoaded=true;resolve();};
    s.onerror=()=>reject(new Error("recaptcha_load_fail"));
    document.head.appendChild(s);
  });
  return recaptchaLoading;
}
async function getRecaptchaToken(){
  try{
    if(!RECAPTCHA_SITE_KEY) return "";
    await loadRecaptcha();
    return await new Promise(res=>{
      grecaptcha.ready(()=> grecaptcha.execute(RECAPTCHA_SITE_KEY,{action:"submit"}).then(t=>res(t)).catch(()=>res("")));
    });
  }catch(_){ return ""; }
}

const AES_KEY = "A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";
function aesEnc(payload, ttlMs = 10 * 60 * 1000){
  const obj = { ...payload };
  if (ttlMs && Number.isFinite(ttlMs)) obj.exp = Date.now() + ttlMs;
  const cipher = CryptoJS.AES.encrypt(JSON.stringify(obj), AES_KEY).toString();
  return encodeURIComponent(cipher);
}
</script>

<style>
  :root{
    --purple:#6236a7;
    --purple-600:#4b2c86;
    --ink:#2a2341;
    --line:#ebe6fb;
    --outline:#cfd3de;
    --outline-text:#5c6170;
  }
  body{ background:#f4eefc; }

  /* 卡片：恢復正常邊框 */
  .card{
    max-width:780px; margin:32px auto; padding:28px 22px 32px;
    border-radius:24px; border:1px solid var(--line); background:#fff;
    box-shadow:0 12px 28px rgba(98,54,167,.10);
  }

  /* 標題 */
  .header{
    display:flex; align-items:center; justify-content:center;
    gap:14px; margin-bottom:12px; text-align:center;
  }
  .header .logo{
    width:60px; height:60px; border-radius:50%;
    display:grid; place-items:center;
    background:var(--purple); color:#fff; font-weight:900; font-size:32px;
    box-shadow:0 6px 14px rgba(98,54,167,.20);
  }
  .header h1{ margin:0; font-size:2rem; line-height:1; font-weight:900; color:var(--ink); }

  /* 注意事項泡泡 */
  .note-bubble{
    margin:10px 0 8px 0;
    color:#6b5f92; font-weight:700; font-size:.95rem;
    background:#f4f0ff; border:1px solid #ebe6fb; border-radius:12px; padding:10px 12px;
  }

  /* 小標粗體、輸入框恢復細邊 */
  .form-label,.form-check-label{ font-weight:800; color:#2f2750; }
  .form-control,.form-select{
    border-radius:14px;
    border:1px solid var(--outline);
    box-shadow:none;
  }
  .form-control:focus,.form-select:focus{
    border-color:var(--purple);
    outline:0; box-shadow:0 0 0 .2rem rgba(98,54,167,.15);
  }
  #weekday{ color:#7b6aa4; font-weight:800; }

  /* 圓角膠囊按鈕 */
  .btn-pill{ border-radius:999px; font-weight:800; padding:1rem 1.25rem; }
  .btn-main{ background:var(--purple); color:#fff; border:none; }
  .btn-main:hover{ background:var(--purple-600); color:#fff; }
  .btn-outline-gray{
    background:#fff; color:var(--outline-text);
    border:2px solid var(--outline);
  }
  .btn-outline-gray:hover{
    background:#f7f8fb; color:#3a3f47; border-color:#bfc6d2;
  }

  /* 錯誤訊息列 */
  #errBar{ margin-top:-8px; }

  /* 遮罩 */
  #mask{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
         z-index:9999; font-size:18px; color:var(--purple-600);
         background:rgba(255,255,255,.9); backdrop-filter:blur(2px); }
  #dots{ display:inline-block; width:2ch; text-align:left; }
</style>
</head>
<body>
<div id="mask">預約中請稍等，請勿關閉或重新整理頁面<span id="dots">...</span></div>

<div class="card">
  <div class="header">
    <div class="logo">＋</div>
    <h1>陳萬龍診所門診線上預約</h1>
  </div>

  <div id="errBar" class="alert alert-danger d-none" role="alert"></div>

  <div class="mb-3 mt-2">
    <label class="form-label">預約日期 *</label>
    <div class="note-bubble">
      只能選擇今天起後 2~14 天內的門診；無選項可選表示預約已額滿。
    </div>
    <div class="d-flex align-items-center flex-nowrap">
      <input type="date" id="date" class="form-control" style="max-width:70%;" autocomplete="off" />
      <span id="weekday" class="ms-2"></span>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">診別 *</label>
    <select id="slot" class="form-select" autocomplete="off">
      <option value="">請先選擇日期</option>
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">姓名 *</label>
    <input type="text" id="name" class="form-control" autocomplete="off" />
  </div>

  <div class="mb-3">
    <label class="form-label">出生年月日 *</label>
    <input type="date" id="birthday" class="form-control" autocomplete="off" />
  </div>

  <div class="mb-3">
    <label class="form-label">身分證字號 *</label>
    <input type="text" id="idnum" class="form-control" maxlength="10" placeholder="A123456789" autocomplete="off" />
  </div>

  <div class="mb-3">
    <label class="form-label">連絡電話 *</label>
    <input type="text" id="phone" class="form-control" maxlength="10" placeholder="0958xxxxxx" inputmode="numeric" autocomplete="off" />
  </div>

  <div class="form-check mb-4">
    <input type="checkbox" id="agree" class="form-check-input" />
    <label for="agree" class="form-check-label">
      我已閱讀並同意 <a href="#" id="showNotice">預約須知</a>
    </label>
  </div>

  <div class="d-grid gap-3">
    <button id="submitBtn" class="btn btn-pill btn-main">送出預約</button>
    <a href="query.html" class="btn btn-pill btn-outline-gray text-decoration-none text-center">查詢／取消預約</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
