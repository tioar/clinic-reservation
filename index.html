<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>陳萬龍診所門診線上預約</title>
<link rel="icon" type="image/png" href="favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<!-- 近似楷體的開源備援 -->
<link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ===================== 主題變數 ===================== */
:root{
  --classic-blue:#34558b;
  --provence:#678fc9;
  --baby-blue:#bfd2dd;
  --monument:#7b858a;
  --stucco:#9b8577;

  --primary:var(--classic-blue);
  --ink:#1c2430;
  --bg:#f4f6f8;
  --card:#ffffff;
  --line:#e6ebf1;

  --spin-color:#7f93b1;
  --spin-fade:1.2s;
}

/* ===================== 字型（TW-Kai 為主） ===================== */
@font-face{
  font-family:"TW-Kai";
  src:url("./fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"CwTeXKai";
  src:url("./fonts/CwTeXKai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}

*{box-sizing:border-box}
html,body{width:100%;max-width:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:
    "TW-Kai","CwTeXKai","LXGW WenKai TC",
    "DFKai-SB","KaiTi","Kaiti TC","Kaiti SC","BiauKai",
    "STFangsong","FangSong",
    "PingFang TC","Microsoft JhengHei",serif;
  font-weight:400;
}

/* ★ 只收斂在月曆元件；不再全站汙染 button / input */
.day, .tile, .pill, .modal-content, .rule-btn, .nav-btn { border-radius:0 !important; }

.wrap{max-width:960px;margin:16px auto;padding:12px}

/* ===================== Header ===================== */
.page-head{display:flex;align-items:center;justify-content:center;gap:14px;margin:6px 8px 14px}
.page-head .logo{width:64px;height:64px;display:grid;place-items:center;background:var(--primary);color:#fff;font-weight:700;font-size:34px}
.page-head h1{margin:0;font-weight:700;font-size:clamp(1.5rem,2.6vw,2.2rem);color:var(--primary)}

/* ===================== 卡片容器 ===================== */
.cardish{background:var(--card);border:1px solid var(--line)}
.section{padding:14px}

/* ===================== 月曆標題列 ===================== */
.cal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
.cal-title{font-weight:700;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.cal-title .title-text{font-size:clamp(1.2rem,2.4vw,1.6rem);font-weight:700}
/* loader 固定橫排：圈圈 + 文字 */
.loader{display:inline-flex;align-items:center;gap:.4rem;color:var(--monument);font-size:.95rem;white-space:nowrap;min-width:6.5em}

/* nav arrows（方角；不禁用，避免游標變禁止符號） */
.nav{display:flex;gap:8px}
.nav-btn{
  width:40px;height:36px;border:1px solid var(--primary);
  background:#fff;color:var(--primary);
  font-weight:700;font-size:18px;line-height:1;
  display:grid;place-items:center;cursor:pointer;user-select:none;
}
.nav-btn:hover{background:#f2f6ff}
.nav-btn:focus{outline:2px solid #c9d6ea; outline-offset:1px}

/* 規則列＋現在時間 */
.rule-bar{display:flex;align-items:center;gap:10px;padding:6px 12px 0 12px;flex-wrap:wrap}
.rule-btn{border:1px solid var(--primary);background:#fff;color:var(--primary);font-weight:700;padding:.42rem .9rem}
.nowtime{color:var(--primary);font-weight:700;letter-spacing:.5px}

/* ===================== 週標題 & 月曆格 ===================== */
.grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;padding:10px}
.wday{font-size:.9rem;color:var(--monument);text-align:center;font-weight:700}

/* 日格 */
.day{border:1px solid #e2e7ee;min-height:74px;padding:8px;display:flex;flex-direction:column;gap:6px;background:#fff;transition:.12s;overflow:hidden}
.day .d{font-weight:700;color:#1f2b3a}
.day .meta{margin-top:auto;display:flex;flex-wrap:wrap;gap:6px}
.day .meta .state{font-weight:700;color:#8b90a3}
.day.clickable{cursor:pointer}
.day.clickable:hover{outline:2px solid #c9d6ea}
.day.disabled{background:#f3f5f7;color:#8b90a3;border-color:#e5e7eb;pointer-events:none}
.day.selected{outline:2px solid var(--provence)}
.day.today{background:#eef3fb;border-color:#cad8ee}

/* pill（診別標籤） */
.pill{display:inline-flex;align-items:center;justify-content:center;gap:.3rem;border:1px solid #d7dde6;padding:.18rem .6rem;font-weight:700;font-size:clamp(.76rem,.9vw,.92rem);line-height:1.1;white-space:nowrap;min-width:4.2em}
.pill .remain{white-space:nowrap}
.pill.early{background:#e7f2ea;color:#0b523a;border-color:#b7d9c6}
.pill.noon {background:#fff2df;color:#7a4d00;border-color:#ffd79a}
.pill.night{background:#e7f0fb;color:#1646a2;border-color:#c8dcff}
.pill.appt {background:#f9e7ee;color:#9b1f79;border-color:#f6b6dc}
.pill.stop{background:#f5e6e5;color:#b91c1c;border-color:#efc7c4}
.pill.full{background:#eef1f5;color:#6b7280;border-color:#e5e7eb}

/* 「今天~開放日前」的灰掉視覺（同色系，但不可點） */
.pill.dim{opacity:.55;filter:saturate(70%);}

/* 當日面板（下方診別清單） */
#dayPanel{display:none}
#dayPanel .head{font-weight:700;margin:6px 0 10px}
.slot-grid{display:grid;grid-template-columns:1fr;gap:10px}
.tile{display:flex;align-items:center;gap:10px;border:1px solid #dfe5ee;padding:12px;background:#fff;cursor:pointer;transition:.12s;color:#1f2b3a}
.tile:hover{outline:2px solid #d4e2fa}
.tile .remain{margin-left:auto;font-weight:400;white-space:nowrap}
.tile .doc{font-weight:700;color:inherit}
.tile .main{font-weight:700;color:inherit}

/* 被選取：淺底＋深色字（與上方 pill 一致） */
.tile.selected.early{background:#e7f2ea;outline:2px solid #b7d9c6;color:#0b523a;border-color:#b7d9c6}
.tile.selected.noon {background:#fff2df;outline:2px solid #ffd79a;color:#7a4d00;border-color:#ffd79a}
.tile.selected.night{background:#e7f0fb;outline:2px solid #c8dcff;color:#1646a2;border-color:#c8dcff}
.tile.selected.appt {background:#f9e7ee;outline:2px solid #f6b6dc;color:#9b1f79;border-color:#f6b6dc}

/* 額滿：紅字 */
.tile.full .status-full{color:#b91c1c;font-weight:700}

/* = Form =（保持你原本外觀，沒動） */
.form-grid{display:grid;gap:14px;grid-template-columns:1fr}
.form-grid > div{min-width:0}
.form-label-strong{font-weight:700;margin-bottom:6px;color:#1f2b3a}
.form-input{width:100%;min-width:0;max-width:100%;border:1px solid #cfd6df;font-size:1rem;height:46px;padding:0 .9rem;background:#fff}

/* 日期輸入 */
.date-wrap{position:relative;height:46px}
input[type="date"].form-input{appearance:none;-webkit-appearance:none;height:100%;padding:0 .9rem;font-size:16px}
input[type="date"]::-webkit-date-and-time-value{height:100%;line-height:46px}
input[type="date"]::-webkit-datetime-edit{padding:0}
input[type="date"]::-webkit-datetime-edit-fields-wrapper{padding:0;margin:0}
input[type="date"]::-webkit-calendar-picker-indicator{padding:0 8px 0 0}
.date-hint{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#9aa0aa;pointer-events:none;font-size:16px;line-height:1}

/* 扁平按鈕（保持原樣） */
.btn-main,.btn-ghost{font-weight:700;padding:.9rem 1.15rem;font-size:1.05rem}
.btn-main{background:var(--primary);color:#fff;border:1px solid var(--primary)}
.btn-ghost{background:#fff;border:1px solid #d7dbe5;color:#3a3f47}

/* 規則列表 */
.rule-line{display:flex;align-items:center;gap:10px;white-space:nowrap;font-weight:700;font-size:clamp(12px,3.2vw,16px);min-width:0;letter-spacing:.5px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:.25rem .6rem;border:1px solid #e0e5eb;background:#fff}
.chip-strong{background:#eaf1ff;color:var(--primary);border-color:#d7e6ff}
.chip-range{background:#f8fafc;color:#334155}

/* ===================== 亮面掃過骨架 ===================== */
@keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
.skel-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;padding:10px}
.skel-day{
  height:74px;border:1px solid var(--baby-blue);
  background:linear-gradient(100deg,#e7edf3 20%,#f7fbff 45%,#e7edf3 70%);
  background-size:200% 100%;
  animation:shimmer 1.1s linear infinite;
}

/* ===================== 轉圈圈（12 根） ===================== */
@keyframes bars-fade { 0%{opacity:1} 100%{opacity:0} }
.spinner-bars{position:relative;display:inline-block;width:56px;height:56px}
.spinner-bars i{
  position:absolute;left:0;top:0;transform-origin:28px 28px;
  animation:bars-fade var(--spin-fade) linear infinite;
}
.spinner-bars i::after{
  content:""; position:absolute; top:3px; left:26px;
  width:4px; height:14px; border-radius:2px; background:var(--spin-color);
}
.spinner-sm{width:22px;height:22px}
.spinner-sm i{transform-origin:11px 11px}
.spinner-sm i::after{top:1px;left:10px;width:2px;height:6px;border-radius:1px}

/* 12 根的角度與遞減延遲（大／小通用） */
.spinner-bars i:nth-child(1)  { transform:rotate(0deg);   animation-delay: calc(var(--spin-fade) * -11/12); }
.spinner-bars i:nth-child(2)  { transform:rotate(30deg);  animation-delay: calc(var(--spin-fade) * -10/12); }
.spinner-bars i:nth-child(3)  { transform:rotate(60deg);  animation-delay: calc(var(--spin-fade) * -9/12);  }
.spinner-bars i:nth-child(4)  { transform:rotate(90deg);  animation-delay: calc(var(--spin-fade) * -8/12);  }
.spinner-bars i:nth-child(5)  { transform:rotate(120deg); animation-delay: calc(var(--spin-fade) * -7/12);  }
.spinner-bars i:nth-child(6)  { transform:rotate(150deg); animation-delay: calc(var(--spin-fade) * -6/12);  }
.spinner-bars i:nth-child(7)  { transform:rotate(180deg); animation-delay: calc(var(--spin-fade) * -5/12);  }
.spinner-bars i:nth-child(8)  { transform:rotate(210deg); animation-delay: calc(var(--spin-fade) * -4/12);  }
.spinner-bars i:nth-child(9)  { transform:rotate(240deg); animation-delay: calc(var(--spin-fade) * -3/12);  }
.spinner-bars i:nth-child(10) { transform:rotate(270deg); animation-delay: calc(var(--spin-fade) * -2/12);  }
.spinner-bars i:nth-child(11) { transform:rotate(300deg); animation-delay: calc(var(--spin-fade) * -1/12);  }
.spinner-bars i:nth-child(12) { transform:rotate(330deg); animation-delay: 0s; }

/* ===================== 全頁遮罩 ===================== */
#mask{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center; flex-direction:column; gap:12px;
  z-index:9999; background:rgba(255,255,255,.94); backdrop-filter:blur(2px);
  color:#475569; font-size:16px; font-weight:700;
}

/* Mobile */
@media (max-width:600px){
  .wrap{padding:8px}
  .page-head{margin:4px 4px 12px}
  .page-head .logo{width:56px;height:56px;font-size:30px}
  .grid{gap:4px;padding:8px}
  .day{min-height:auto;padding:6px}
  .day .d{font-size:.95rem}
  .day .meta{display:block}
  .pill{display:block;width:100%;text-align:center;padding:.12rem .4rem;font-size:.78rem;line-height:1.15;min-width:auto;margin-bottom:4px}
  .pill .remain{display:none}
  .tile{padding:10px}
  .date-wrap,.form-input,input[type="date"].form-input{height:46px}
}
</style>
</head>
<body>
<!-- 全頁遮罩 -->
<div id="mask" style="display:none">
  <div class="spin-here"></div>
  <div class="loading-text">處理中，請稍候</div>
</div>

<div class="wrap">
  <div class="page-head"><div class="logo">＋</div><h1>陳萬龍診所門診線上預約</h1></div>

  <div class="cardish">
    <div class="cal-head">
      <div class="cal-title">
        <span class="title-text" id="calTitle">—</span>
        <span id="calLoader" class="loader" style="display:none"></span>
      </div>
      <div class="nav">
        <button id="btnPrev" class="nav-btn" aria-label="上一月" title="上一月">&lt;</button>
        <button id="btnNext" class="nav-btn" aria-label="下一月" title="下一月">&gt;</button>
      </div>
    </div>

    <div class="rule-bar">
      <span id="nowTime" class="nowtime"></span>
      <button class="rule-btn" id="openRules">開放預約日期規則</button>
    </div>

    <!-- 週標題 -->
    <div class="grid" id="whead"></div>

    <!-- 亮面掃過骨架 -->
    <div id="calSkeleton" class="skel-grid" aria-hidden="true"></div>

    <!-- 真實日期格與面板 -->
    <div class="grid" id="days" style="display:none"></div>
    <div class="section" id="dayPanel"></div>
    <div class="section picked" id="picked" style="display:none"></div>
  </div>

  <!-- 表單 -->
  <div class="cardish section mt-3">
    <input type="hidden" id="date"/><input type="hidden" id="slot"/>
    <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response"/>

    <div class="form-grid">
      <div>
        <div class="form-label-strong">姓名 *</div>
        <input id="name" type="text" class="form-input" autocomplete="off"/>
      </div>

      <div>
        <div class="form-label-strong">出生年月日 *（格式：yyyy/mm/dd，可輸入民國年）</div>
        <input id="birthday" type="text" class="form-input" inputmode="numeric" placeholder="1990/01/15" autocomplete="off" maxlength="10"/>
      </div>

      <div>
        <div class="form-label-strong">身分證字號 *</div>
        <input id="idnum" type="text" maxlength="10" class="form-input" placeholder="A123456789" autocomplete="off"/>
      </div>

      <div>
        <div class="form-label-strong">聯絡電話 *</div>
        <input id="phone" type="text" maxlength="10" inputmode="numeric" pattern="\d{10}" class="form-input" placeholder="0958xxxxxx" autocomplete="off"/>
      </div>
    </div>

    <div class="mt-2">
      <label class="agree"><input id="agree" type="checkbox"/><span>我已閱讀並同意 <a href="#" id="showNotice">預約須知 *</a></span></label>
    </div>
    <div class="d-grid gap-2 mt-3">
      <button id="submitBtn" class="btn-main">送出預約</button>
      <a class="btn-ghost text-center text-decoration-none" href="query.html">查詢/取消預約</a>
    </div>
  </div>
</div>

<!-- 規則 Modal -->
<div class="modal fade" id="rulesModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:#eef3fb;border-bottom:1px solid #dae5f6">
        <h5 class="modal-title" style="font-weight:700;color:var(--primary)">開放預約日期規則</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <div class="p-2" style="background:#f6f9ff;border:1px solid #e3ecff">
          <div class="rule-line"><span class="chip chip-strong">週一</span><span>可預約 →</span><span class="chip chip-range">［ 週四 ~ 下下週一 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週二</span><span>可預約 →</span><span class="chip chip-range">［ 週五 ~ 下下週二 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週三</span><span>可預約 →</span><span class="chip chip-range">［ 週六 ~ 下下週三 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週四</span><span>可預約 →</span><span class="chip chip-range">［ 下週一 ~ 下下週四 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週五</span><span>可預約 →</span><span class="chip chip-range">［ 下週二 ~ 下下週五 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週六</span><span>可預約 →</span><span class="chip chip-range">［ 下週二 ~ 下下週六 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週日</span><span>可預約 →</span><span class="chip chip-range">［ 下週三 ~ 下下週日 ］</span></div>
        </div>
        <div class="mt-3 text-secondary" style="font-size:.95rem">如對門診時間有疑問，請對照「門診時刻表」與「最新消息」確認是否有門診異動。</div>
      </div>
    </div>
  </div>
</div>

<!-- 預約須知 Modal -->
<div class="modal fade" id="noticeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="border-bottom:1px solid #e5e9ef">
        <h5 class="modal-title">預約須知與個資告知</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body" style="text-align:left">
        <ol class="numlist">
          <li>本院蒐集之個人資料（姓名、電話、身分證字號）僅用於掛號與醫療聯繫,另作他用。</li>
          <li>請於預約的門診結束前一小時到場報到（早診10:30前；午診16:00前；晚診20:00前），逾時視同放棄，會釋出名額給現場掛號。</li>
          <li>如需取消，請於前一日線上辦理；當日請以電話通知 (03) 515-2971。</li>
          <li>本院保留因醫療需求調整看診順序之權利。</li>
          <li>勾選同意表示理解並接受上述內容。</li>
        </ol>
        <div class="d-grid mt-3">
          <button id="agreeConfirm" class="btn-main">同意</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ====== 基本設定 ====== */
const API="https://script.google.com/macros/s/AKfycbwexa8A6Qf8nTJFg9kPZA_k1K8uK0cD_cXg-UYFOcKESuets_H6wLKZJwGH5GTqjF19/exec";
const RECAPTCHA_SITE_KEY="6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu";
const AES_KEY="A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";

/* 一次性簽章暫存 */
const nonceStore = {}; // { 'YYYY-MM-DD': {nonce, sig, exp} }

/* ====== 小工具 ====== */
function onlyDigits(s){ return String(s||'').replace(/\D/g,''); }

/* 身分證正規化 */
function normalizeTaiwanId(raw){
  if(raw==null) return "";
  let s = String(raw).trim().normalize('NFKC');
  s = s.replace(/\s+/g,'');
  s = s.toUpperCase();
  return s;
}

/* 台灣身分證驗證 */
function validateTaiwanIdCore(id){
  if(!/^[A-Z][12]\d{8}$/.test(id)) return false;
  const codeMap = {A:10,B:11,C:12,D:13,E:14,F:15,G:16,H:17,I:34,J:18,K:19,L:20,M:21,N:22,O:35,P:23,Q:24,R:25,S:26,T:27,U:28,V:29,W:32,X:30,Y:31,Z:33};
  const n = codeMap[id[0]]; if(n===undefined) return false;
  const X = Math.floor(n/10), Y = n%10;
  const digits = id.slice(1).split('').map(ch=>parseInt(ch,10));
  const weights = [8,7,6,5,4,3,2,1,1];
  let sum = X*1 + Y*9;
  for(let i=0;i<digits.length;i++) sum += digits[i]*weights[i];
  return (sum % 10) === 0;
}
function validateTaiwanId(raw){ return validateTaiwanIdCore(normalizeTaiwanId(raw)); }

/* reCAPTCHA 載入（動態載入，避免重覆掛 script） */
let recaptchaLoaded=false, recaptchaLoading=null;
function loadRecaptcha(){
  if(!RECAPTCHA_SITE_KEY) return Promise.resolve();
  if(recaptchaLoaded) return Promise.resolve();
  if(recaptchaLoading) return recaptchaLoading;
  recaptchaLoading=new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src="https://www.google.com/recaptcha/api.js?render="+encodeURIComponent(RECAPTCHA_SITE_KEY);
    s.async=true; s.defer=true;
    s.onload=()=>{recaptchaLoaded=true;resolve();};
    s.onerror=()=>reject(new Error("recaptcha_load_fail"));
    document.head.appendChild(s);
  });
  return recaptchaLoading;
}
async function getRecaptchaToken(){
  try{
    if(!RECAPTCHA_SITE_KEY) return "";
    await loadRecaptcha();
    return await new Promise(res=>{
      grecaptcha.ready(()=>grecaptcha.execute(RECAPTCHA_SITE_KEY,{action:"submit"}).then(t=>res(t)).catch(()=>res("")));
    });
  }catch(_){return"";}
}
function aesEnc(payload,ttlMs=10*60*1000){
  const obj={...payload}; if(ttlMs&&Number.isFinite(ttlMs)) obj.exp=Date.now()+ttlMs;
  const cipher=CryptoJS.AES.encrypt(JSON.stringify(obj),AES_KEY).toString();
  return encodeURIComponent
