<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é™³è¬é¾è¨ºæ‰€é–€è¨ºç·šä¸Šé ç´„</title>
<link rel="icon" type="image/png" href="favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<!-- ä¾ç…§é™„æª”ï¼šaxios / crypto-js -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<style>
:root{--primary:#6236a7;--bg:#f7f6fb;--card:#fff;--line:#ebe6fb;--muted:#6b5f92}
*{box-sizing:border-box}
html,body{width:100%;max-width:100%}
body{margin:0;background:var(--bg);color:#1f1330;font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif}
.wrap{max-width:960px;margin:16px auto;padding:12px}

/* ===== Page headerï¼ˆç½®ä¸­ï¼‰ ===== */
.page-head{display:flex;align-items:center;justify-content:center;gap:14px;margin:6px 8px 14px}
.page-head .logo{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;background:var(--primary);color:#fff;font-weight:900;font-size:34px;box-shadow:0 8px 18px rgba(98,54,167,.18)}
.page-head h1{margin:0;font-weight:900;font-size:clamp(1.5rem,2.6vw,2.2rem);color:#2a183d}

/* ===== Card ===== */
.cardish{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 24px rgba(98,54,167,.1)}
.section{padding:14px}

/* ===== Calendar head ===== */
.cal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid transparent}
.cal-title{font-weight:900;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.cal-title .title-text{font-size:clamp(1.2rem,2.4vw,1.6rem);font-weight:900}
.loader{color:#6b5f92;font-size:.95rem;white-space:nowrap;min-width:6.5em}
.nav{display:flex;gap:8px}
.nav button{border:none;background:var(--primary);color:#fff;border-radius:12px;padding:.35rem .7rem;font-weight:900;cursor:pointer}
.nav button[disabled]{opacity:.45;cursor:not-allowed}

/* è¦å‰‡æŒ‰éˆ•ï¼ˆç„¡ä¸Šä¸‹ç·šã€è¼ƒå°ï¼‰ */
.rule-bar{padding:6px 12px 0 12px}
.rule-btn{border:none;background:#efe9ff;color:#4a2f82;font-weight:800;border-radius:999px;padding:.32rem .75rem;font-size:.9rem}

/* ===== Calendar grid ===== */
.grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;padding:10px}
.wday{font-size:.9rem;color:var(--muted);text-align:center;font-weight:800}
.day{border:1px solid #e6e8f0;border-radius:14px;min-height:74px;padding:8px;display:flex;flex-direction:column;gap:6px;background:#fff;transition:.12s;overflow:hidden}
.day .d{font-weight:900;color:#24163a}
.day .meta{margin-top:auto;display:flex;flex-wrap:wrap;gap:6px}
.day.clickable{cursor:pointer}
.day.clickable:hover{box-shadow:0 0 0 2px #d7caf6}
.day.disabled{background:#f1f2f6;color:#8b90a3;border-color:#e5e7eb;opacity:.85;pointer-events:none}

/* pills */
.pill{display:inline-flex;align-items:center;justify-content:center;gap:.3rem;border:1px solid #e3e6ee;border-radius:999px;padding:.18rem .6rem;font-weight:900;font-size:clamp(.76rem,.9vw,.92rem);line-height:1.1;white-space:nowrap;min-width:4.2em}
.pill .remain{white-space:nowrap}
.pill.early{background:#e7f7ee;color:#065f46;border-color:#b8ead4}
.pill.noon {background:#fff3df;color:#7a4d00;border-color:#ffd79a}
.pill.night{background:#e8f2ff;color:#1d4ed8;border-color:#cfe2ff}
.pill.appt {background:#fde7ef;color:#b51695;border-color:#ff99e6}

/* ===== Day panel ===== */
#dayPanel{display:none}
#dayPanel .head{font-weight:900;margin:6px 0 10px}
.slot-grid{display:grid;grid-template-columns:1fr;gap:10px}
.tile{display:flex;align-items:center;gap:10px;border:1px solid #e0e4ef;border-radius:14px;padding:12px;background:#fff;cursor:pointer;transition:.12s}
.tile:hover{box-shadow:0 0 0 2px #e6dbff}
.tile .remain{margin-left:auto;font-weight:900;white-space:nowrap}
.tile .doc{color:#6b5f92;font-weight:800}
.tile.selected{background:#f3edff;box-shadow:0 0 0 2px #cdbbff}

.picked{display:none;margin-top:8px;color:#3b2c5f}
.picked b{color:#000}
.picked .hl{color:#6236a7;font-weight:900}

/* ===== Form ===== */
/* ğŸ‘‰ é€™è£¡æ”¹æˆå–®æ¬„ï¼šæ¯å€‹æ¬„ä½ä¸€è¡Œ */
.form-grid{display:grid;gap:12px;grid-template-columns:1fr}
.form-label-strong{font-weight:700;margin-bottom:6px}
.form-input{width:100%;padding:.6rem .7rem;border:1px solid #ced2db;border-radius:12px;font-size:1rem;line-height:1.25;height:auto}
.btn-main{background:var(--primary);color:#fff;border:none;border-radius:14px;padding:.7rem 1.1rem;font-weight:900}
.btn-ghost{background:#fff;border:1px solid #d7dbe5;border-radius:14px;padding:.7rem 1.1rem;font-weight:900;color:#3a3f47}
.agree{display:flex;align-items:center;gap:.5rem;flex-wrap:nowrap}
.agree a{color:#6236a7;text-decoration:underline}

/* ===== å…¨é é®ç½©ï¼ˆèˆ‡é™„æª”ä¸€è‡´é«”é©—ï¼‰ ===== */
#mask{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
       z-index:9999; font-size:18px; color:#4b2c86;
       background:rgba(255,255,255,.92); backdrop-filter:blur(2px); }
#dots{ display:inline-block; width:2ch; text-align:left; }

/* ===== Modal è¦å‰‡ï¼šæ¯åˆ—ä¸€è¡Œï¼ˆå«æ‰‹æ©Ÿï¼‰ ===== */
.rule-line{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;white-space:nowrap;font-weight:800;
  font-size:clamp(12px,3.2vw,16px);min-width:0;letter-spacing:.5px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:.25rem .6rem;border-radius:999px;border:1px solid #e6e8f0;background:#fff}
.chip-strong{background:#f3f0ff;color:#4a2f82;border-color:#e4ddff}
.chip-range{background:#f8fafc;color:#334155}

/* ===== Mobile è£œå¼· ===== */
@media (max-width:600px){
  .wrap{padding:8px}
  .page-head{margin:4px 4px 12px}
  .page-head .logo{width:56px;height:56px;font-size:30px}
  .grid{gap:4px;padding:8px}
  .day{min-height:auto;border-radius:12px;padding:6px}
  .day .d{font-size:.95rem}
  /* pillï¼šä¸€è¡Œä¸€é¡†ï¼›æ‰‹æ©Ÿä¸é¡¯ç¤ºå‰©é¤˜æ•¸å­— */
  .day .meta{display:block}
  .pill{display:block;width:100%;text-align:center;padding:.12rem .4rem;font-size:.78rem;line-height:1.15;min-width:auto;margin-bottom:4px}
  .pill .remain{display:none}
  .tile{padding:10px;border-radius:12px}

  /* å‡ºç”Ÿå¹´æœˆæ—¥ç¸®å°ï¼›ç¶­æŒ date + æ•¸å­—éµç›¤ */
  #birthday.form-input[type="date"]{
    font-size:13px;padding:.40rem .50rem;line-height:1.05;height:auto;max-width:100%;border-radius:10px
  }
  #birthday::-webkit-datetime-edit{padding:.16rem .26rem}
  #birthday::-webkit-datetime-edit-fields-wrapper{padding:0}
  #birthday::-webkit-calendar-picker-indicator{transform:scale(.9)}
  .chip{padding:.18rem .46rem;font-size:.9em}
}
</style>
</head>
<body>
<!-- å…¨é é®ç½©ï¼ˆé€å‡ºä¸­ï¼‰ -->
<div id="mask">é ç´„ä¸­è«‹ç¨ç­‰ï¼Œè«‹å‹¿é—œé–‰æˆ–é‡æ–°æ•´ç†é é¢<span id="dots">...</span></div>

<div class="wrap">
  <!-- é é¦–ï¼ˆç½®ä¸­ï¼‰ -->
  <div class="page-head"><div class="logo">ï¼‹</div><h1>é™³è¬é¾è¨ºæ‰€é–€è¨ºç·šä¸Šé ç´„</h1></div>

  <div class="cardish">
    <div class="cal-head">
      <div class="cal-title">
        <span class="title-text" id="calTitle">â€”</span>
        <span id="calLoader" class="loader" style="display:none">è¼‰å…¥ä¸­â€¦</span>
      </div>
      <div class="nav">
        <button id="btnPrev" aria-label="ä¸Šä¸€æœˆ">â†</button>
        <button id="btnNext" aria-label="ä¸‹ä¸€æœˆ">â†’</button>
      </div>
    </div>

    <!-- è¦å‰‡æŒ‰éˆ• -->
    <div class="rule-bar">
      <button class="rule-btn" id="openRules">é–‹æ”¾é ç´„æ—¥æœŸè¦å‰‡</button>
    </div>

    <div class="grid" id="whead"></div>
    <div class="grid" id="days"></div>
    <div class="section" id="dayPanel"></div>
    <div class="section picked" id="picked"></div>
  </div>

  <!-- è¡¨å–®ï¼ˆæ¯æ¬„ä¸€è¡Œï¼‰ -->
  <div class="cardish section mt-3">
    <input type="hidden" id="date"/><input type="hidden" id="slot"/>
    <!-- Invisible reCAPTCHAï¼štoken æ”¾é€™è£¡ -->
    <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response"/>

    <div class="form-grid">
      <div>
        <div class="form-label-strong">å§“å *</div>
        <input id="name" type="text" class="form-input" autocomplete="off"/>
      </div>

      <div>
        <div class="form-label-strong">å‡ºç”Ÿå¹´æœˆæ—¥ *</div>
        <!-- ç¶­æŒ dateï¼Œä½†åŠ  inputmode=numericï¼ˆæ”¯æ´è£ç½®æœƒå«å‡ºæ•¸å­—éµç›¤ï¼‰ -->
        <input id="birthday" type="date" class="form-input" inputmode="numeric" autocomplete="off"/>
      </div>

      <div>
        <div class="form-label-strong">èº«åˆ†è­‰å­—è™Ÿ *</div>
        <input id="idnum" type="text" maxlength="10" class="form-input" placeholder="A123456789" autocomplete="off"/>
      </div>

      <div>
        <div class="form-label-strong">é€£çµ¡é›»è©± *</div>
        <input id="phone" type="text" maxlength="10" inputmode="numeric" class="form-input" placeholder="0958xxxxxx" autocomplete="off"/>
      </div>
    </div>

    <div class="mt-2">
      <label class="agree"><input id="agree" type="checkbox"/><span>æˆ‘å·²é–±è®€ä¸¦åŒæ„ <a href="#" id="showNotice">é ç´„é ˆçŸ¥</a></span></label>
    </div>
    <div class="d-grid gap-2 mt-3">
      <button id="submitBtn" class="btn-main">é€å‡ºé ç´„</button>
      <a class="btn-ghost text-center text-decoration-none" href="query.html">æŸ¥è©¢ï¼å–æ¶ˆé ç´„</a>
    </div>
    <!-- ä¾ä½ çš„è¦æ±‚ï¼šåˆªé™¤åº•éƒ¨ reCAPTCHA èªªæ˜æ–‡æ¡ˆ -->
  </div>
</div>

<!-- è¦å‰‡ Modal -->
<div class="modal fade" id="rulesModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="border-radius:18px">
      <div class="modal-header" style="background:#f3edff;border-bottom:1px solid #e9e0ff;border-top-left-radius:18px;border-top-right-radius:18px">
        <h5 class="modal-title" style="font-weight:900;color:#4a2f82">é–‹æ”¾é ç´„æ—¥æœŸè¦å‰‡</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="background:#f6f3ff">
        <div class="p-2 rounded-3" style="background:#efeaff;border:1px solid #e5dcff">
          <div class="rule-line"><span class="chip chip-strong">é€±ä¸€</span><span>å¯é ç´„ â†’</span><span class="chip chip-range">ï¼» é€±å›› ~ ä¸‹ä¸‹é€±ä¸€ ï¼½</span></div>
          <div class="rule-line"><span class="chip chip-strong">é€±äºŒ</span><span>å¯é ç´„ â†’</span><span class="chip chip-range">ï¼» é€±äº” ~ ä¸‹ä¸‹é€±äºŒ ï¼½</span></div>
          <div class="rule-line"><span class="chip chip-strong">é€±ä¸‰</span><span>å¯é ç´„ â†’</span><span class="chip chip-range">ï¼» é€±å…­ ~ ä¸‹ä¸‹é€±ä¸‰ ï¼½</span></div>
          <div class="rule-line"><span class="chip chip-strong">é€±å››</span><span>å¯é ç´„ â†’</span><span class="chip chip-range">ï¼» ä¸‹é€±ä¸€ ~ ä¸‹ä¸‹é€±å›› ï¼½</span></div>
          <div class="rule-line"><span class="chip chip-strong">é€±äº”</span><span>å¯é ç´„ â†’</span><span class="chip chip-range">ï¼» ä¸‹é€±äºŒ ~ ä¸‹ä¸‹é€±äº” ï¼½</span></div>
          <div class="rule-line"><span class="chip chip-strong">é€±å…­</span><span>å¯é ç´„ â†’</span><span class="chip chip-range">ï¼» ä¸‹é€±äºŒ ~ ä¸‹ä¸‹é€±å…­ ï¼½</span></div>
          <div class="rule-line"><span class="chip chip-strong">é€±æ—¥</span><span>å¯é ç´„ â†’</span><span class="chip chip-range">ï¼» ä¸‹é€±ä¸‰ ~ ä¸‹ä¸‹é€±æ—¥ ï¼½</span></div>
        </div>
        <div class="mt-3 text-secondary" style="font-size:.95rem">å¦‚å°é–€è¨ºæ™‚é–“æœ‰ç–‘å•ï¼Œè«‹å°ç…§ã€Œé–€è¨ºæ™‚åˆ»è¡¨ã€èˆ‡ã€Œæœ€æ–°æ¶ˆæ¯ã€ç¢ºèªæ˜¯å¦æœ‰é–€è¨ºç•°å‹•ã€‚</div>
      </div>
    </div>
  </div>
</div>

<!-- é ç´„é ˆçŸ¥ Modal -->
<div class="modal fade" id="noticeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">é ç´„é ˆçŸ¥èˆ‡å€‹è³‡å‘ŠçŸ¥</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" style="text-align:left">
        <p>1. å€‹è³‡ç”¨é€”ï¼šåƒ…ä¾›é ç´„èˆ‡è¯ç¹«ï¼Œä¸å¦ä½œä»–ç”¨ã€‚</p>
        <p>2. å ±åˆ°æ™‚é–“ï¼šè«‹æ–¼å„æ™‚æ®µçµæŸå‰ 1 å°æ™‚å®Œæˆå ±åˆ°ï¼ˆæ—© 10:30ï¼åˆ 16:00ï¼æ™š 20:00ï¼‰ï¼Œé€¾æ™‚é‡‹å‡ºåé¡ã€‚</p>
        <p>3. å–æ¶ˆæ–¹å¼ï¼šå‰ä¸€æ—¥ç·šä¸Šè¾¦ç†ï¼›ç•¶æ—¥è«‹é›»æ´½ (03) 515-2971ã€‚</p>
        <p>4. ä¾é†«ç™‚éœ€æ±‚ï¼Œç¾å ´çœ‹è¨ºé †åºå¯èƒ½èª¿æ•´ã€‚</p>
        <p>5. å‹¾é¸åŒæ„è¡¨ç¤ºç†è§£ä¸¦æ¥å—ä¸Šè¿°å…§å®¹ã€‚</p>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Invisible reCAPTCHAï¼ˆèˆ‡é™„æª”ä¸€è‡´åšæ³•ï¼‰ -->
<script src="https://www.google.com/recaptcha/api.js?render=6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu"></script>

<script>
/* ===== å¸¸æ•¸ï¼ˆèˆ‡é™„æª”ä¸€è‡´ï¼‰ ===== */
const API = "https://script.google.com/macros/s/AKfycbz1jtOWBJEETvotCU2y022ow4lOlm_TauYpRMG6riUIj88_Vde5d9LHGH5cLC4HYe7X/exec";
const RECAPTCHA_SITE_KEY = "6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu"; // å¯æ›æˆæ­£å¼ key
const AES_KEY = "A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";

/* ===== reCAPTCHA ===== */
let recaptchaLoaded=false, recaptchaLoading=null;
function loadRecaptcha(){
  if(!RECAPTCHA_SITE_KEY) return Promise.resolve();
  if(recaptchaLoaded) return Promise.resolve();
  if(recaptchaLoading) return recaptchaLoading;
  recaptchaLoading = new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src="https://www.google.com/recaptcha/api.js?render="+encodeURIComponent(RECAPTCHA_SITE_KEY);
    s.async=true; s.defer=true;
    s.onload=()=>{recaptchaLoaded=true;resolve();};
    s.onerror=()=>reject(new Error("recaptcha_load_fail"));
    document.head.appendChild(s);
  });
  return recaptchaLoading;
}
async function getRecaptchaToken(){
  try{
    if(!RECAPTCHA_SITE_KEY) return "";
    await loadRecaptcha();
    return await new Promise(res=>{
      grecaptcha.ready(()=> grecaptcha.execute(RECAPTCHA_SITE_KEY,{action:"submit"}).then(t=>res(t)).catch(()=>res("")));
    });
  }catch(_){ return ""; }
}

/* ===== AES åŠ å¯† ===== */
function aesEnc(payload, ttlMs = 10 * 60 * 1000){
  const obj = { ...payload };
  if (ttlMs && Number.isFinite(ttlMs)) obj.exp = Date.now() + ttlMs;
  const cipher = CryptoJS.AES.encrypt(JSON.stringify(obj), AES_KEY).toString();
  return encodeURIComponent(cipher);
}

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const $title  = $('calTitle');
const $loader = $('calLoader');
const $whead  = $('whead');
const $days   = $('days');
const $prev   = $('btnPrev');
const $next   = $('btnNext');
const $panel  = $('dayPanel');
const $picked = $('picked');
const $date   = $('date');
const $slot   = $('slot');
const $name   = $('name');
const $birthday = $('birthday');
const $idnum  = $('idnum');
const $phone  = $('phone');
const $agree  = $('agree');
const $submit = $('submitBtn');

/* ===== é®ç½© ===== */
const $mask = $('mask'); const $dots = $('dots');
let dotTimer=null;
function showMask(txt){
  $mask.firstChild.nodeValue = (txt||'é ç´„ä¸­è«‹ç¨ç­‰ï¼Œè«‹å‹¿é—œé–‰æˆ–é‡æ–°æ•´ç†é é¢');
  $mask.style.display='flex';
  if(dotTimer) clearInterval(dotTimer);
  dotTimer = setInterval(()=>{
    $dots.textContent = ($dots.textContent==='...') ? '.' : $dots.textContent+'.';
    if($dots.textContent.length>3) $dots.textContent='.';
  }, 340);
}
function hideMask(){ if(dotTimer) clearInterval(dotTimer); $mask.style.display='none'; }

/* ===== Utils & æœˆæ›† ===== */
const pad2=n=>String(n).padStart(2,'0');
const ymd=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const firstOfMonth=d=>new Date(d.getFullYear(), d.getMonth(), 1);
const endOfMonth=d=>new Date(d.getFullYear(), d.getMonth()+1, 0);
const addMonths=(d,n)=>new Date(d.getFullYear(), d.getMonth()+n, 1);
const W=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
const fmtTitle=d=>`${d.getFullYear()}å¹´${d.getMonth()+1}æœˆä»½`;
const NOW=new Date(); let WINDOW_MIN=null, WINDOW_MAX=null; let curMonth=firstOfMonth(NOW);

/* é–‹å•Ÿè¦å‰‡ / é ˆçŸ¥ */
$('openRules').addEventListener('click',()=>new bootstrap.Modal(document.getElementById('rulesModal')).show());
$('showNotice').addEventListener('click',e=>{e.preventDefault(); new bootstrap.Modal(document.getElementById('noticeModal')).show();});

/* è¼‰å…¥ä¸­é»é» */
let dotsTimer=null;
function showLoadingDots(on){
  if(on){ $loader.style.display='inline'; let n=0; $loader.textContent='è¼‰å…¥ä¸­.'; dotsTimer=setInterval(()=>{n=(n+1)%6;$loader.textContent='è¼‰å…¥ä¸­'+'.'.repeat(n+1)},350); }
  else{ if(dotsTimer){clearInterval(dotsTimer);dotsTimer=null;} $loader.style.display='none'; }
}

/* é€±æ¨™é¡Œ */
$whead.innerHTML=W.map(w=>`<div class="wday">${w}</div>`).join('');

/* è¦–çª— */
async function getWindow(){
  try{
    const r=await axios.get(API,{ params:{ action:'getWindow', t: Date.now() }});
    const data=r.data||{};
    const min=data?.startDate?new Date(data.startDate):new Date(NOW.getFullYear(),NOW.getMonth(),NOW.getDate()+Number(data?.start??2));
    const max=data?.endDate?new Date(data.endDate):new Date(NOW.getFullYear(),NOW.getMonth(),NOW.getDate()+Number(data?.end??14));
    WINDOW_MIN=new Date(min.getFullYear(),min.getMonth(),min.getDate());
    WINDOW_MAX=new Date(max.getFullYear(),max.getMonth(),max.getDate());
  }catch{
    WINDOW_MIN=new Date(NOW.getFullYear(),NOW.getMonth(),NOW.getDate()+2);
    WINDOW_MAX=new Date(NOW.getFullYear(),NOW.getMonth(),NOW.getDate()+14);
  }
}

/* éª¨æ¶ */
function renderSkeleton(monthDate){
  const first=firstOfMonth(monthDate), last=endOfMonth(monthDate);
  $title.textContent=fmtTitle(first);
  showLoadingDots(true);
  const minMonth=firstOfMonth(WINDOW_MIN), maxMonth=firstOfMonth(WINDOW_MAX);
  $prev.disabled=first.getTime()<=minMonth.getTime();
  $next.disabled=first.getTime()>=maxMonth.getTime();

  let html=''; const pad=first.getDay();
  for(let i=0;i<pad;i++) html+=`<div></div>`;
  for(let d=1; d<=last.getDate(); d++){
    const cur=new Date(first.getFullYear(),first.getMonth(),d);
    const inWindow=cur>=WINDOW_MIN && cur<=WINDOW_MAX;
    const cls=inWindow?'day':'day disabled';
    html+=`<div class="${cls}" data-ymd="${ymd(cur)}"><div class="d">${d}</div><div class="meta">â€”</div></div>`;
  }
  $days.innerHTML=html; $panel.style.display='none'; $picked.style.display='none';
}

/* é€æ—¥æŠ“ slot */
let nonceMetaByDate={};
async function fetchMonthDays(monthDate){
  const first=firstOfMonth(monthDate), last=endOfMonth(monthDate);
  const jobs=[];
  for(let d=1; d<=last.getDate(); d++){
    const cur=new Date(first.getFullYear(),first.getMonth(),d);
    const key=ymd(cur);
    if(cur<WINDOW_MIN || cur>WINDOW_MAX){ jobs.push(Promise.resolve({date:key,slots:[]})); continue; }
    jobs.push((async()=>{
      try{
        const r=await axios.get(API,{ params:{ action:'getSlots', date:key, t: Date.now() }});
        const data=r.data;
        const raw=Array.isArray(data)?data:(Array.isArray(data?.slots)?data.slots:[]);
        if (!Array.isArray(data) && data && data.nonce && data.sig && data.exp){
          nonceMetaByDate[key] = { nonce:String(data.nonce), sig:String(data.sig), exp:Number(data.exp) };
        }
        const slots=(raw||[]).map(x=>{
          const limit=Number(x.limit)||0, used=Number(x.used)||0, remain=Math.max(0,limit-used);
          const label=String(x.label||'');
          const slot=label.includes('æ—©')?'early':label.includes('åˆ')?'noon':label.includes('æ™š')?'night':label.includes('ç´„')?'appt':'other';
          const time=x.time||x.timeRange||'';
          const doctor=String(x.doctor||'').replace(/[ï¼»\[]|[ï¼½\]]/g,'');
          const status=limit<=0?'closed':(remain<=0?'full':'open');
          return {slot,cap:limit,used,remain,status,time,doctor,label};
        });
        return {date:key,slots};
      }catch{ return {date:key,slots:[]} }
    })());
  }
  const arr=await Promise.all(jobs); const map={}; arr.forEach(d=>map[d.date]=d); return map;
}

/* å¯«å…¥æœˆæ›† */
function hydrateMonth(monthDate, dayMap){
  const first=firstOfMonth(monthDate), last=endOfMonth(monthDate);
  let html=''; const pad=first.getDay();
  for(let i=0;i<pad;i++) html+=`<div></div>`;
  for(let d=1; d<=last.getDate(); d++){
    const cur=new Date(first.getFullYear(),first.getMonth(),d);
    const key=ymd(cur); const meta=dayMap[key];
    let cls='day', inner=`<div class="d">${d}</div>`;
    const inWindow=cur>=WINDOW_MIN && cur<=WINDOW_MAX;
    const hasOpen=!!(meta?.slots?.some(s=>s.status==='open'));
    if(!inWindow || !hasOpen){ cls+=' disabled'; inner+=`<div class="meta">â€”</div>`; }
    else{
      cls+=' clickable';
      const pills=meta.slots.filter(s=>s.status==='open').map(s=>{
        const tag=s.slot==='early'?'early':s.slot==='noon'?'noon':s.slot==='night'?'night':'appt';
        const label=s.slot==='early'?'æ—©è¨º':s.slot==='noon'?'åˆè¨º':s.slot==='night'?'æ™šè¨º':'ç´„è¨º';
        return `<span class="pill ${tag}"><span class="lbl">${label}</span> <span class="remain">å‰©é¤˜ ${Math.max(0,s.remain)} äºº</span></span>`;
      }).join('');
      inner+=`<div class="meta">${pills}</div>`;
    }
    html+=`<div class="${cls}" data-ymd="${key}">${inner}</div>`;
  }
  $days.innerHTML=html;
  $days.querySelectorAll('.day.clickable').forEach(el=>el.addEventListener('click',()=>openDay(el.dataset.ymd, dayMap[el.dataset.ymd])));
  showLoadingDots(false);
}

/* å±•é–‹ç•¶æ—¥ï¼ˆåªæœ‰ä¸€å€‹è¨ºåˆ¥ â†’ è‡ªå‹•é é¸ï¼‰ */
function openDay(dateYMD, meta){
  const mapSlot={early:'æ—©è¨º',noon:'åˆè¨º',night:'æ™šè¨º',appt:'ç´„è¨º'};
  const open=(meta.slots||[]).filter(s=>s.status==='open');
  if(!open.length){ $panel.style.display='none'; return; }
  let html=`<div class="head">${dateYMD}ï¼ˆæ˜ŸæœŸ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(dateYMD).getDay()]}ï¼‰</div><div class="slot-grid">`;
  html+=open.map(s=>{
    const label=mapSlot[s.slot]||s.label||''; const time=s.time||''; const doc=s.doctor?`ï¼»${s.doctor}ï¼½`:''; const rem=Math.max(0,s.remain);
    return `<div class="tile" data-date="${dateYMD}" data-slot="${s.slot}" data-label="${label}" data-time="${time}" data-doc="${s.doctor||''}" data-rem="${rem}" data-cap="${s.cap}">
      <div><strong>${label}</strong> ${time} ${doc}</div>
      <div class="remain">å‰©é¤˜ ${rem}/${s.cap} äºº</div>
    </div>`;
  }).join('');
  html+=`</div>`;
  $panel.innerHTML=html; $panel.style.display='block';

  const rows = $panel.querySelectorAll('.tile');
  rows.forEach(row=>row.addEventListener('click',()=>selectRow(row)));

  if (rows.length === 1){ selectRow(rows[0]); } // è‡ªå‹•é¸å–
}

/* é¸å–ä¸€åˆ— â†’ å¸¶å…¥éš±è—æ¬„ä½ èˆ‡ å·²é¸æç¤º */
function selectRow(row){
  $panel.querySelectorAll('.tile').forEach(x=>x.classList.remove('selected'));
  row.classList.add('selected');
  const mapVal={early:'æ—©è¨º',noon:'åˆè¨º',night:'æ™šè¨º',appt:'ç´„è¨º'};
  $('date').value = row.dataset.date;
  $('slot').value = mapVal[row.dataset.slot]||'';
  const chosen=`${row.dataset.date}ï½œ<span class="hl">${row.dataset.label} ${row.dataset.time} ${row.dataset.doc?`ï¼»${row.dataset.doc}ï¼½`:''}</span>  å‰©é¤˜ ${row.dataset.rem}/${row.dataset.cap} äºº`;
  $picked.innerHTML=`å·²é¸æ“‡ï¼š<b>${chosen}</b>`;
  $picked.style.display='block';
  $('submitBtn').scrollIntoView({behavior:'smooth',block:'center'});
}

/* åˆ‡æœˆ */
$('btnPrev').addEventListener('click',async()=>{curMonth=addMonths(curMonth,-1);await bootMonth(curMonth)});
$('btnNext').addEventListener('click',async()=>{curMonth=addMonths(curMonth, 1);await bootMonth(curMonth)});

/* ===== é€å‡ºï¼ˆèˆ‡é™„æª”æµç¨‹ä¸€è‡´ï¼‰ ===== */
let submitting=false;
$submit.addEventListener('click', async (e)=>{
  e.preventDefault();
  if(submitting) return;

  const d = ($('date').value||'').trim();
  const s = ($('slot').value||'').trim();
  const n = ($('name').value||'').trim();
  const b = ($('birthday').value||'').trim();
  const id= ($('idnum').value||'').trim().toUpperCase();
  const ph= ($('phone').value||'').trim();
  const ag= $('agree').checked;

  if(!d||!s||!n||!b||!id||!ph||!ag){ alert('è³‡æ–™æœªå¡«å®Œæ•´'); return; }
  if(!/^[A-Z][12]\d{8}$/.test(id)){ alert('èº«åˆ†è­‰æ ¼å¼éŒ¯èª¤'); return; }
  if(ph.length<8 || ph.length>10){ alert('é›»è©±é•·åº¦ä¸ç¬¦'); return; }
  const age = Math.floor((Date.now()-new Date(b))/31536000000);
  if(age<0 || age>150){ alert('ç”Ÿæ—¥è¶…å‡ºé™åˆ¶'); return; }

  try{
    submitting=true;
    $submit.disabled=true;
    showMask();

    const recaptchaToken = await getRecaptchaToken();
    $('g-recaptcha-response').value = recaptchaToken;

    const params = { action:'submit', date:d, slot:s, name:n, birthday:b, id:id, phone:ph, recaptchaToken, t: Date.now() };
    const r = await axios.get(API,{ params });

    if(!r.data?.ok){
      const code=r.data?.error||'';
      if(code==='duplicate')          alert('åŒä¸€å¤©åŒä¸€è¨ºåˆ¥ä¸å¯é‡è¤‡æ›è™Ÿï¼ˆèº«åˆ†è­‰åˆ¤å®šï¼‰');
      else if(code==='full')          alert('åé¡å·²æ»¿ï¼Œè«‹æ”¹é¸å…¶ä»–æ™‚æ®µæˆ–æ—¥æœŸ');
      else if(code==='out_of_window') alert(r.data?.message || 'è¶…å‡ºå¯é ç´„æœŸé–“');
      else if(code==='robot')         alert('é©—è­‰æœªé€šéï¼ˆreCAPTCHAï¼‰ï¼Œè«‹å†è©¦ä¸€æ¬¡');
      else                            alert(r.data?.message || 'é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      return;
    }

    const idFromApi = r?.data?.id || r?.data?.Id || r?.data?.bookingId || r?.data?.data?.id;
    const receipt   = r?.data?.receipt || r?.data?.rcpt || '';
    try{
      if (receipt && idFromApi) sessionStorage.setItem('rcpt:'+String(idFromApi), String(receipt));
      sessionStorage.setItem('lastBookingId', String(idFromApi));
    }catch(_){}

    const baseDir   = new URL('.', location.href);
    const successUrl= new URL('success.html', baseDir);
    const cipher    = aesEnc({ id: idFromApi, receipt });
    successUrl.searchParams.set('cipher', cipher);
    location.assign(successUrl.href);

  }catch(err){
    console.error(err);
    alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    submitting=false;
    $submit.disabled=false;
    hideMask();
  }
});

/* ===== å•Ÿå‹• ===== */
async function bootMonth(m){ renderSkeleton(m); const map=await fetchMonthDays(m); hydrateMonth(m,map); }
(async function init(){
  try{ await loadRecaptcha(); }catch(_){}
  await getWindow();
  await bootMonth(curMonth);
})();
</script>
</body>
</html>
