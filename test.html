<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>陳萬龍診所門診線上預約</title>
<link rel="icon" type="image/png" href="favicon.png">
<!-- 字重：400/500/600/700 -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<style>
/* ========== 視覺主題（骨科：藍灰＋暖米白） ========== */
:root{
  --primary:#2D4A83;           /* 深海軍藍（主色） */
  --bg:#F5EFE8;                /* 暖米白背景 */
  --card:#FFFFFF;
  --line:#E6E1D8;              /* 淡邊界線 */
  --ink:#1E293B;               /* 主要文字 */
  --muted:#5F7396;             /* 輔助文字（石板藍灰） */

  /* 診別色（低飽和） */
  --early:#2F7D54;             /* 成功/灰綠 */
  --noon:#9E7A3C;              /* 赭棕 */
  --night:#3D5E7A;             /* 石藍 */

  --stop:#C63D2D;              /* 警示紅（非純紅） */

  /* 狀態/選取 */
  --today:#DDE5F2;             /* 今日淡藍灰 */
  --sel-bg:#E7EEF8;
  --sel-bd:#C3D0EA;
  --slot-bd:#CBD5E1;           /* 小元件描邊 */
}

/* 基本排版 */
*{box-sizing:border-box}
html,body{width:100%;max-width:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
  font-weight:400;
}
.wrap{max-width:960px;margin:16px auto;padding:12px}

/* = Header = */
.page-head{
  display:flex;align-items:center;justify-content:center;gap:14px;
  margin:6px 8px 14px
}
.page-head .logo{
  width:60px;height:60px;border-radius:12px;
  display:grid;place-items:center;
  background:var(--primary);color:#fff;
  font-weight:700;font-size:30px;letter-spacing:.5px
}
.page-head h1{
  margin:0;font-weight:700;letter-spacing:.02em;
  font-size:clamp(1.4rem,2.4vw,2rem);color:var(--primary)
}

/* = Card = */
.cardish{
  background:var(--card);border:1px solid var(--line);border-radius:12px;
  box-shadow:none
}
.section{padding:14px}

/* = Calendar head = */
.cal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
.cal-title{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.cal-title .title-text{font-size:clamp(1.1rem,2.2vw,1.45rem);font-weight:700;color:var(--ink)}
.loader{color:var(--muted);font-size:.95rem;white-space:nowrap;min-width:6.5em}
.loader .spinner-border{vertical-align:-2px}

/* nav arrows */
.nav{display:flex;gap:10px}
.nav-btn{border:none;background:none;cursor:pointer;width:0;height:0;border-style:solid}
.nav-btn.prev{border-width:12px 16px 12px 0;border-color:transparent var(--primary) transparent transparent}
.nav-btn.next{border-width:12px 0 12px 16px;border-color:transparent transparent transparent var(--primary)}
.nav-btn[disabled]{opacity:.35;cursor:not-allowed}

/* 規則列＋現在時間 */
.rule-bar{display:flex;align-items:center;gap:10px;padding:6px 12px 0 12px;flex-wrap:wrap}
.rule-btn{
  border:1px solid var(--line);background:#FFF;color:var(--primary);
  font-weight:600;border-radius:999px;padding:.42rem .9rem;font-size:.92rem
}
.nowtime{color:var(--muted);font-weight:600;letter-spacing:.5px}

/* = Calendar grid = */
.grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;padding:10px}
.wday{font-size:.9rem;color:var(--muted);text-align:center;font-weight:600}
.day{
  border:1px solid #E2E8F0;border-radius:10px;min-height:74px;padding:8px;
  display:flex;flex-direction:column;gap:6px;background:#fff;transition:.12s;overflow:hidden
}
.day .d{font-weight:700;color:#1F2937}
.day .meta{margin-top:auto;display:flex;flex-wrap:wrap;gap:6px}
.day.clickable{cursor:pointer}
.day.clickable:hover{box-shadow:0 0 0 2px rgba(45,74,131,.12)}
.day.disabled{background:#F1F2F6;color:#8b90a3;border-color:#E5E7EB;opacity:.9;pointer-events:none}

/* 選取 */
.day.selected{border:2px solid var(--sel-bd); box-shadow:0 0 0 1px var(--sel-bd);}

/* 今天 */
.day.today{background:var(--today);border-color:#C9D5E8}
.day.today .d{color:#0F172A}

/* pills（由膠囊改低飽和、描邊為主） */
.pill{
  display:inline-flex;align-items:center;justify-content:center;gap:.3rem;
  border:1px solid var(--slot-bd);border-radius:8px;
  padding:.2rem .55rem;font-weight:700;font-size:clamp(.76rem,.9vw,.92rem);
  line-height:1.1;white-space:nowrap;min-width:4.2em;background:#fff;color:var(--ink)
}
.pill .remain{white-space:nowrap}
.pill.early{background:#E9F2EC;color:#225B3F;border-color:#C6E2D0}
.pill.noon {background:#F3EFE6;color:#6F5525;border-color:#E4D6BE}
.pill.night{background:#E6ECF3;color:#27465B;border-color:#C7D3DE}
/* 停診 */
.pill.stop{background:#F7E9E7;color:var(--stop);border-color:#EBC2BC}

/* 額滿樣式 */
.pill.full{background:#EEF1F5;color:#6b7280;border-color:#E5E7EB;opacity:.95}
.tile.full{background:#F3F4F6;border-color:#E5E7EB;color:#6b7280;cursor:default}
.tile.full:hover{box-shadow:none}
.tile.full .status-full{color:var(--stop);font-weight:700}

/* = Day panel = */
#dayPanel{display:none}
#dayPanel .head{font-weight:700;margin:6px 0 10px}
.slot-grid{display:grid;grid-template-columns:1fr;gap:10px}
.tile{
  display:flex;align-items:center;gap:10px;border:1px solid #E0E4EF;border-radius:12px;
  padding:12px;background:#fff;cursor:pointer;transition:.12s
}
.tile:hover{box-shadow:0 0 0 2px #C9D5E8}
.tile .remain{margin-left:auto;font-weight:500;white-space:nowrap}
.tile .doc{color:var(--muted);font-weight:600}
.tile .main{font-weight:700}

/* 依診別選取樣式（淡底＋描邊） */
.tile.selected{background:#fff;box-shadow:none}
.tile.selected.early{background:#E9F2EC;box-shadow:0 0 0 2px #C6E2D0}
.tile.selected.early strong,.tile.selected.early .remain,.tile.selected.early .doc{color:#225B3F}
.tile.selected.noon{background:#F3EFE6;box-shadow:0 0 0 2px #E4D6BE}
.tile.selected.noon strong,.tile.selected.noon .remain,.tile.selected.noon .doc{color:#6F5525}
.tile.selected.night{background:#E6ECF3;box-shadow:0 0 0 2px #C7D3DE}
.tile.selected.night strong,.tile.selected.night .remain,.tile.selected.night .doc{color:#27465B}

/* 已選擇行（仍保留節點） */
.picked{display:none;margin-top:8px;color:#1F2937}
.picked b{color:#000}
.picked .hl{font-weight:700}
.picked .hl.early{color:#225B3F}
.picked .hl.noon {color:#6F5525}
.picked .hl.night{color:#27465B}

/* = Form = */
.form-grid{display:grid;gap:14px;grid-template-columns:1fr}
.form-grid > div{min-width:0}
.form-label-strong{font-weight:700;margin-bottom:6px;color:#1F2937}
.form-input{
  width:100%;min-width:0;max-width:100%;
  border:1px solid var(--line);border-radius:12px;
  font-size:1rem;height:46px;padding:0 .9rem;background:#fff
}

/* 日期輸入 */
.date-wrap{position:relative;height:46px}
input[type="date"].form-input{appearance:none;-webkit-appearance:none;height:100%;padding:0 .9rem;font-size:16px}
input[type="date"]::-webkit-date-and-time-value{height:100%;line-height:46px}
input[type="date"]::-webkit-datetime-edit{padding:0}
input[type="date"]::-webkit-datetime-edit-fields-wrapper{padding:0;margin:0}
input[type="date"]::-webkit-calendar-picker-indicator{padding:0 8px 0 0}
.date-hint{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:#9aa0aa;pointer-events:none;font-size:16px;line-height:1}

/* 按鈕（扁平） */
.btn-main,.btn-ghost{border-radius:12px;font-weight:700;padding:.85rem 1.1rem;font-size:1.02rem}
.btn-main{background:var(--primary);color:#fff;border:1px solid var(--primary)}
.btn-ghost{background:#fff;border:1px solid var(--line);color:var(--primary)}

/* 同意條款星號 */
label.agree span::after{content:" *";color:#111;font-weight:700}

/* Modal */
.modal-rounded .modal-content{border-radius:14px !important;overflow:hidden;border:1px solid var(--line)}
#rulesModal .modal-header{background:#F2F4F8}
#rulesModal .modal-body{background:#F7F9FC}

/* 規則列表 */
.rule-line{display:flex;align-items:center;gap:10px;white-space:nowrap;font-weight:600;font-size:clamp(12px,3.2vw,16px);min-width:0;letter-spacing:.3px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:.25rem .6rem;border-radius:999px;border:1px solid var(--line);background:#fff}
.chip-strong{background:#E7EEF8;color:var(--primary);border-color:#D9E1EF}
.chip-range{background:#F8FAFC;color:#334155}

/* 遮罩（轉圈圈） */
#mask{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center; flex-direction:column; gap:10px;
  z-index:9999; background:rgba(255,255,255,.92); backdrop-filter:blur(2px);
  color:var(--primary); font-size:18px; font-weight:500;
}
#mask .loading-text{ font-weight:700; }
#mask .spinner-border{ width:2.25rem; height:2.25rem; }

/* Mobile */
@media (max-width:600px){
  .wrap{padding:8px}
  .page-head{margin:4px 4px 12px}
  .page-head .logo{width:54px;height:54px;font-size:26px}
  .grid{gap:4px;padding:8px}
  .day{min-height:auto;border-radius:10px;padding:6px}
  .day .d{font-size:.95rem}
  .day .meta{display:block}
  .pill{display:block;width:100%;text-align:center;padding:.12rem .4rem;font-size:.78rem;min-width:auto;margin-bottom:4px}
  .pill .remain{display:none}
  .tile{padding:10px;border-radius:12px}
  .date-wrap,.form-input,input[type="date"].form-input{height:46px}
}
</style>
</head>
<body>
<!-- 全頁遮罩（轉圈圈） -->
<div id="mask" style="display:none">
  <div class="loading-text">預約中請稍等，請勿關閉或重新整理頁面</div>
  <div class="spinner-border" role="status" aria-hidden="true"></div>
</div>

<div class="wrap">
  <div class="page-head"><div class="logo">＋</div><h1>陳萬龍診所門診線上預約</h1></div>

  <div class="cardish">
    <div class="cal-head">
      <div class="cal-title">
        <span class="title-text" id="calTitle">—</span>
        <!-- 小轉圈 + 載入中 -->
        <span id="calLoader" class="loader" style="display:none">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span class="ms-2">載入中</span>
        </span>
      </div>
      <div class="nav">
        <button id="btnPrev" class="nav-btn prev" aria-label="上一月" title="上一月"></button>
        <button id="btnNext" class="nav-btn next" aria-label="下一月" title="下一月"></button>
      </div>
    </div>

    <div class="rule-bar">
      <span id="nowTime" class="nowtime"></span>
      <button class="rule-btn" id="openRules">開放預約日期規則</button>
    </div>

    <div class="grid" id="whead"></div>
    <div class="grid" id="days"></div>
    <div class="section" id="dayPanel"></div>
    <div class="section picked" id="picked"></div>
  </div>

  <!-- 表單 -->
  <div class="cardish section mt-3">
    <input type="hidden" id="date"/><input type="hidden" id="slot"/>
    <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response"/>

    <div class="form-grid">
      <div>
        <div class="form-label-strong">姓名 *</div>
        <input id="name" type="text" class="form-input" autocomplete="off"/>
      </div>

      <div>
        <div class="form-label-strong">出生年月日 *</div>
        <div class="date-wrap" id="dateWrap">
          <input id="birthday" type="date" class="form-input" inputmode="numeric" autocomplete="off"/>
          <span class="date-hint" id="dateHint"> 年/月/日</span>
        </div>
      </div>

      <div>
        <div class="form-label-strong">身分證字號 *</div>
        <input id="idnum" type="text" maxlength="10" class="form-input" placeholder="A123456789" autocomplete="off"/>
      </div>

      <div>
        <div class="form-label-strong">聯絡電話 *</div>
        <input id="phone" type="text" maxlength="10" inputmode="numeric" pattern="\d{10}" class="form-input" placeholder="0958xxxxxx" autocomplete="off"/>
      </div>
    </div>

    <div class="mt-2">
      <label class="agree"><input id="agree" type="checkbox"/><span>我已閱讀並同意 <a href="#" id="showNotice">預約須知</a></span></label>
    </div>
    <div class="d-grid gap-2 mt-3">
      <button id="submitBtn" class="btn-main">送出預約</button>
      <a class="btn-ghost text-center text-decoration-none" href="query.html">查詢/取消預約</a>
    </div>
  </div>
</div>

<!-- 規則 Modal -->
<div class="modal fade modal-rounded" id="rulesModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="font-weight:700;color:var(--primary)">開放預約日期規則</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
      </div>
      <div class="modal-body">
        <div class="p-2 rounded-3" style="background:#E7EEF8;border:1px solid #D9E1EF">
          <div class="rule-line"><span class="chip chip-strong">週一</span><span>可預約 →</span><span class="chip chip-range">［ 週四 ~ 下下週一 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週二</span><span>可預約 →</span><span class="chip chip-range">［ 週五 ~ 下下週二 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週三</span><span>可預約 →</span><span class="chip chip-range">［ 週六 ~ 下下週三 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週四</span><span>可預約 →</span><span class="chip chip-range">［ 下週一 ~ 下下週四 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週五</span><span>可預約 →</span><span class="chip chip-range">［ 下週二 ~ 下下週五 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週六</span><span>可預約 →</span><span class="chip chip-range">［ 下週二 ~ 下下週六 ］</span></div>
          <div class="rule-line"><span class="chip chip-strong">週日</span><span>可預約 →</span><span class="chip chip-range">［ 下週三 ~ 下下週日 ］</span></div>
        </div>
        <div class="mt-3 text-secondary" style="font-size:.95rem">如對門診時間有疑問，請對照「門診時刻表」與「最新消息」確認是否有門診異動。</div>
      </div>
    </div>
  </div>
</div>

<!-- 預約須知 Modal -->
<div class="modal fade modal-rounded" id="noticeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">預約須知與個資告知</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button></div>
      <div class="modal-body" style="text-align:left">
        <ol class="numlist">
          <li><span class="num"></span><span class="txt">本院蒐集之個人資料（姓名、電話、身分證字號）僅用於掛號與醫療聯繫，不另作他用。</span></li>
          <li><span class="num"></span><span class="txt">請於預約的門診結束前一小時到場報到（早診10:30前；午診16:00前；晚診20:00前），逾時視同放棄，會釋出名額給現場掛號。</span></li>
          <li><span class="num"></span><span class="txt">如需取消，請於前一日線上辦理；當日請以電話通知 (03) 515-2971。</span></li>
          <li><span class="num"></span><span class="txt">本院保留因醫療需求調整看診順序之權利。</span></li>
          <li><span class="num"></span><span class="txt">勾選同意表示理解並接受上述內容。</span></li>
        </ol>
        <div class="d-grid mt-3">
          <button id="agreeConfirm" class="btn-main">同意</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- reCAPTCHA v3 -->
<script src="https://www.google.com/recaptcha/api.js?render=6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu"></script>

<script>
/* ====== 基本設定（功能不變） ====== */
const API="https://script.google.com/macros/s/AKfycby37Sxk-a-q9hxqROALi1gmGhWGXWr2xw8WF_pdgMAN_9HvM1PZJfgN6TJnVrGw0x9W/exec";
const RECAPTCHA_SITE_KEY="6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu";
const AES_KEY="A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";

/* 一次性簽章暫存 */
const nonceStore = {}; // { 'YYYY-MM-DD': {nonce, sig, exp} }

/* ====== 驗證工具 ====== */
function onlyDigits(s){ return String(s||'').replace(/\D/g,''); }
function validateTaiwanId(id){
  if(!/^[A-Z][12]\d{8}$/.test(id)) return false;
  const codeMap = {A:10,B:11,C:12,D:13,E:14,F:15,G:16,H:17,I:34,J:18,K:19,L:20,M:21,N:22,O:35,P:
