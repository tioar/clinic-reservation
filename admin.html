<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>陳萬龍診所｜後台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{ font-family:"標楷體", "Noto Serif TC", serif; background:#f4f6f8; }
    .container{ max-width:1200px; margin-top:20px; }
    table{ font-size:14px; }
    th,td{ vertical-align:middle; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-3">後台管理</h2>

  <div id="loginBox">
    <div class="mb-2"><input type="text" id="acc" class="form-control" placeholder="帳號"></div>
    <div class="mb-2"><input type="password" id="pw" class="form-control" placeholder="密碼"></div>
    <button class="btn btn-primary" onclick="login()">登入</button>
    <div id="loginMsg" class="text-danger mt-2"></div>
  </div>

  <div id="mainBox" style="display:none;">
    <h4 class="mt-4">今天預約名單</h4>
    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th>診別</th><th>時間</th><th>號碼</th>
          <th>姓名</th><th>生日</th><th>身分證</th>
          <th>電話</th><th>建立時間</th><th>動作</th>
        </tr>
      </thead>
      <tbody id="todayTbody"></tbody>
    </table>

    <h4 class="mt-4">指定日期查詢</h4>
    <div class="d-flex mb-2">
      <input type="date" id="dateInput" class="form-control me-2" style="max-width:200px;">
      <button class="btn btn-secondary" onclick="loadDay()">查詢</button>
    </div>
    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th>診別</th><th>時間</th><th>號碼</th>
          <th>姓名</th><th>生日</th><th>身分證</th>
          <th>電話</th><th>建立時間</th><th>動作</th>
        </tr>
      </thead>
      <tbody id="dayTbody"></tbody>
    </table>
  </div>
</div>

<script>
let TOKEN = '';

function api(act, params={}){
  const url = 'YOUR_DEPLOY_URL'; // ★ 這裡換成你部署的 GAS 網址
  const body = new URLSearchParams({ action: act, token:TOKEN, ...params });
  return fetch(url+'?'+body.toString()).then(r=>r.json());
}

// ★ 民國生日格式化
function fmtRocBirthday(str){
  if(!str) return '';
  const d = new Date(str);
  if(isNaN(d)) return str;
  const y = d.getFullYear() - 1911;
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return y + '/' + m + '/' + dd;
}

function login(){
  const acc=document.getElementById('acc').value.trim();
  const pw =document.getElementById('pw').value.trim();
  api('adminLogin',{acc,pw}).then(d=>{
    if(d.ok){
      TOKEN=d.token;
      document.getElementById('loginBox').style.display='none';
      document.getElementById('mainBox').style.display='block';
      loadToday();
    }else{
      document.getElementById('loginMsg').innerText='登入失敗';
    }
  });
}

function loadToday(){
  api('adminToday').then(d=>{
    const tb=document.getElementById('todayTbody');
    tb.innerHTML=d.items.map(x=>`
      <tr>
        <td>${x.slot}</td>
        <td>${x.time}</td>
        <td>${x.num}</td>
        <td>${x.name}</td>
        <td>${fmtRocBirthday(x.birthday)}</td>
        <td>${x.pid}</td>
        <td>${x.phone}</td>
        <td>${x.createdAt}</td>
        <td><button class="btn btn-sm btn-danger" onclick="cancel(${x.id})">取消</button></td>
      </tr>`).join('');
  });
}

function loadDay(){
  const date=document.getElementById('dateInput').value;
  if(!date) return;
  api('adminDay',{date}).then(d=>{
    const tb=document.getElementById('dayTbody');
    tb.innerHTML=d.items.map(x=>`
      <tr>
        <td>${x.slot}</td>
        <td>${x.time}</td>
        <td>${x.num}</td>
        <td>${x.name}</td>
        <td>${fmtRocBirthday(x.birthday)}</td>
        <td>${x.pid}</td>
        <td>${x.phone}</td>
        <td>${x.createdAt}</td>
        <td><button class="btn btn-sm btn-danger" onclick="cancel(${x.id})">取消</button></td>
      </tr>`).join('');
  });
}

function cancel(id){
  if(!confirm('確定取消?')) return;
  api('adminCancel',{id}).then(d=>{
    alert(d.message||'已取消');
    loadToday();
    if(document.getElementById('dateInput').value) loadDay();
  });
}
</script>
</body>
</html>
