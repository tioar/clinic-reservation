<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>陳萬龍診所預約後台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#3b697d;        /* 靛藍主色 */
      --primary-600:#2f5565;     /* 主色 hover/active */
      --card-bg:#ffffff;
      --border:#d9dee7;

      /* row tint colors（表格與上方卡片共用） */
      /* 早診：綠 */
      --early-light:#e7f7ee;
      --early-dark:#cfeedd;
      --early-bar:#16a34a;

      /* 午診：橘 */
      --noon-light:#fff3df;
      --noon-dark:#ffe4b3;
      --noon-bar:#f59e0b;

      /* 晚診：藍 */
      --night-light:#e8f2ff;
      --night-dark:#cfe2ff;
      --night-bar:#3b82f6;

      /* 約診：桃紅 */
      --appt-light:#f9e0f5;   /* 淺粉紫底 */
      --appt-dark:#f3b3e6;    /* 深一點的桃紅底 */
      --appt-bar:#b51695;     /* 主色桃紅（深洋紅） */

    }

    body{
      font-family:'Noto Sans TC','Microsoft JhengHei',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(160deg,#ecf1f6,#e6edf6);
      min-height:100vh;
      color:#334155;
    }

    /* ===== 卡片 ===== */
    .card{ border-radius:28px; border:2px solid var(--border); box-shadow:0 6px 14px rgba(0,0,0,.06); }

    /* ===== 共用按鈕 ===== */
    .btn{ border-radius:999px; font-weight:700; border:0; }
    .btn-main{ background:var(--primary); color:#fff !important; }
    .btn-main:hover, .btn-main.active{ background:var(--primary-600); color:#fff !important; }
    .btn-ghost{ background:#94a3b8; color:#fff !important; }
    .btn-ghost:hover, .btn-ghost.active{ background:#64748b; color:#fff !important; }
    .btn-danger{ background:#dc3545; color:#fff !important; }
    .btn-danger:hover{ background:#b02a37; color:#fff !important; }
    .btn-warning{ background:#f59e0b; color:#fff !important; }
    .btn-warning:hover{ background:#d97706; color:#fff !important; }

    /* ===== Login ===== */
    .login-card{ display:grid; place-items:center; min-height:calc(100vh - 6rem); padding:3rem 1rem; }
    .login-card .card{ width:100%; max-width:460px; padding:28px 24px; }
    .login-card .header{ display:flex; align-items:center; gap:14px; margin-bottom:10px; }
    .login-card .logo{
      width:56px; height:56px; border-radius:50%;
      display:grid; place-items:center;
      background:var(--primary); color:#fff; font-weight:900; font-size:28px; line-height:1;
      box-shadow:0 8px 18px rgba(59,105,125,.25);
    }
    .login-card h1{ font-weight:900; }
    .login-card .form-control{
      border-radius:16px; padding:.675rem .95rem; border:2px solid #d1d5db;
    }
    .login-card .form-control:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 .2rem rgba(59,105,125,.2);
      outline:none;
    }

    /* ===== 頂部區 ===== */
    .card-head{ display:flex; align-items:center; gap:12px; }
    .card-head .logo{
      width:44px; height:44px; border-radius:50%;
      display:grid; place-items:center;
      background:var(--primary); color:#fff; font-weight:900; font-size:24px; line-height:1;
      box-shadow:0 6px 14px rgba(59,105,125,.18);
    }
    .card-head h3{ font-weight:900; }
    .card-head .subtitle{ margin-top:2px; font-size:.95rem; color:#64748b; }
    .card-head .subtitle b{ color:#0f172a; font-weight:900; }

    /* ===== 分頁鈕：深底白字，選中更深 ===== */
    .tabbar .btn{ padding:.55rem 1rem; }
    .tabbar .btn:not(.active){ background:#6b7a90; color:#fff; }
    .tabbar .btn.active{ background:var(--primary-600); color:#fff; }

    /* ===== 日期列 ===== */
    .date-nav{ display:flex; flex-wrap:wrap; align-items:center; gap:.5rem .5rem; }
    .date-nav .form-control{ width:160px; border-radius:14px; }
    .totals{ font-weight:900; color:#1f3f57; } .totals .muted{ color:#6b7a90; font-weight:800; }

    /* ===== 上方統計卡 ===== */
    .stat{
      border:2px dashed var(--border);
      border-radius:20px;
      padding:.9rem 1rem;
      background:#fff;
      display:flex; align-items:center; gap:.9rem;
      box-shadow:0 4px 10px rgba(0,0,0,.04);
    }
    .stat .cap{
      padding:.35rem .7rem;
      border-radius:999px;
      font-weight:900;
      line-height:1;
    }
    .stat .kv{font-weight:800}
    .stat .note{color:#6b7280;font-weight:700}

    .stat-early{ background:var(--early-light); border-color:var(--early-bar); }
    .stat-early .cap{ background:#dff5ea; color:#065f46; border:1px solid #b8ead4; }
    .stat-noon{  background:var(--noon-light);  border-color:var(--noon-bar); }
    .stat-noon  .cap{ background:#ffeccd; color:#7a4d00; border:1px solid #ffd69a; }
    .stat-night{ background:var(--night-light); border-color:var(--night-bar); }
    .stat-night .cap{ background:#e1ecff; color:#1d4ed8; border:1px solid #c7dbff; }
    .stat-appt{ background:var(--appt-light); border-color:var(--appt-bar); }    /* 約診 */
    .stat-appt .cap{ background:#ffe0ef; color:#9d174d; border:1px solid #f9b3d1; }

    /* ===== 表格 ===== */
    .table{ border-radius:16px; overflow:hidden; margin:0; }
    .table td{ border-top:2px solid #e5e7eb !important; }
    .table thead th{ border-bottom:2px solid #cbd5e1 !important; font-weight:900; }

    /* 整列底色 + 左側色條 */
    tr.slot-early-light  > *{ background:var(--early-light) !important; }
    tr.slot-early-dark   > *{ background:var(--early-dark)  !important; }
    tr.slot-noon-light   > *{ background:var(--noon-light)  !important; }
    tr.slot-noon-dark    > *{ background:var(--noon-dark)   !important; }
    tr.slot-night-light  > *{ background:var(--night-light) !important; }
    tr.slot-night-dark   > *{ background:var(--night-dark)  !important; }
    tr.slot-appt-light   > *{ background:var(--appt-light)  !important; }   /* 約診 */
    tr.slot-appt-dark    > *{ background:var(--appt-dark)   !important; }   /* 約診 */

    tr[class^="slot-early"] td:first-child{ box-shadow:inset 6px 0 0 0 var(--early-bar); }
    tr[class^="slot-noon"]  td:first-child{ box-shadow:inset 6px 0 0 0 var(--noon-bar); }
    tr[class^="slot-night"] td:first-child{ box-shadow:inset 6px 0 0 0 var(--night-bar); }
    tr[class^="slot-appt"]  td:first-child{ box-shadow:inset 6px 0 0 0 var(--appt-bar); } /* 約診 */

    /* 新增異動區塊的小色塊 */
    .tag{ display:inline-block; width:.8em; height:.8em; border-radius:50%; margin-right:.4em; vertical-align:middle; }
    .tag-early{ background:var(--early-bar); }
    .tag-noon{  background:var(--noon-bar); }
    .tag-night{ background:var(--night-bar); }
    .tag-appt{  background:var(--appt-bar); }  /* 約診 */

    .small-note{ color:#64748b; font-size:.925rem; }
    .small-note code{ background:#f6f7fb; padding:.1rem .25rem; border-radius:6px; }

    /* ===== 4 欄排版與約診卡片縮窄（大螢幕） ===== */
    @media (min-width: 992px){
      .stat-appt.stat-compact{ padding:.6rem .8rem; }   /* 約診卡片更窄 */
      .stat-appt.stat-compact .kv{ font-size:.95rem; }
      .stat-appt.stat-compact .small-note{ font-size:.85rem; }
      .stat .cap{ white-space: nowrap; }
    }
  </style>
</head>
<body>
<!-- Login -->
<div id="login" class="container login-card">
  <div class="card">
    <div class="header">
      <div class="logo">＋</div>
      <div>
        <h1 class="h4 m-0">後台登入</h1>
        <div class="small-note mt-1">請輸入管理帳號與密碼</div>
      </div>
    </div>
    <label for="acc" class="form-label small-note mb-1">帳號</label>
    <input id="acc" class="form-control mb-3" placeholder="輸入帳號" autocomplete="username">
    <label for="pw" class="form-label small-note mb-1">管理密碼</label>
    <input id="pw" type="password" class="form-control mb-3" placeholder="輸入密碼" autocomplete="current-password">
    <button id="btnLoginPW" class="btn btn-main w-100 mb-2">登入</button>
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="rememberMe">
      <label class="form-check-label small-note" for="rememberMe">在此裝置記住帳密（僅此分頁、關閉即清除）</label>
    </div>
    <div class="small-note mt-1">忘記密碼？請聯絡管理者</div>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none;">
  <div class="container py-3" style="max-width:1180px;">
    <div class="card-head mb-3">
      <div class="logo">＋</div>
      <div>
        <h3 class="m-0">後台管理</h3>
        <div class="subtitle"><b>今天名單、明天名單、預約設定、臨時異動</b></div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="exportBtn" class="btn btn-ghost btn-sm">匯出今日起預約名單</button>
        <button id="logoutBtn"  class="btn btn-main btn-sm">登出</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabbar mb-3 d-flex gap-2">
      <button class="btn btn-main active" id="tabBtnToday" data-tab="tab-today">今天名單</button>
      <button class="btn btn-main" id="tabBtnTomorrow" data-tab="tab-tomorrow">明天名單</button>
      <button class="btn btn-main" id="tabBtnSettings" data-tab="tab-settings">預約設定</button>
      <button class="btn btn-main" id="tabBtnSpecial" data-tab="tab-special">臨時異動</button>
    </div>

    <!-- ====== 今天名單 ====== -->
    <section id="tab-today">
      <div class="card mb-3 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0 fw-bold">今天名單</h5>
            <div id="todayInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTodayReload" class="btn btn-ghost btn-sm">重新整理</button></div>
        </div>
        <div class="date-nav mt-2">
          <button id="tPrev" class="btn btn-ghost btn-sm">◄ 前一天</button>
          <input id="tDate" type="date" class="form-control form-control-sm">
          <button id="tNext" class="btn btn-ghost btn-sm">後一天 ►</button>
          <button id="tToday" class="btn btn-ghost btn-sm">今天</button>
          <button id="tTomorrow" class="btn btn-ghost btn-sm">明天</button>
          <div class="ms-2 totals"><span class="muted">總計：</span><span id="tTotals">—</span></div>
        </div>
        <div id="todayStats" class="row g-3 mt-2"></div>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table class="table align-middle" id="tblToday">
            <thead>
              <tr>
                <th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th>
                <th>身分證</th><th>電話</th><th>建立時間</th><th style="width:90px;">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 明天名單 ====== -->
    <section id="tab-tomorrow" style="display:none;">
      <div class="card mb-3 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0 fw-bold">明天名單</h5>
            <div id="tomorrowInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTomorrowReload" class="btn btn-ghost btn-sm">重新整理</button></div>
        </div>
        <div class="date-nav mt-2">
          <button id="mPrev" class="btn btn-ghost btn-sm">◄ 前一天</button>
          <input id="mDate" type="date" class="form-control form-control-sm">
          <button id="mNext" class="btn btn-ghost btn-sm">後一天 ►</button>
          <button id="mToday" class="btn btn-ghost btn-sm">今天</button>
          <button id="mTomorrow" class="btn btn-ghost btn-sm">明天</button>
          <div class="ms-2 totals"><span class="muted">總計：</span><span id="mTotals">—</span></div>
        </div>
        <div id="tomorrowStats" class="row g-3 mt-2"></div>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table class="table align-middle" id="tblTomorrow">
            <thead>
              <tr>
                <th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th>
                <th>身分證</th><th>電話</th><th>建立時間</th><th style="width:90px;">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 預約設定 ====== -->
    <section id="tab-settings" style="display:none;">
      <div class="card mb-4 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="m-0 fw-bold">預約期限</h5>
          <div class="small-note">顯示區間 = 今天 + 起始天 ～ 今天 + 結束天</div>
        </div>
        <div id="winInfo" class="small-note my-2"></div>

        <div class="d-flex flex-wrap align-items-center gap-4">
          <div>
            <div class="small-note mb-1">起始天</div>
            <div class="input-group" style="max-width:200px;">
              <button class="btn btn-ghost" id="btnStartMinus">－</button>
              <input id="winStart" inputmode="numeric" type="number" class="form-control text-center no-spinner" value="2" style="border-radius:14px;">
              <button class="btn btn-ghost" id="btnStartPlus">＋</button>
            </div>
          </div>
          <div>
            <div class="small-note mb-1">結束天</div>
            <div class="input-group" style="max-width:200px;">
              <button class="btn btn-ghost" id="btnEndMinus">－</button>
              <input id="winEnd" inputmode="numeric" type="number" class="form-control text-center no-spinner" value="14" style="border-radius:14px;">
              <button class="btn btn-ghost" id="btnEndPlus">＋</button>
            </div>
          </div>
          <div class="d-flex align-items-end">
            <button id="btnWinSet" class="btn btn-main">套用</button>
          </div>
        </div>

        <div class="form-check form-switch mt-3">
          <input class="form-check-input" type="checkbox" role="switch" id="customWindowSwitch">
          <label class="form-check-label small-note" for="customWindowSwitch">
            使用自訂日期區間（上方 D+起始～D+結束）。關閉時使用系統預設規則。
          </label>
        </div>

        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" role="switch" id="flagWeekSwitch">
          <label class="form-check-label small-note" for="flagWeekSwitch">
            啟用「預設星期規律」提示旗標（供前端面板使用）。
          </label>
        </div>

        <div class="small-note mt-2">
          若要「奇數／偶數」：在下方每天規則設定 <code>起始號碼</code>（1=奇，2=偶）與 <code>間隔位數</code>（設 2）。
        </div>
      </div>

      <div class="card mb-4 p-3">
        <h5 class="mb-2 fw-bold">每週規則（daily_limit）</h5>
        <div class="table-responsive">
          <table class="table align-middle" id="tblDaily">
            <colgroup>
              <col style="width:120px;">
              <col style="width:80px;"><col style="width:80px;"><col style="width:80px;">
              <col style="width:200px;"><col style="width:200px;"><col style="width:200px;">
              <col style="width:96px;"><col style="width:96px;"><col style="width:96px;">
            </colgroup>
            <thead>
              <tr>
                <th>星期</th>
                <th>早診上限</th><th>午診上限</th><th>晚診上限</th>
                <th>早診時間</th><th>午診時間</th><th>晚診時間</th>
                <th>起始號碼</th><th>間隔位數</th><th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">時間格式：08:30~11:30 ｜ 奇數：起始=1、間隔=2；偶數：起始=2、間隔=2；連號：起始=1、間隔=1。</div>
      </div>

      <div class="card p-3" id="sheetsCard" style="display:none;">
        <h5 class="mb-2 fw-bold">試算表捷徑</h5>
        <div id="sheetBtns" class="d-flex flex-wrap gap-2"></div>
        <div class="text-muted small mt-2">（需有該試算表權限；會在新分頁開啟）</div>
      </div>
    </section>

    <!-- ====== 臨時異動 ====== -->
    <section id="tab-special" style="display:none;">
      <div class="card mb-4 p-3">
        <h5 class="mb-3 fw-bold">新增臨時異動</h5>
        <input type="date" id="newDate" class="form-control mb-3" style="border-radius:14px;">

        <div class="row g-2 align-items-center">
          <div class="col-12 col-md-3"><span class="tag tag-early"></span><strong>早診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neEarlyLimit" value="10" type="number" class="form-control" placeholder="上限" style="border-radius:14px;"></div>
          <div class="col-6 col-md-6"><input id="neEarlyTime"  value=""   class="form-control" placeholder="早診時段，例如 08:30~11:30" style="border-radius:14px;"></div>
        </div>

        <div class="row g-2 align-items-center mt-1">
          <div class="col-12 col-md-3"><span class="tag tag-noon"></span><strong>午診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neNoonLimit"  value="10" type="number" class="form-control" placeholder="上限" style="border-radius:14px;"></div>
          <div class="col-6 col-md-6"><input id="neNoonTime"   value=""   class="form-control" placeholder="午診時段，例如 14:00~17:00" style="border-radius:14px;"></div>
        </div>

        <div class="row g-2 align-items-center mt-1">
          <div class="col-12 col-md-3"><span class="tag tag-night"></span><strong>晚診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neNightLimit" value="10" type="number" class="form-control" placeholder="上限" style="border-radius:14px;"></div>
          <div class="col-6 col-md-6"><input id="neNightTime"  value=""   class="form-control" placeholder="晚診時段，例如 18:00~20:30" style="border-radius:14px;"></div>
        </div>

        <!-- 約診 -->
        <div class="row g-2 align-items-center mt-1">
          <div class="col-12 col-md-3"><span class="tag tag-appt"></span><strong>約診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neApptLimit" value="0" type="number" class="form-control" placeholder="上限" style="border-radius:14px;"></div>
          <div class="col-6 col-md-6"><input id="neApptTime"  value=""   class="form-control" placeholder="約診時段，例如 09:00~11:00" style="border-radius:14px;"></div>
        </div>

        <div class="row g-2 align-items-end mt-2">
          <div class="col-6 col-md-3">
            <label class="small-note">起始號碼</label>
            <input id="neStartNo" type="number" class="form-control text-center" value="1" min="1" style="border-radius:14px;">
          </div>
          <div class="col-6 col-md-3">
            <label class="small-note">間隔位數</label>
            <input id="neStep" type="number" class="form-control text-center" value="1" min="1" style="border-radius:14px;">
          </div>
          <div class="col-12 col-md-6">
            <label class="small-note">備註</label>
            <div class="d-flex gap-2">
              <input id="neNote" placeholder="備註" class="form-control" style="border-radius:14px;">
              <button id="addBtn" class="btn btn-main">新增</button>
            </div>
          </div>
        </div>
        <div class="small-note mt-2">時間格式：08:30~11:30 ｜ 奇數／偶數：起始=1／2、間隔=2。</div>
      </div>

      <div class="card p-3">
        <h5 class="mb-2 fw-bold">目前異動（未過期）</h5>
        <div class="table-responsive">
          <table class="table align-middle" id="tbl">
            <colgroup>
              <col style="width:110px;">
              <col style="width:80px;"><col style="width:80px;"><col style="width:80px;"><col style="width:80px;">   <!-- +約診上限 -->
              <col style="width:150px;"><col style="width:150px;"><col style="width:150px;"><col style="width:150px;"> <!-- +約診時段 -->
              <col style="width:90px;"><col style="width:90px;">
              <col style="width:200px;">
              <col style="width:220px;">
            </colgroup>
            <thead>
              <tr>
                <th>日期</th>
                <th>早診上限</th><th>午診上限</th><th>晚診上限</th><th>約診上限</th>
                <th>早診時段</th><th>午診時段</th><th>晚診時段</th><th>約診時段</th>
                <th>起始號碼</th><th>間隔位數</th>
                <th>備註</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
/* ===== API 與共用 ===== */
const API = "https://script.google.com/macros/s/AKfycbxWNXkvOyXg3Nkx7rC_NIitZgQUAP1v5-6BHMFgXDGWbPLmcHAw8TCa-5wmRePMF41w/exec";
let ADMIN_TOKEN = sessionStorage.getItem('ADMIN_TOKEN')||"";

/* ========= Token 自動續期工具 ========= */
function tokenExpSec(t){ try{ return Number(String(t).split('.')[0])||0; }catch(_){ return 0; } }
function tokenExpired(t, preSec=60){
  const exp = tokenExpSec(t);
  if(!exp) return true;
  const now = Math.floor(Date.now()/1000);
  return (exp - now) <= preSec;
}
function saveCred(acc, pw){
  try{
    if(document.getElementById('rememberMe')?.checked){
      sessionStorage.setItem('ADMIN_ACC', acc||'');
      sessionStorage.setItem('ADMIN_PW',  pw||'');
    }else{
      sessionStorage.removeItem('ADMIN_ACC');
      sessionStorage.removeItem('ADMIN_PW');
    }
  }catch(_){}
}
function loadCred(){
  return { acc: sessionStorage.getItem('ADMIN_ACC')||'', pw: sessionStorage.getItem('ADMIN_PW')||'' };
}
async function reloginWithSaved(){
  const {acc, pw} = loadCred();
  if(!acc || !pw) return false;
  try{
    const r = await axios.get(API,{params:{action:'adminLogin',acc,pw}});
    if(r.data?.ok){
      ADMIN_TOKEN = r.data.token;
      sessionStorage.setItem('ADMIN_TOKEN', ADMIN_TOKEN);
      return true;
    }
  }catch(_){}
  return false;
}
async function adminCall(action, params={}){
  if(!ADMIN_TOKEN || tokenExpired(ADMIN_TOKEN, 60)){
    await reloginWithSaved();
  }
  let r = await axios.get(API,{params:{action, token:ADMIN_TOKEN, ...params}});
  if(r?.data && r.data.ok===false && r.data.error==='unauthorized'){
    const ok = await reloginWithSaved();
    if(ok){
      r = await axios.get(API,{params:{action, token:ADMIN_TOKEN, ...params}});
    }else{
      sessionStorage.removeItem('ADMIN_TOKEN');
      ADMIN_TOKEN="";
      alert('登入已失效，請重新登入');
      showLogin();
      throw new Error('unauthorized');
    }
  }
  return r.data;
}

/* ===== 小工具 ===== */
const loginBox=document.getElementById('login'), appBox=document.getElementById('app');
const acc=document.getElementById('acc'), pw=document.getElementById('pw'), btnLoginPW=document.getElementById('btnLoginPW');
const logoutBtn=document.getElementById('logoutBtn'), exportBtn=document.getElementById('exportBtn');

const tabBtnToday=document.getElementById('tabBtnToday'),
      tabBtnTomorrow=document.getElementById('tabBtnTomorrow'),
      tabBtnSettings=document.getElementById('tabBtnSettings'),
      tabBtnSpecial=document.getElementById('tabBtnSpecial');

const views={
  'tab-today':document.getElementById('tab-today'),
  'tab-tomorrow':document.getElementById('tab-tomorrow'),
  'tab-settings':document.getElementById('tab-settings'),
  'tab-special':document.getElementById('tab-special')
};

function switchTab(id){
  [tabBtnToday,tabBtnTomorrow,tabBtnSettings,tabBtnSpecial].forEach(b=>{
    const a=(b.dataset.tab||b.id.replace('tabBtn','tab-'))===id;
    b.classList.toggle('active',a);
  });
  Object.entries(views).forEach(([k,el])=>el.style.display=(k===id?'block':'none'));
  if(id==='tab-today'){ initTodayTab(); }
  if(id==='tab-tomorrow'){ initTomorrowTab(); }
  if(id==='tab-settings'){ loadWindow(); loadFlags(); loadDaily(); loadSheetLinks(); }
  if(id==='tab-special'){ loadSpecials(); }
}
document.querySelector('.tabbar').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-tab]');
  if(!btn) return;
  switchTab(btn.dataset.tab);
});

function showApp(){ loginBox.style.display="none"; appBox.style.display="block"; switchTab('tab-today'); }
function showLogin(){
  appBox.style.display="none"; loginBox.style.display="block";
  const c = loadCred();
  if(c.acc) document.getElementById('rememberMe').checked = true;
  acc.value = c.acc || '';
  pw.value  = c.pw  || '';
}
function assertAuthed(){ if(!ADMIN_TOKEN){ showLogin(); throw new Error('no token'); } }

function ymdLocal(d){ const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2); return `${y}-${m}-${da}`; }
function addDays(ymd,delta){ const d=new Date(ymd); d.setDate(d.getDate()+delta); return ymdLocal(d); }
function todayYmd(){ return ymdLocal(new Date()); }
function asObj(p){ try{ return typeof p==='string'?JSON.parse(p):(p||{});}catch{ return {}; } }
function asArr(p){ try{ if(typeof p==='string') p=JSON.parse(p);}catch{} if(Array.isArray(p))return p; if(Array.isArray(p?.rows))return p.rows; if(Array.isArray(p?.items))return p.items; if(Array.isArray(p?.data))return p.data; return []; }
function num(x){ const n=Number(x); return isFinite(n)?n:0; }

/* ===== 共用：渲染統計 + 表格 ===== */
function slotKey(label){
  const s=String(label||'').trim();
  if(s.includes('約')) return 'appt';    /* 約診 */
  if(s.includes('早')) return 'early';
  if(s.includes('午')) return 'noon';
  if(s.includes('晚')) return 'night';
  return 'early';
}

/* 固定順序 + 4 欄佈局 + 約診卡片縮窄 */
function renderStats(containerId, slots){
  const order = {'早診':1,'午診':2,'晚診':3,'約診':4};
  const list = Array.isArray(slots) ? [...slots] : [];
  list.sort((a,b)=>(order[a?.label]||99)-(order[b?.label]||99));

  const box=document.getElementById(containerId);
  box.innerHTML='';
  box.classList.add('row','g-3','mt-2');

  const frag=document.createDocumentFragment();
  list.forEach(s=>{
    const label = s.label || '';
    const key   = slotKey(label);
    const isAppt= (key==='appt');

    const col=document.createElement('div');
    col.className='col-6 col-lg-3';     // 手機兩欄、桌機四欄

    col.innerHTML = `
      <div class="stat stat-${key} ${isAppt?'stat-compact':''}">
        <div class="cap">${label}</div>
        <div class="flex-grow-1">
          <div class="small-note mb-1">${s.time||''}</div>
          <div class="kv">
            <b>${num(s.used)}</b> / ${num(s.limit)}
            <span class="note">（起始 ${num(s.startNo)}，間隔 ${num(s.step)}）</span>
          </div>
        </div>
      </div>`;
    frag.appendChild(col);
  });
  box.appendChild(frag);
}

function renderItems(tableId, items, refreshFnName){
  const tb=document.querySelector(`#${tableId} tbody`); tb.innerHTML='';
  const counters={ early:0, noon:0, night:0, appt:0 };
  items.forEach(x=>{
    const tr=document.createElement('tr');
    const key=slotKey(x.slot||'');
    const idx=(counters[key]++);
    const shade=(idx % 2===0 ? 'light' : 'dark');
    tr.className=`slot-${key}-${shade}`;
    tr.innerHTML=`
      <td>${x.slot||''}</td>
      <td>${x.time||''}</td>
      <td>${x.num||''}</td>
      <td>${x.name||''}</td>
      <td>${x.birthday||''}</td>
      <td>${x.pid||''}</td>
      <td>${x.phone||''}</td>
      <td>${x.createdAt||''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="cancelRow(${x.id}, '${refreshFnName}')">取消</button></td>`;
    tb.appendChild(tr);
  });
}

/* ===== 今天 / 明天 ===== */
const tDate=document.getElementById('tDate'), tPrev=document.getElementById('tPrev'), tNext=document.getElementById('tNext'),
      tToday=document.getElementById('tToday'), tTomorrow=document.getElementById('tTomorrow'),
      todayInfo=document.getElementById('todayInfo'), tTotals=document.getElementById('tTotals');

const mDate=document.getElementById('mDate'), mPrev=document.getElementById('mPrev'), mNext=document.getElementById('mNext'),
      mToday=document.getElementById('mToday'), mTomorrow=document.getElementById('mTomorrow'),
      tomorrowInfo=document.getElementById('tomorrowInfo'), mTotals=document.getElementById('mTotals');

document.getElementById('btnTodayReload').onclick=()=>initTodayTab();
document.getElementById('btnTomorrowReload').onclick=()=>initTomorrowTab();

tPrev.onclick=()=>{ tDate.value=addDays(tDate.value||todayYmd(), -1); initTodayTab(); };
tNext.onclick=()=>{ tDate.value=addDays(tDate.value||todayYmd(), +1); initTodayTab(); };
tToday.onclick=()=>{ tDate.value=todayYmd(); initTodayTab(); };
tTomorrow.onclick=()=>{ tDate.value=addDays(todayYmd(), +1); initTodayTab(); };

mPrev.onclick=()=>{ mDate.value=addDays(mDate.value||addDays(todayYmd(),1), -1); initTomorrowTab(); };
mNext.onclick=()=>{ mDate.value=addDays(mDate.value||addDays(todayYmd(),1), +1); initTomorrowTab(); };
mToday.onclick=()=>{ mDate.value=todayYmd(); initTomorrowTab(); };
mTomorrow.onclick=()=>{ mDate.value=addDays(todayYmd(), +1); initTomorrowTab(); };

async function loadDay(dateStr, infoEl, totalsEl, statsContainerId, tableId){
  const d=await adminCall('adminDay',{date:dateStr});
  infoEl.textContent = `${d.date||''}（${d.weekday||''}）`;
  totalsEl.textContent = Array.isArray(d.items)? d.items.length : 0;
  renderStats(statsContainerId, d.slots||[]);
  renderItems(tableId, d.items||[], tableId==='tblToday'?'initTodayTab':'initTomorrowTab');
}
async function initTodayTab(){
  if(!tDate.value) tDate.value=todayYmd();
  await loadDay(tDate.value, todayInfo, tTotals, 'todayStats', 'tblToday');
}
async function initTomorrowTab(){
  if(!mDate.value) mDate.value=addDays(todayYmd(),1);
  await loadDay(mDate.value, tomorrowInfo, mTotals, 'tomorrowStats', 'tblTomorrow');
}

/* ===== 取消（管理端） ===== */
async function cancelRow(id, refreshFnName){
  if(!confirm('確定取消？')) return;
  try{
    await adminCall('adminCancel',{id});
    if (typeof window[refreshFnName] === 'function') window[refreshFnName]();
  }catch(e){ console.error(e); alert('取消失敗或尚未登入'); }
}
window.cancelRow=cancelRow;

/* ===== 預約期限 / 旗標 / 試算表 ===== */
const winStart=document.getElementById('winStart'), winEnd=document.getElementById('winEnd'),
      btnStartMinus=document.getElementById('btnStartMinus'), btnStartPlus=document.getElementById('btnStartPlus'),
      btnEndMinus=document.getElementById('btnEndMinus'), btnEndPlus=document.getElementById('btnEndPlus'),
      btnWinSet=document.getElementById('btnWinSet'), winInfo=document.getElementById('winInfo'),
      customWindowSwitch=document.getElementById('customWindowSwitch'),
      flagWeekSwitch=document.getElementById('flagWeekSwitch');

btnStartMinus.onclick=()=>{ winStart.value=Math.max(0, Number(winStart.value||0)-1); };
btnStartPlus.onclick =()=>{ winStart.value=Number(winStart.value||0)+1; };
btnEndMinus.onclick  =()=>{ winEnd.value  =Math.max(Number(winStart.value||0), Number(winEnd.value||0)-1); };
btnEndPlus.onclick   =()=>{ winEnd.value  =Number(winEnd.value||0)+1; };

btnWinSet.onclick=async ()=>{
  try{
    const params={ start:Number(winStart.value||0), end:Number(winEnd.value||0),
                   enableCustom: customWindowSwitch.checked?'YES':'NO' };
    const r=await adminCall('adminWindowSet', params);
    applyWindowInfo(r);
  }catch(e){ console.error(e); alert('設定失敗'); }
};
customWindowSwitch.onchange=()=>btnWinSet.click();

async function loadWindow(){
  const r=await adminCall('adminWindow');
  applyWindowInfo(r);
}
function applyWindowInfo(o){
  o = asObj(o);
  winStart.value=o.start!=null?o.start:2;
  winEnd.value=o.end!=null?o.end:14;
  customWindowSwitch.checked=!!o.custom;
  winInfo.textContent = `目前視窗：D+${o.start}（${o.startDate}） ～ D+${o.end}（${o.endDate}）${o.custom?'｜自訂啟用':''}`;
}

async function loadFlags(){
  const o=asObj(await adminCall('adminFlags'));
  flagWeekSwitch.checked=!!o.USE_WEEKDAY_SHIFT;
}
flagWeekSwitch.onchange=async()=>{
  try{ await adminCall('adminFlagsSet',{ USE_WEEKDAY_SHIFT: flagWeekSwitch.checked?'1':'0' }); }
  catch(e){ console.error(e); alert('旗標設定失敗'); }
};

/* ===== daily_limit（每週規則） ===== */
async function loadDaily(){
  const arr=asArr(await adminCall('dailyGet'));
  const tb=document.querySelector('#tblDaily tbody'); tb.innerHTML='';
  arr.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>星期${x.weekdayZh||''} <div class="small text-muted">${x.weekdayEn||''}</div></td>
      <td><input class="form-control form-control-sm" id="dEL-${x.row}" type="number" value="${x.limitE||0}" style="border-radius:12px;"></td>
      <td><input class="form-control form-control-sm" id="dNL-${x.row}" type="number" value="${x.limitN||0}" style="border-radius:12px;"></td>
      <td><input class="form-control form-control-sm" id="dTL-${x.row}" type="number" value="${x.limitL||0}" style="border-radius:12px;"></td>
      <td><input class="form-control form-control-sm" id="dTE-${x.row}" value="${x.timeE||''}" style="border-radius:12px;"></td>
      <td><input class="form-control form-control-sm" id="dTN-${x.row}" value="${x.timeN||''}" style="border-radius:12px;"></td>
      <td><input class="form-control form-control-sm" id="dTLt-${x.row}" value="${x.timeL||''}" style="border-radius:12px;"></td>
      <td><input class="form-control form-control-sm text-center" id="dST-${x.row}" type="number" value="${x.startNo||1}" min="1" style="width:5.5ch;border-radius:12px;"></td>
      <td><input class="form-control form-control-sm text-center" id="dSP-${x.row}" type="number" value="${x.step||1}" min="1" style="width:5.5ch;border-radius:12px;"></td>
      <td><button class="btn btn-sm btn-main" onclick="saveDaily('${x.weekdayEn}','${x.row}')">儲存</button></td>`;
    tb.appendChild(tr);
  });
}
async function saveDaily(wdEn,row){
  try{
    const q={
      wd:wdEn,
      limitE:document.getElementById(`dEL-${row}`).value,
      limitN:document.getElementById(`dNL-${row}`).value,
      limitL:document.getElementById(`dTL-${row}`).value,
      timeE: document.getElementById(`dTE-${row}`).value,
      timeN: document.getElementById(`dTN-${row}`).value,
      timeL: document.getElementById(`dTLt-${row}`).value,
      startNo:document.getElementById(`dST-${row}`).value,
      step:   document.getElementById(`dSP-${row}`).value
    };
    await adminCall('dailySet', q);
    alert('已儲存');
  }catch(e){ console.error(e); alert('儲存失敗'); }
}
window.saveDaily=saveDaily;

/* ===== 試算表捷徑 ===== */
async function loadSheetLinks(){
  const o=asObj(await adminCall('sheetLinks'));
  const card=document.getElementById('sheetsCard');
  const box=document.getElementById('sheetBtns'); box.innerHTML='';
  if(!o?.id || !Array.isArray(o.sheets)) { card.style.display='none'; return; }
  o.sheets.forEach(s=>{
    const url=`https://docs.google.com/spreadsheets/d/${o.id}/edit#gid=${s.gid}`;
    const a=document.createElement('a');
    a.className='btn btn-ghost btn-sm';
    a.href=url; a.target='_blank'; a.rel='noopener';
    a.textContent=s.name||('GID '+s.gid);
    box.appendChild(a);
  });
  card.style.display='block';
}

/* ===== special_limit：新增／讀取／刪除／編輯 ===== */
const newDate=document.getElementById('newDate');
const neEarlyLimit=document.getElementById('neEarlyLimit');
const neNoonLimit=document.getElementById('neNoonLimit');
const neNightLimit=document.getElementById('neNightLimit');
const neEarlyTime=document.getElementById('neEarlyTime');
const neNoonTime=document.getElementById('neNoonTime');
const neNightTime=document.getElementById('neNightTime');
const neApptLimit=document.getElementById('neApptLimit');      /* 約診 */
const neApptTime=document.getElementById('neApptTime');        /* 約診 */
const neNote=document.getElementById('neNote');
const neStartNo=document.getElementById('neStartNo');
const neStep=document.getElementById('neStep');
const addBtn=document.getElementById('addBtn');
const tbl=document.getElementById('tbl');

addBtn.onclick = async ()=>{
  try{
    if(!newDate.value) return alert("請選日期");
    const q={
      日期:newDate.value,
      早診上限:Number(neEarlyLimit.value||0),
      午診上限:Number(neNoonLimit.value||0),
      晚診上限:Number(neNightLimit.value||0),
      約診上限:Number(neApptLimit.value||0),            /* 約診 */
      早診時段:neEarlyTime.value||'',
      午診時段:neNoonTime.value||'',
      晚診時段:neNightTime.value||'',
      約診時段:neApptTime.value||'',                    /* 約診 */
      起始號碼:Number(neStartNo.value||1),
      間隔位數:Math.max(1,Number(neStep.value||1)),
      備註:neNote.value||''
    };
    await adminCall('adminAdd', q);
    alert("新增完成"); loadSpecials();
  }catch(e){ console.error(e); alert('新增失敗或尚未登入'); }
};

async function loadSpecials(){
  const arr=asArr(await adminCall('adminGet',{t:Date.now()}));
  const tbody=tbl.querySelector('tbody'); tbody.innerHTML="";
  arr.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${x.日期}</td>
      <td>${x.早診上限||0}</td><td>${x.午診上限||0}</td><td>${x.晚診上限||0}</td><td>${x.約診上限||0}</td>
      <td>${x.早診時段||''}</td><td>${x.午診時段||''}</td><td>${x.晚診時段||''}</td><td>${x.約診時段||''}</td>
      <td>${x.起始號碼||1}</td><td>${x.間隔位數||1}</td>
      <td>${x.備註||""}</td>
      <td class="d-flex gap-2">
        <button class="btn btn-warning btn-sm" onclick="editRow('${x.id}')">編輯</button>
        <button class="btn btn-danger btn-sm" onclick="delRow('${x.id}')">刪除</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function delRow(id){
  if(!confirm("確定刪除？")) return;
  try{ await adminCall('adminDel',{id}); loadSpecials(); }
  catch(e){ console.error(e); alert('刪除失敗或尚未登入'); }
}
async function editRow(id){
  const f=asObj(await adminCall('adminOne',{id}));
  const html=`<div class="modal fade" id="editM"><div class="modal-dialog modal-lg"><div class="modal-content">
   <div class="modal-header"><h5 class="modal-title">編輯 ${f.日期}</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
   <div class="modal-body">
     <div class="row g-2">
       <div class="col-6 col-md-3"><label class="form-label">早診上限</label><input id="edEL" class="form-control" type="number" value="${f["早診上限"]||0}" style="border-radius:14px;"></div>
       <div class="col-6 col-md-3"><label class="form-label">午診上限</label><input id="edNL" class="form-control" type="number" value="${f["午診上限"]||0}" style="border-radius:14px;"></div>
       <div class="col-6 col-md-3"><label class="form-label">晚診上限</label><input id="edTL" class="form-control" type="number" value="${f["晚診上限"]||0}" style="border-radius:14px;"></div>
       <div class="col-6 col-md-3"><label class="form-label">約診上限</label><input id="edAL" class="form-control" type="number" value="${f["約診上限"]||0}" style="border-radius:14px;"></div>

       <div class="col-12 col-md-6"><label class="form-label">早診時段</label><input id="edTE" class="form-control" value='${f["早診時段"]||""}' style="border-radius:14px;"></div>
       <div class="col-12 col-md-6"><label class="form-label">午診時段</label><input id="edTN" class="form-control" value='${f["午診時段"]||""}' style="border-radius:14px;"></div>
       <div class="col-12 col-md-6"><label class="form-label">晚診時段</label><input id="edTLt" class="form-control" value='${f["晚診時段"]||""}' style="border-radius:14px;"></div>
       <div class="col-12 col-md-6"><label class="form-label">約診時段</label><input id="edTA" class="form-control" value='${f["約診時段"]||""}' style="border-radius:14px;"></div>

       <div class="col-12 col-md-6"><label class="form-label">備註</label><input id="edNote" class="form-control" value="${f["備註"]||""}" style="border-radius:14px;"></div>
       <div class="col-6 col-md-3"><label class="form-label">起始號碼</label><input id="edStartNo" class="form-control text-center" type="number" value="${f["起始號碼"]||1}" min="1" style="border-radius:14px;"></div>
       <div class="col-6 col-md-3"><label class="form-label">間隔位數</label><input id="edStep" class="form-control text-center" type="number" value="${f["間隔位數"]||1}" min="1" style="border-radius:14px;"></div>
     </div>
     <div class="small-note mt-2">此處儲存會以 <code>adminAdd</code> 覆蓋該日期設定。</div>
   </div>
   <div class="modal-footer">
     <button class="btn btn-ghost" data-bs-dismiss="modal">取消</button>
     <button id="saveBtn" class="btn btn-main">儲存</button>
   </div>
  </div></div></div>`;
  document.body.insertAdjacentHTML('beforeend', html);
  const mEl=document.getElementById("editM"); const m=new bootstrap.Modal(mEl); m.show();
  document.getElementById("saveBtn").onclick=async()=>{
    if(!confirm("確定儲存？")) return;
    await adminCall('adminAdd',{
      日期:f.日期,
      早診上限:document.getElementById('edEL').value,
      午診上限:document.getElementById('edNL').value,
      晚診上限:document.getElementById('edTL').value,
      約診上限:document.getElementById('edAL').value,               /* 約診 */
      早診時段:document.getElementById('edTE').value,
      午診時段:document.getElementById('edTN').value,
      晚診時段:document.getElementById('edTLt').value,
      約診時段:document.getElementById('edTA').value,               /* 約診 */
      備註:document.getElementById('edNote').value,
      起始號碼:Number(document.getElementById('edStartNo').value||1),
      間隔位數:Math.max(1,Number(document.getElementById('edStep').value||1))
    });
    m.hide(); mEl.addEventListener('hidden.bs.modal', ()=> mEl.remove(), {once:true});
    loadSpecials();
  };
  mEl.addEventListener('hidden.bs.modal', ()=> mEl.remove(), {once:true});
}
window.editRow=editRow; window.delRow=delRow;

/* ===== 匯出、登入、登出 ===== */
exportBtn.onclick=()=>{ try{
  assertAuthed();
  const url = `${API}?action=export&token=${encodeURIComponent(ADMIN_TOKEN)}&t=${Date.now()}`;
  window.open(url, '_blank', 'noopener');
}catch(e){} };

logoutBtn.onclick=()=>{
  sessionStorage.removeItem('ADMIN_TOKEN');
  ADMIN_TOKEN="";
  showLogin();
};

btnLoginPW.onclick=async()=>{
  try{
    const a=acc.value.trim(), p=pw.value.trim();
    const r=await axios.get(API,{params:{action:'adminLogin',acc:a,pw:p}});
    if(r.data?.ok){
      ADMIN_TOKEN=r.data.token;
      sessionStorage.setItem('ADMIN_TOKEN',ADMIN_TOKEN);
      saveCred(a,p);
      showApp();
    }else{ alert('帳號或密碼錯誤'); }
  }catch(e){ console.error(e); alert('登入失敗'); }
};
[acc,pw].forEach(el=>el.addEventListener('keydown',e=>{ if(e.key==='Enter') btnLoginPW.click(); }));

/* ===== 進入頁 ===== */
if(ADMIN_TOKEN){ showApp(); } else { showLogin(); }
</script>
</body>
</html>




