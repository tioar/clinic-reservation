<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>陳萬龍診所預約後台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/png" href="favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#3b697d;        /* 靛藍主色 */
      --primary-dark:#2d4d5a;   /* 深色選中 */
      --secondary:#6b7a90;      /* 灰藍色 */
      --card-bg:#ffffff;
      --border:#d9dee7;
    }

    body{
      font-family:'Noto Sans TC','Microsoft JhengHei',sans-serif;
      background:linear-gradient(160deg,#ecf1f6,#e6edf6);
      min-height:100vh;
      color:#334155;
    }
    /* ===== 卡片 ===== */
    .card, .login-card .card{
      border-radius:28px !important;
      border:2px solid var(--border);
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }

    /* ===== 按鈕統一 ===== */
    .btn{
      border-radius:999px !important;
      font-weight:600;
      border:0;
    }
    .btn-main{
      background:var(--primary);
      color:#fff !important;
    }
    .btn-main:hover, .btn-main.active{
      background:var(--primary-dark);
      color:#fff !important;
    }
    .btn-outline-secondary{
      background:#94a3b8;
      color:#fff !important;
    }
    .btn-outline-secondary:hover, .btn-outline-secondary.active{
      background:#64748b;
      color:#fff !important;
    }
    .btn-danger{
      background:#dc3545;
      color:#fff !important;
    }
    .btn-danger:hover{
      background:#b02a37;
      color:#fff !important;
    }
    .btn-warning{
      background:#f59e0b;
      color:#fff !important;
    }
    .btn-warning:hover{
      background:#d97706;
      color:#fff !important;
    }

    /* ===== Login ===== */
    .login-card{ display:grid; place-items:center; min-height:calc(100vh - 6rem); padding:3rem 1rem; }
    .login-card .logo{ 
      width:40px; height:40px; border-radius:50%; 
      display:grid; place-items:center;
      background:var(--primary); color:#fff; font-weight:700; font-size:20px;
    }
    .login-card h1{ font-weight:700; }
    .login-card .form-control{ border-radius:14px; padding:.625rem .9rem; border:2px solid #d1d5db; }
    .login-card .form-control:focus{ border-color:var(--primary); box-shadow:0 0 0 .2rem rgba(59,105,125,.2); }


    /* ===== Header ===== */
    .card-head .logo{
      width:36px; height:36px; border-radius:50%;
      display:grid; place-items:center;
      background:var(--primary); color:#fff; font-weight:700;
    }

    /* ===== Table ===== */
    .table th, .table td{
      border-top:2px solid #e5e7eb !important;
    }
    .table thead th{
      border-bottom:2px solid #cbd5e1 !important;
      font-weight:700;
    }
  </style>
</head>
<body>
<!-- Login -->
<div id="login" class="container login-card">
  <div class="card p-4">
    <div class="header d-flex align-items-center gap-2 mb-3">
      <div class="logo">＋</div>
      <div>
        <h1 class="h4 m-0">後台登入</h1>
        <div class="text-muted">請輸入管理帳號與密碼</div>
      </div>
    </div>
    <label for="acc" class="form-label">帳號</label>
    <input id="acc" class="form-control mb-3" placeholder="輸入帳號" autocomplete="username">
    <label for="pw" class="form-label">管理密碼</label>
    <input id="pw" type="password" class="form-control mb-3" placeholder="輸入密碼" autocomplete="current-password">
    <button id="btnLoginPW" class="btn btn-main w-100 mb-2">登入</button>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none;">
  <div class="card-wrap container py-3">
    <div class="card-head d-flex align-items-center gap-2 mb-3">
      <div class="logo">＋</div>
      <div>
        <h3 class="m-0">後台管理</h3>
        <div class="text-muted small"><b>今天名單、明天名單、預約設定、臨時異動</b></div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="exportBtn" class="btn btn-outline-secondary btn-sm">匯出今日起預約名單</button>
        <button id="logoutBtn"  class="btn btn-main btn-sm">登出</button>
      </div>
    </div>

    <!-- 分頁 -->
    <div class="tabbar mb-3 d-flex gap-2">
      <button class="btn btn-main active" id="tabBtnToday" data-tab="tab-today">今天名單</button>
      <button class="btn btn-main" id="tabBtnTomorrow" data-tab="tab-tomorrow">明天名單</button>
      <button class="btn btn-main" id="tabBtnSettings" data-tab="tab-settings">預約設定</button>
      <button class="btn btn-main" id="tabBtnSpecial" data-tab="tab-special">臨時異動</button>

    /* ========= 共用按鈕與小元件 ========= */
    .btn-round{ border-radius:999px; }
    .btn-main{
      background:var(--primary); color:#fff; border:0; border-radius:999px;
      box-shadow:0 6px 14px rgba(63,95,165,.18);
    }
    .btn-main:hover{ background:var(--primary-600); color:#fff; }
    .btn-outline-secondary{ border-radius:999px; }
    .btn-danger{ background:var(--danger); border-color:var(--danger); }
    .btn-danger:hover{ background:var(--danger-hover); border-color:var(--danger-hover); }

    .sheet-chip{
      display:inline-block; padding:.375rem .6rem; border:1px solid var(--chip); border-radius:999px;
      color:var(--slate-600); text-decoration:none;
    }
    .small-note{ color:var(--slate-500); font-size:.925rem; }
    .small-note code{ background:#f6f6f8; padding:.1rem .25rem; border-radius:6px; }
    .tag{ display:inline-block; width:.8em; height:.8em; border-radius:2px; margin-right:.4em; vertical-align:middle; }
    .tag-early{ background:#10b981; } .tag-noon{ background:#f59e0b; } .tag-night{ background:#6366f1; }

    .date-nav{ display:flex; flex-wrap:wrap; align-items:center; gap:.5rem .5rem; }
    .date-nav .form-control{ width:160px; }
    .totals{ font-weight:800; color:#1f3f57; } .totals .muted{ color:#6b7a90; font-weight:700; }

    .card-wrap{ max-width:1180px; margin:24px auto; padding:0 12px; }
    .tabbar{ display:flex; gap:8px; margin:16px 0; }

    .w-ch-4{ width:4.5ch !important; min-width:40px; } .w-ch-3{ width:3.5ch !important; min-width:36px; }
    .text-center{ text-align:center; }

    .stat{
      border:1px dashed #d8dee9; border-radius:16px; padding:.75rem 1rem; display:flex; align-items:center; gap:.75rem; background:#fff;
    }
    .stat .cap{ font-weight:800; color:var(--slate-700); }
    .muted{ color:#94a3b8; }

    /* 表頭/標題加粗更明顯 */
    h1,h2,h3,h4,h5,th{ font-weight:800; color:var(--slate-700); }

    /* ========= Login ========= */
    .login-card{ display:grid; place-items:center; min-height:calc(100vh - 6rem); padding:3rem 1rem; }
    .login-card .card{
      width:100%; max-width:460px; background:var(--card-bg); border:0; border-radius:28px; padding:28px 24px;
      box-shadow:0 12px 24px rgba(30,79,208,.08), 0 4px 12px rgba(15,23,42,.06);
    }
    .login-card .header{ display:flex; align-items:center; gap:14px; margin-bottom:10px; }

    /* 圓形靛藍 Logo（白色＋） */
    .login-card .logo{
      width:56px; height:56px; border-radius:50%; display:grid; place-items:center;
      background:var(--primary); color:#fff; font-weight:800; font-size:28px; line-height:1;
      box-shadow:0 8px 18px rgba(63,95,165,.25);
    }

    .login-card h1{ color:var(--slate-700); }

    .login-card .form-control{
      border-radius:16px; padding:.675rem .95rem; border:1px solid #e5e7eb;
      box-shadow:inset 0 1px 0 rgba(0,0,0,.02);
    }
    .login-card .form-control:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 .2rem rgba(63,95,165,.15), 0 2px 6px rgba(0,0,0,.04);
      outline:none;
    }
    .login-card .btn-primary{
      background:var(--primary); border:0; border-radius:16px; padding:.78rem 1rem;
      box-shadow:0 10px 18px rgba(63,95,165,.18); font-weight:800;
    }
    .login-card .btn-primary:hover{ background:var(--primary-600); }
    .login-card .helper{ display:flex; justify-content:space-between; align-items:center; color:var(--slate-500); font-size:.925rem; }

    /* ========= App Header ========= */
    .card-head{ display:flex; align-items:center; gap:12px; }
    .card-head .logo{
      width:44px; height:44px; border-radius:50%; display:grid; place-items:center;
      background:var(--primary); color:#fff; font-weight:900; font-size:24px; line-height:1;
      box-shadow:0 6px 14px rgba(63,95,165,.18);
    }
    .card-head h3{ font-weight:900; }
    .card-head .subtitle{
      margin-top:2px; font-size:.95rem; color:var(--slate-600);
    }
    .card-head .subtitle b{
      color:var(--slate-900); font-weight:900;
    }

    /* 表格條紋色淡化、圓角 */
    .table{ border-radius:14px; overflow:hidden; }
    .table-striped>tbody>tr:nth-of-type(odd)>*{ --bs-table-accent-bg:#f7f9fc; }

    /* 輸入框圓角統一 */
    .form-control, .form-select, .input-group .form-control{
      border-radius:14px;
    }
    .input-group .btn{ border-radius:14px; }

    /* 小尺寸按鈕也維持圓角 */
    .btn-sm{ border-radius:12px; }
  </style>
</head>
<body>
<!-- Login -->
<div id="login" class="container login-card">
  <div class="card">
    <div class="header">
      <div class="logo">＋</div>
      <div>
        <h1 class="h4 m-0">後台登入</h1>
        <div class="small-note mt-1">請輸入管理帳號與密碼</div>
      </div>
    </div>
    <label for="acc" class="form-label small-note mb-1">帳號</label>
    <input id="acc" class="form-control mb-3" placeholder="輸入帳號" autocomplete="username">
    <label for="pw" class="form-label small-note mb-1">管理密碼</label>
    <input id="pw" type="password" class="form-control mb-3" placeholder="輸入密碼" autocomplete="current-password">
    <button id="btnLoginPW" class="btn btn-primary w-100 mb-2">登入</button>
    <div class="helper"><span>忘記密碼？請聯絡管理者</span></div>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none;">
  <div class="card-wrap">
    <div class="card-head">
      <div class="logo">＋</div>
      <div>
        <h3 class="m-0">後台管理</h3>
        <!-- 注意事項置於標題下方（樣式一致） -->
        <div class="subtitle"><b>注意事項</b>：今天名單、明天名單、預約設定、臨時異動</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="exportBtn" class="btn btn-outline-secondary btn-round btn-sm">匯出今日起預約名單</button>
        <button id="logoutBtn"  class="btn-main btn-round btn-sm">登出</button>
      </div>
    </div>

    <!-- 分頁 -->
    <div class="tabbar">
      <button class="btn btn-main" id="tabBtnToday" data-tab="tab-today">今天名單</button>
      <button class="btn btn-outline-secondary" id="tabBtnTomorrow" data-tab="tab-tomorrow">明天名單</button>
      <button class="btn btn-outline-secondary" id="tabBtnSettings" data-tab="tab-settings">預約設定</button>
      <button class="btn btn-outline-secondary" id="tabBtnSpecial" data-tab="tab-special">臨時異動</button>
    </div>

    <!-- ====== 今天名單（可切任意日期） ====== -->
    <section id="tab-today">
      <div class="card mb-3 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0">今天名單</h5>
            <div id="todayInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTodayReload" class="btn btn-outline-secondary btn-round btn-sm">重新整理</button></div>
        </div>
        <div class="date-nav mt-2">
          <button id="tPrev" class="btn btn-outline-secondary btn-sm">◄ 前一天</button>
          <input id="tDate" type="date" class="form-control form-control-sm">
          <button id="tNext" class="btn btn-outline-secondary btn-sm">後一天 ►</button>
          <button id="tToday" class="btn btn-outline-secondary btn-sm">今天</button>
          <button id="tTomorrow" class="btn btn-outline-secondary btn-sm">明天</button>
          <div class="ms-2 totals">
            <span class="muted">總計：</span><span id="tTotals">—</span>
          </div>
        </div>
        <div id="todayStats" class="row g-3 mt-2"></div>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblToday">
            <thead>
              <tr>
                <th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th>
                <th>身分證</th><th>電話</th><th>建立時間</th><th style="width:90px;">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 明天名單（預設=明天，也可切換日期） ====== -->
    <section id="tab-tomorrow" style="display:none;">
      <div class="card mb-3 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0">明天名單</h5>
            <div id="tomorrowInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTomorrowReload" class="btn btn-outline-secondary btn-round btn-sm">重新整理</button></div>
        </div>
        <div class="date-nav mt-2">
          <button id="mPrev" class="btn btn-outline-secondary btn-sm">◄ 前一天</button>
          <input id="mDate" type="date" class="form-control form-control-sm">
          <button id="mNext" class="btn btn-outline-secondary btn-sm">後一天 ►</button>
          <button id="mToday" class="btn btn-outline-secondary btn-sm">今天</button>
          <button id="mTomorrow" class="btn btn-outline-secondary btn-sm">明天</button>
          <div class="ms-2 totals"><span class="muted">總計：</span><span id="mTotals">—</span></div>
        </div>
        <div id="tomorrowStats" class="row g-3 mt-2"></div>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblTomorrow">
            <thead>
              <tr>
                <th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th>
                <th>身分證</th><th>電話</th><th>建立時間</th><th style="width:90px;">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 預約設定 ====== -->
    <section id="tab-settings" style="display:none;">
      <div class="card mb-4 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="m-0">預約期限</h5>
          <div class="small-note">顯示區間 = 今天 + 起始天 ～ 今天 + 結束天</div>
        </div>
        <div id="winInfo" class="small-note my-2"></div>

        <div class="d-flex flex-wrap align-items-center gap-4">
          <div>
            <div class="small-note mb-1">起始天</div>
            <div class="input-group" style="max-width:200px;">
              <button class="btn btn-outline-secondary" id="btnStartMinus">－</button>
              <input id="winStart" inputmode="numeric" type="number" class="form-control text-center no-spinner" value="2">
              <button class="btn btn-outline-secondary" id="btnStartPlus">＋</button>
            </div>
          </div>
          <div>
            <div class="small-note mb-1">結束天</div>
            <div class="input-group" style="max-width:200px;">
              <button class="btn btn-outline-secondary" id="btnEndMinus">－</button>
              <input id="winEnd" inputmode="numeric" type="number" class="form-control text-center no-spinner" value="14">
              <button class="btn btn-outline-secondary" id="btnEndPlus">＋</button>
            </div>
          </div>
          <div class="d-flex align-items-end">
            <button id="btnWinSet" class="btn-main btn-round">套用</button>
          </div>
        </div>

        <div class="form-check form-switch mt-3">
          <input class="form-check-input" type="checkbox" role="switch" id="customWindowSwitch">
          <label class="form-check-label small-note" for="customWindowSwitch">
            使用自訂日期區間（上方 D+起始～D+結束）。關閉時使用系統預設規則。
          </label>
        </div>

        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" role="switch" id="flagWeekSwitch">
          <label class="form-check-label small-note" for="flagWeekSwitch">
            啟用「預設星期規律」提示旗標（供前端面板使用）。
          </label>
        </div>

        <div class="small-note mt-2">
          若要「奇數／偶數」：在下方每天規則設定 <code>起始號碼</code>（1=奇，2=偶）與 <code>間隔位數</code>（設 2）。
        </div>
      </div>

      <div class="card mb-4 p-3">
        <h5 class="mb-2">每週規則（daily_limit）</h5>
        <div class="table-responsive">
          <table class="table align-middle" id="tblDaily">
            <colgroup>
              <col style="width:120px;">
              <col style="width:80px;"><col style="width:80px;"><col style="width:80px;">
              <col style="width:200px;"><col style="width:200px;"><col style="width:200px;">
              <col style="width:96px;"><col style="width:96px;"><col style="width:96px;">
            </colgroup>
            <thead>
              <tr>
                <th>星期</th>
                <th>早診上限</th><th>午診上限</th><th>晚診上限</th>
                <th>早診時間</th><th>午診時間</th><th>晚診時間</th>
                <th>起始號碼</th><th>間隔位數</th><th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">時間格式：08:30~11:30 ｜ 奇數：起始=1、間隔=2；偶數：起始=2、間隔=2；連號：起始=1、間隔=1。</div>
      </div>

      <div class="card p-3" id="sheetsCard" style="display:none;">
        <h5 class="mb-2">試算表捷徑</h5>
        <div id="sheetBtns" class="d-flex flex-wrap gap-2"></div>
        <div class="text-muted small mt-2">（需有該試算表權限；會在新分頁開啟）</div>
      </div>
    </section>

    <!-- ====== 臨時異動 ====== -->
    <section id="tab-special" style="display:none;">
      <div class="card mb-4 p-3">
        <h5 class="mb-3">新增臨時異動</h5>
        <input type="date" id="newDate" class="form-control mb-3">

        <div class="row g-2 align-items-center">
          <div class="col-12 col-md-3"><span class="tag tag-early"></span><strong>早診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neEarlyLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-6 col-md-6"><input id="neEarlyTime"  value=""   class="form-control" placeholder="早診時段，例如 08:30~11:30"></div>
        </div>

        <div class="row g-2 align-items-center mt-1">
          <div class="col-12 col-md-3"><span class="tag tag-noon"></span><strong>午診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neNoonLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-6 col-md-6"><input id="neNoonTime"  value=""   class="form-control" placeholder="午診時段，例如 14:00~17:00"></div>
        </div>

        <div class="row g-2 align-items-center mt-1">
          <div class="col-12 col-md-3"><span class="tag tag-night"></span><strong>晚診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neNightLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-6 col-md-6"><input id="neNightTime" value=""   class="form-control" placeholder="晚診時段，例如 18:00~20:30"></div>
        </div>

        <div class="row g-2 align-items-end mt-2">
          <div class="col-6 col-md-3">
            <label class="small-note">起始號碼</label>
            <input id="neStartNo" type="number" class="form-control w-ch-4 text-center" value="1" min="1">
          </div>
          <div class="col-6 col-md-3">
            <label class="small-note">間隔位數</label>
            <input id="neStep" type="number" class="form-control w-ch-4 text-center" value="1" min="1">
          </div>
          <div class="col-12 col-md-6">
            <label class="small-note">備註</label>
            <div class="d-flex gap-2">
              <input id="neNote" placeholder="備註" class="form-control">
              <button id="addBtn" class="btn-main btn-round">新增</button>
            </div>
          </div>
        </div>
        <div class="small-note mt-2">時間格式：08:30~11:30 ｜ 奇數／偶數：起始=1／2、間隔=2。</div>
      </div>

      <div class="card p-3">
        <h5 class="mb-2">目前異動（未過期）</h5>
        <div class="table-responsive">
          <table class="table table-striped" id="tbl">
            <colgroup>
              <col style="width:110px;">
              <col style="width:80px;"><col style="width:80px;"><col style="width:80px;">
              <col style="width:160px;"><col style="width:160px;"><col style="width:160px;">
              <col style="width:90px;"><col style="width:90px;">
              <col style="width:200px;">
              <col style="width:220px;">
            </colgroup>
            <thead>
              <tr>
                <th>日期</th>
                <th>早診上限</th><th>午診上限</th><th>晚診上限</th>
                <th>早診時段</th><th>午診時段</th><th>晚診時段</th>
                <th>起始號碼</th><th>間隔位數</th>
                <th>備註</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
/* ===== API 與共用 ===== */
const API = "https://script.google.com/macros/s/AKfycbytApGzDwZ7RFeKegXWTa577PjQpwtMnuRGFdbMKHcW0Ib8IPNiDLBMtzRWnK5dS7-j/exec";

const loginBox=document.getElementById('login'), appBox=document.getElementById('app');
const acc=document.getElementById('acc'), pw=document.getElementById('pw'), btnLoginPW=document.getElementById('btnLoginPW');
const logoutBtn=document.getElementById('logoutBtn'), exportBtn=document.getElementById('exportBtn');

const tabBtnToday=document.getElementById('tabBtnToday'),
      tabBtnTomorrow=document.getElementById('tabBtnTomorrow'),
      tabBtnSettings=document.getElementById('tabBtnSettings'),
      tabBtnSpecial=document.getElementById('tabBtnSpecial');

const views={
  'tab-today':document.getElementById('tab-today'),
  'tab-tomorrow':document.getElementById('tab-tomorrow'),
  'tab-settings':document.getElementById('tab-settings'),
  'tab-special':document.getElementById('tab-special')
};
function switchTab(id){
  [tabBtnToday,tabBtnTomorrow,tabBtnSettings,tabBtnSpecial].forEach(b=>{
    const a=(b.dataset.tab||b.id.replace('tabBtn','tab-'))===id;
    b.classList.toggle('btn-main',a);
    b.classList.toggle('btn-outline-secondary',!a);
  });
  Object.entries(views).forEach(([k,el])=>el.style.display=(k===id?'block':'none'));
}
let ADMIN_TOKEN=sessionStorage.getItem('ADMIN_TOKEN')||"";
function showApp(){ loginBox.style.display="none"; appBox.style.display="block"; switchTab('tab-today'); initTodayTab(); }
function showLogin(){ appBox.style.display="none"; loginBox.style.display="block"; }
function assertAuthed(){ if(!ADMIN_TOKEN){ showLogin(); throw new Error('no token'); } }
function ymdLocal(d){ const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2); return `${y}-${m}-${da}`; }
function addDays(ymd,delta){ const d=new Date(ymd); d.setDate(d.getDate()+delta); return ymdLocal(d); }
function todayYmd(){ return ymdLocal(new Date()); }
function asObj(p){ try{ return typeof p==='string'?JSON.parse(p):(p||{});}catch{ return {}; } }
function asArr(p){ try{ if(typeof p==='string') p=JSON.parse(p);}catch{} if(Array.isArray(p))return p; if(Array.isArray(p?.rows))return p.rows; if(Array.isArray(p?.items))return p.items; if(Array.isArray(p?.data))return p.data; return []; }
function num(x){ const n=Number(x); return isFinite(n)?n:0; }

/* ===== 登入／登出／Tab 切換 ===== */
btnLoginPW.onclick = async ()=>{
  try{
    const a=(acc.value||'').trim(), p=(pw.value||'').trim();
    if(!a||!p) return;
    const r=await axios.get(API,{params:{action:'adminLogin',acc:a,pw:p,t:Date.now()}});
    if(r.data?.ok){
      ADMIN_TOKEN=r.data.token; sessionStorage.setItem('ADMIN_TOKEN',ADMIN_TOKEN); showApp();
    }else{
      alert(r.data?.message||'帳號或密碼錯誤');
    }
  }catch(e){ console.error(e); alert('登入失敗'); }
};
[acc,pw].forEach(el=>el.addEventListener('keydown',e=>{ if(e.key==='Enter') btnLoginPW.click(); }));
logoutBtn.onclick=()=>{ ADMIN_TOKEN=""; sessionStorage.removeItem('ADMIN_TOKEN'); showLogin(); };
exportBtn.onclick=()=>{ assertAuthed(); window.open(`${API}?action=export&token=${encodeURIComponent(ADMIN_TOKEN)}`,'_blank'); };
[tabBtnToday,tabBtnTomorrow,tabBtnSettings,tabBtnSpecial].forEach(btn=>{
  btn.onclick=async()=>{
    const id=btn.dataset.tab; switchTab(id);
    try{
      if(id==='tab-today'){ await initTodayTab(); }
      if(id==='tab-tomorrow'){ await initTomorrowTab(); }
      if(id==='tab-settings'){ await Promise.all([loadWindow(),loadDaily(),loadSheetLinks(),loadFlags()]); }
      if(id==='tab-special'){ await loadSpecials(); }
    }catch(e){ console.error(e); }
  };
});

/* ===== 共用：渲染統計 + 表格 ===== */
function renderStats(containerId, slots){
  const box=document.getElementById(containerId); box.innerHTML='';
  const frag=document.createDocumentFragment();
  slots.forEach(s=>{
    const col=document.createElement('div'); col.className='col-12 col-md-4';
    col.innerHTML=`
      <div class="stat">
        <div class="cap">${s.label}</div>
        <div class="flex-grow-1">
          <div class="small-note mb-1">${s.time||''}</div>
          <div><b>${num(s.used)}</b> / ${num(s.limit)} <span class="muted">（起始 ${num(s.startNo)}，間隔 ${num(s.step)}）</span></div>
        </div>
      </div>`;
    frag.appendChild(col);
  });
  box.appendChild(frag);
}
function renderItems(tableId, items, refreshFnName){
  const tb=document.querySelector(`#${tableId} tbody`); tb.innerHTML='';
  items.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${x.slot||''}</td>
      <td>${x.time||''}</td>
      <td>${x.num||''}</td>
      <td>${x.name||''}</td>
      <td>${x.birthday||''}</td>
      <td>${x.pid||''}</td>
      <td>${x.phone||''}</td>
      <td>${x.createdAt||''}</td>
      <td>
        <button class="btn btn-danger btn-sm btn-round" onclick="cancelRow(${x.id}, '${refreshFnName}')">取消</button>
      </td>`;
    tb.appendChild(tr);
  });
}

/* ===== 今天 / 明天（其實都用 adminDay，可切日期） ===== */
const tDate=document.getElementById('tDate'), tPrev=document.getElementById('tPrev'), tNext=document.getElementById('tNext'),
      tToday=document.getElementById('tToday'), tTomorrow=document.getElementById('tTomorrow'),
      todayInfo=document.getElementById('todayInfo'), tTotals=document.getElementById('tTotals');

const mDate=document.getElementById('mDate'), mPrev=document.getElementById('mPrev'), mNext=document.getElementById('mNext'),
      mToday=document.getElementById('mToday'), mTomorrow=document.getElementById('mTomorrow'),
      tomorrowInfo=document.getElementById('tomorrowInfo'), mTotals=document.getElementById('mTotals');

document.getElementById('btnTodayReload').onclick=()=>initTodayTab();
document.getElementById('btnTomorrowReload').onclick=()=>initTomorrowTab();

tPrev.onclick=()=>{ tDate.value=addDays(tDate.value||todayYmd(), -1); initTodayTab(); };
tNext.onclick=()=>{ tDate.value=addDays(tDate.value||todayYmd(), +1); initTodayTab(); };
tToday.onclick=()=>{ tDate.value=todayYmd(); initTodayTab(); };
tTomorrow.onclick=()=>{ tDate.value=addDays(todayYmd(), +1); initTodayTab(); };
mPrev.onclick=()=>{ mDate.value=addDays(mDate.value||addDays(todayYmd(),1), -1); initTomorrowTab(); };
mNext.onclick=()=>{ mDate.value=addDays(mDate.value||addDays(todayYmd(),1), +1); initTomorrowTab(); };
mToday.onclick=()=>{ mDate.value=todayYmd(); initTomorrowTab(); };
mTomorrow.onclick=()=>{ mDate.value=addDays(todayYmd(), +1); initTomorrowTab(); };

async function loadDay(dateStr, infoEl, totalsEl, statsContainerId, tableId){
  assertAuthed();
  const r=await axios.get(API,{params:{action:'adminDay', token:ADMIN_TOKEN, date:dateStr}});
  const d=asObj(r.data);
  infoEl.textContent = `${d.date||''}（${d.weekday||''}）`;
  totalsEl.textContent = Array.isArray(d.items)? d.items.length : 0;
  renderStats(statsContainerId, d.slots||[]);
  renderItems(tableId, d.items||[], tableId==='tblToday'?'initTodayTab':'initTomorrowTab');
}
async function initTodayTab(){
  if(!tDate.value) tDate.value=todayYmd();
  await loadDay(tDate.value, todayInfo, tTotals, 'todayStats', 'tblToday');
}
async function initTomorrowTab(){
  if(!mDate.value) mDate.value=addDays(todayYmd(),1);
  await loadDay(mDate.value, tomorrowInfo, mTotals, 'tomorrowStats', 'tblTomorrow');
}

/* ===== 取消（管理端） ===== */
async function cancelRow(id, refreshFnName){
  if(!confirm('確定取消？')) return;
  try{
    assertAuthed();
    await axios.get(API,{params:{action:'adminCancel', id, token:ADMIN_TOKEN}});
    if (typeof window[refreshFnName] === 'function') {
      window[refreshFnName]();
    }
  }catch(e){ console.error(e); alert('取消失敗或尚未登入'); }
}
window.cancelRow=cancelRow;

/* ===== 預約期限 / 旗標 / 試算表 ===== */
const winStart=document.getElementById('winStart'), winEnd=document.getElementById('winEnd'),
      btnStartMinus=document.getElementById('btnStartMinus'), btnStartPlus=document.getElementById('btnStartPlus'),
      btnEndMinus=document.getElementById('btnEndMinus'), btnEndPlus=document.getElementById('btnEndPlus'),
      btnWinSet=document.getElementById('btnWinSet'), winInfo=document.getElementById('winInfo'),
      customWindowSwitch=document.getElementById('customWindowSwitch'),
      flagWeekSwitch=document.getElementById('flagWeekSwitch');

btnStartMinus.onclick=()=>{ winStart.value=Math.max(0, num(winStart.value)-1); };
btnStartPlus.onclick =()=>{ winStart.value=num(winStart.value)+1; };
btnEndMinus.onclick  =()=>{ winEnd.value  =Math.max(num(winStart.value), num(winEnd.value)-1); };
btnEndPlus.onclick   =()=>{ winEnd.value  =num(winEnd.value)+1; };

btnWinSet.onclick=async ()=>{
  try{
    assertAuthed();
    const params={ action:'adminWindowSet', token:ADMIN_TOKEN,
      start:Number(winStart.value||0), end:Number(winEnd.value||0),
      enableCustom: customWindowSwitch.checked?'YES':'NO'
    };
    const r=await axios.get(API,{params});
    applyWindowInfo(r.data);
  }catch(e){ console.error(e); alert('設定失敗'); }
};
customWindowSwitch.onchange=()=>btnWinSet.click();

async function loadWindow(){
  assertAuthed();
  const r=await axios.get(API,{params:{action:'adminWindow', token:ADMIN_TOKEN}});
  applyWindowInfo(r.data);
}
function applyWindowInfo(d){
  const o=asObj(d);
  winStart.value=o.start!=null?o.start:2;
  winEnd.value=o.end!=null?o.end:14;
  customWindowSwitch.checked=!!o.custom;
  winInfo.textContent = `目前視窗：D+${o.start}（${o.startDate}） ～ D+${o.end}（${o.endDate}）${o.custom?'｜自訂啟用':''}`;
}

async function loadFlags(){
  assertAuthed();
  const r=await axios.get(API,{params:{action:'adminFlags', token:ADMIN_TOKEN}});
  const o=asObj(r.data);
  flagWeekSwitch.checked=!!o.USE_WEEKDAY_SHIFT;
}
flagWeekSwitch.onchange=async()=>{
  try{
    assertAuthed();
    await axios.get(API,{params:{action:'adminFlagsSet', token:ADMIN_TOKEN, USE_WEEKDAY_SHIFT: flagWeekSwitch.checked?'1':'0'}});
  }catch(e){ console.error(e); alert('旗標設定失敗'); }
};

/* ===== daily_limit（每週規則） ===== */
async function loadDaily(){
  assertAuthed();
  const r=await axios.get(API,{params:{action:'dailyGet', token:ADMIN_TOKEN}});
  const arr=asArr(r.data);
  const tb=document.querySelector('#tblDaily tbody'); tb.innerHTML='';
  arr.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>星期${x.weekdayZh||''} <div class="small text-muted">${x.weekdayEn||''}</div></td>
      <td><input class="form-control form-control-sm" id="dEL-${x.row}" type="number" value="${x.limitE||0}"></td>
      <td><input class="form-control form-control-sm" id="dNL-${x.row}" type="number" value="${x.limitN||0}"></td>
      <td><input class="form-control form-control-sm" id="dTL-${x.row}" type="number" value="${x.limitL||0}"></td>
      <td><input class="form-control form-control-sm" id="dTE-${x.row}" value="${x.timeE||''}"></td>
      <td><input class="form-control form-control-sm" id="dTN-${x.row}" value="${x.timeN||''}"></td>
      <td><input class="form-control form-control-sm" id="dTLt-${x.row}" value="${x.timeL||''}"></td>
      <td><input class="form-control form-control-sm w-ch-4 text-center" id="dST-${x.row}" type="number" value="${x.startNo||1}" min="1"></td>
      <td><input class="form-control form-control-sm w-ch-4 text-center" id="dSP-${x.row}" type="number" value="${x.step||1}" min="1"></td>
      <td><button class="btn btn-sm btn-main btn-round" onclick="saveDaily('${x.weekdayEn}','${x.row}')">儲存</button></td>`;
    tb.appendChild(tr);
  });
}
async function saveDaily(wdEn,row){
  try{
    assertAuthed();
    const q={
      action:'dailySet', token:ADMIN_TOKEN, wd:wdEn,
      limitE:document.getElementById(`dEL-${row}`).value,
      limitN:document.getElementById(`dNL-${row}`).value,
      limitL:document.getElementById(`dTL-${row}`).value,
      timeE: document.getElementById(`dTE-${row}`).value,
      timeN: document.getElementById(`dTN-${row}`).value,
      timeL: document.getElementById(`dTLt-${row}`).value,
      startNo:document.getElementById(`dST-${row}`).value,
      step:   document.getElementById(`dSP-${row}`).value
    };
    await axios.get(API,{params:q});
    alert('已儲存');
  }catch(e){ console.error(e); alert('儲存失敗'); }
}
window.saveDaily=saveDaily;

/* ===== 試算表捷徑 ===== */
async function loadSheetLinks(){
  assertAuthed();
  const r=await axios.get(API,{params:{action:'sheetLinks', token:ADMIN_TOKEN}});
  const o=asObj(r.data);
  const card=document.getElementById('sheetsCard');
  const box=document.getElementById('sheetBtns'); box.innerHTML='';
  if(!o?.id || !Array.isArray(o.sheets)) { card.style.display='none'; return; }
  o.sheets.forEach(s=>{
    const url=`https://docs.google.com/spreadsheets/d/${o.id}/edit#gid=${s.gid}`;
    const a=document.createElement('a');
    a.className='sheet-chip'; a.href=url; a.target='_blank'; a.rel='noopener';
    a.textContent=s.name||('GID '+s.gid);
    box.appendChild(a);
  });
  card.style.display='block';
}

/* ===== special_limit：新增／讀取／刪除／編輯 ===== */
const newDate=document.getElementById('newDate');
const neEarlyLimit=document.getElementById('neEarlyLimit');
const neNoonLimit=document.getElementById('neNoonLimit');
const neNightLimit=document.getElementById('neNightLimit');
const neEarlyTime=document.getElementById('neEarlyTime');
const neNoonTime=document.getElementById('neNoonTime');
const neNightTime=document.getElementById('neNightTime');
const neNote=document.getElementById('neNote');
const neStartNo=document.getElementById('neStartNo');
const neStep=document.getElementById('neStep');
const addBtn=document.getElementById('addBtn');
const tbl=document.getElementById('tbl');

addBtn.onclick = async ()=>{
  try{
    assertAuthed();
    if(!newDate.value) return alert("請選日期");
    const q={
      action:'adminAdd', token:ADMIN_TOKEN,
      日期:newDate.value,
      早診上限:Number(neEarlyLimit.value||0),
      午診上限:Number(neNoonLimit.value||0),
      晚診上限:Number(neNightLimit.value||0),
      早診時段:neEarlyTime.value||'',
      午診時段:neNoonTime.value||'',
      晚診時段:neNightTime.value||'',
      起始號碼:Number(neStartNo.value||1),
      間隔位數:Math.max(1,Number(neStep.value||1)),
      備註:neNote.value||''
    };
    await axios.get(API,{params:q});
    alert("新增完成"); loadSpecials();
  }catch(e){ console.error(e); alert('新增失敗或尚未登入'); }
};

async function loadSpecials(){
  assertAuthed();
  const r=await axios.get(API,{params:{action:'adminGet',token:ADMIN_TOKEN,t:Date.now()}});
  const arr=asArr(r.data);
  const tbody=tbl.querySelector('tbody'); tbody.innerHTML="";
  arr.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${x.日期}</td>
      <td>${x.早診上限||0}</td><td>${x.午診上限||0}</td><td>${x.晚診上限||0}</td>
      <td>${x.早診時段||''}</td><td>${x.午診時段||''}</td><td>${x.晚診時段||''}</td>
      <td>${x.起始號碼||1}</td><td>${x.間隔位數||1}</td>
      <td>${x.備註||""}</td>
      <td class="d-flex gap-2">
        <button class="btn btn-warning btn-sm btn-round" onclick="editRow('${x.id}')">編輯</button>
        <button class="btn btn-danger btn-sm btn-round" onclick="delRow('${x.id}')">刪除</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function delRow(id){
  if(!confirm("確定刪除？")) return;
  try{ assertAuthed(); await axios.get(API,{params:{action:'adminDel',id,token:ADMIN_TOKEN}}); loadSpecials(); }
  catch(e){ console.error(e); alert('刪除失敗或尚未登入'); }
}

async function editRow(id){
  assertAuthed();
  const d=await axios.get(API,{params:{action:'adminOne',id,token:ADMIN_TOKEN}});
  const f=asObj(d.data);
  const html=`<div class="modal fade" id="editM"><div class="modal-dialog modal-lg"><div class="modal-content">
   <div class="modal-header"><h5 class="modal-title">編輯 ${f.日期}</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
   <div class="modal-body">
     <div class="row g-2">
       <div class="col-6 col-md-3"><label class="form-label">早診上限</label><input id="edEL" class="form-control" type="number" value="${f["早診上限"]||0}"></div>
       <div class="col-6 col-md-3"><label class="form-label">午診上限</label><input id="edNL" class="form-control" type="number" value="${f["午診上限"]||0}"></div>
       <div class="col-6 col-md-3"><label class="form-label">晚診上限</label><input id="edTL" class="form-control" type="number" value="${f["晚診上限"]||0}"></div>
       <div class="col-12 col-md-6"><label class="form-label">早診時段</label><input id="edTE" class="form-control" value='${f["早診時段"]||""}'></div>
       <div class="col-12 col-md-6"><label class="form-label">午診時段</label><input id="edTN" class="form-control" value='${f["午診時段"]||""}'></div>
       <div class="col-12 col-md-6"><label class="form-label">晚診時段</label><input id="edTLt" class="form-control" value='${f["晚診時段"]||""}'></div>
       <div class="col-12 col-md-6"><label class="form-label">備註</label><input id="edNote" class="form-control" value="${f["備註"]||""}"></div>
       <div class="col-6 col-md-3"><label class="form-label">起始號碼</label><input id="edStartNo" class="form-control w-ch-4 text-center" type="number" value="${f["起始號碼"]||1}" min="1"></div>
       <div class="col-6 col-md-3"><label class="form-label">間隔位數</label><input id="edStep" class="form-control w-ch-4 text-center" type="number" value="${f["間隔位數"]||1}" min="1"></div>
     </div>
     <div class="small-note mt-2">此處儲存會以 <code>adminAdd</code> 覆蓋該日期設定。</div>
   </div>
   <div class="modal-footer">
     <button class="btn btn-outline-secondary btn-round" data-bs-dismiss="modal">取消</button>
     <button id="saveBtn" class="btn-main btn-round">儲存</button>
   </div>
  </div></div></div>`;
  document.body.insertAdjacentHTML('beforeend', html);
  const mEl=document.getElementById("editM"); const m=new bootstrap.Modal(mEl); m.show();
  document.getElementById("saveBtn").onclick=async()=>{
    if(!confirm("確定儲存？")) return;
    await axios.get(API,{params:{
      action:'adminAdd', token:ADMIN_TOKEN, 日期:f.日期,
      早診上限:document.getElementById('edEL').value,
      午診上限:document.getElementById('edNL').value,
      晚診上限:document.getElementById('edTL').value,
      早診時段:document.getElementById('edTE').value,
      午診時段:document.getElementById('edTN').value,
      晚診時段:document.getElementById('edTLt').value,
      備註:document.getElementById('edNote').value,
      起始號碼:Number(document.getElementById('edStartNo').value||1),
      間隔位數:Math.max(1,Number(document.getElementById('edStep').value||1))
    }});
    m.hide(); mEl.addEventListener('hidden.bs.modal', ()=> mEl.remove(), {once:true});
    loadSpecials();
  };
  mEl.addEventListener('hidden.bs.modal', ()=> mEl.remove(), {once:true});
}
window.editRow=editRow; window.delRow=delRow;

/* ===== 進入頁 ===== */
if(ADMIN_TOKEN){ showApp(); }
</script>
</body>
</html>


