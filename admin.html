<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>陳萬龍診所預約後台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    /* 主要寬度與卡片 */
    .card-wrap{ max-width:1180px; margin:40px auto; }
    .card-wrap .card{ max-width:100% !important; margin:16px 0; }

    /* tabs 與小字 */
    .tabbar{display:flex;flex-wrap:wrap;gap:.5rem;margin:8px 0 16px}
    .tabbar .btn{border-radius:999px}
    .small-note{font-size:.9rem;color:#6b7a90}
    .table td,.table th{vertical-align:middle}

    /* number 隱藏上下箭頭 */
    .card-wrap input[type=number]::-webkit-outer-spin-button,
    .card-wrap input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .card-wrap input[type=number]{ -moz-appearance:textfield; }

    /* 每週規則欄寬（避免要拉橫向捲軸） */
    #tblDaily th, #tblDaily td{ white-space: normal; }
    #tblDaily .td-limit   { width:80px;  }
    #tblDaily .td-start   { width:90px;  }
    #tblDaily .td-action  { width:96px;  }
    #tblDaily .td-time    { width:200px; }
    #tblDaily .td-limit  .form-control{ max-width:64px; text-align:center; padding:.25rem .4rem; }
    #tblDaily .td-start  .form-control{ max-width:72px; text-align:center; padding:.25rem .4rem; }
    #tblDaily .td-time   .form-control{ width:100%; padding:.25rem .5rem; }

    /* 今天/明天名單的表格維持不換行，避免擠爆 */
    #tblToday th,#tblToday td,
    #tblTomorrow th,#tblTomorrow td{ white-space: nowrap; }
  </style>
</head>
<body>

<!-- ====== Login ====== -->
<div id="login" class="container py-5 login-card">
  <div class="card">
    <div class="header">
      <div class="logo">＋</div>
      <h1>後台登入</h1>
    </div>
    <input id="acc" class="form-control mb-2" placeholder="帳號">
    <input id="pw" type="password" class="form-control mb-3" placeholder="管理密碼">
    <button id="btnLoginPW" class="btn btn-outline-secondary w-100">登入</button>
  </div>
</div>

<!-- ====== App ====== -->
<div id="app" style="display:none;">
  <div class="card-wrap">
    <div class="card-head d-flex align-items-center gap-2">
      <div class="logo">＋</div>
      <div>
        <h3 class="m-0">後台管理</h3>
        <div class="subtitle">今天名單、明天名單、預約設定、臨時異動</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="exportBtn" class="btn btn-outline-secondary btn-round btn-sm">匯出今日起預約名單</button>
        <button id="logoutBtn"  class="btn-main btn-round btn-sm">登出</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabbar">
      <button class="btn btn-main"                id="tabBtnToday"     data-tab="tab-today">今天名單</button>
      <button class="btn btn-outline-secondary"   id="tabBtnTomorrow"  data-tab="tab-tomorrow">明天名單</button>
      <button class="btn btn-outline-secondary"   id="tabBtnSettings"  data-tab="tab-settings">預約設定</button>
      <button class="btn btn-outline-secondary"   id="tabBtnSpecial"   data-tab="tab-special">臨時異動</button>
    </div>

    <!-- ====== 今天名單 ====== -->
    <section id="tab-today">
      <div class="card mb-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0">今天名單</h5>
            <div id="todayInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTodayReload" class="btn btn-outline-secondary btn-round btn-sm">重新整理</button></div>
        </div>
        <div id="todayStats" class="row g-3 mt-2"></div>
      </div>

      <div class="card">
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblToday">
            <thead>
              <tr>
                <th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th>
                <th>身分證</th><th>電話</th><th>建立時間</th><th style="width:90px;">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 明天名單 ====== -->
    <section id="tab-tomorrow" style="display:none;">
      <div class="card mb-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0">明天名單</h5>
            <div id="tomorrowInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTomorrowReload" class="btn btn-outline-secondary btn-round btn-sm">重新整理</button></div>
        </div>
        <div id="tomorrowStats" class="row g-3 mt-2"></div>
      </div>

      <div class="card">
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblTomorrow">
            <thead>
              <tr>
                <th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th>
                <th>身分證</th><th>電話</th><th>建立時間</th><th style="width:90px;">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 預約設定 ====== -->
    <section id="tab-settings" style="display:none;">
      <div class="card mb-4">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="m-0">預約期限</h5>
          <div class="small-note">顯示區間 = 今天 + 起始天 ～ 今天 + 結束天</div>
        </div>
        <div id="winInfo" class="small-note my-2"></div>

        <div class="d-flex flex-wrap align-items-center gap-4">
          <div>
            <div class="small-note mb-1">起始天</div>
            <div class="input-group" style="max-width:200px;">
              <button class="btn btn-outline-secondary" id="btnStartMinus">－</button>
              <input id="winStart" inputmode="numeric" type="number" class="form-control text-center no-spinner" value="2">
              <button class="btn btn-outline-secondary" id="btnStartPlus">＋</button>
            </div>
          </div>
          <div>
            <div class="small-note mb-1">結束天</div>
            <div class="input-group" style="max-width:200px;">
              <button class="btn btn-outline-secondary" id="btnEndMinus">－</button>
              <input id="winEnd" inputmode="numeric" type="number" class="form-control text-center no-spinner" value="14">
              <button class="btn btn-outline-secondary" id="btnEndPlus">＋</button>
            </div>
          </div>
          <div class="d-flex align-items-end">
            <button id="btnWinSet" class="btn-main btn-round">套用</button>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <h5 class="mb-2">每週規則（daily_limit）</h5>
        <div class="table-responsive">
          <table class="table align-middle" id="tblDaily">
            <colgroup>
              <col style="width:120px;">
              <col style="width:80px;">
              <col style="width:80px;">
              <col style="width:80px;">
              <col style="width:200px;">
              <col style="width:200px;">
              <col style="width:200px;">
              <col style="width:90px;">
              <col style="width:96px;">
            </colgroup>
            <thead>
              <tr>
                <th>星期</th>
                <th>早診上限</th><th>午診上限</th><th>晚診上限</th>
                <th>早診時間</th><th>午診時間</th><th>晚診時間</th>
                <th>起始號</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">時間格式示例：08:30~11:30</div>
      </div>

      <div class="card" id="sheetsCard" style="display:none;">
        <h5 class="mb-2">試算表捷徑</h5>
        <div id="sheetBtns" class="d-flex flex-wrap gap-2"></div>
        <div class="text-muted small mt-2">（需有該試算表權限；會在新分頁開啟）</div>
      </div>
    </section>

    <!-- ====== 臨時異動 ====== -->
    <section id="tab-special" style="display:none;">
      <div class="card mb-4">
        <h5 class="mb-3">新增臨時異動</h5>
        <input type="date" id="newDate" class="form-control mb-3">
        <div class="row mb-2 align-items-center">
          <div class="col-12 col-md-3 mb-2 mb-md-0"><span class="tag tag-early"></span><strong>早診</strong></div>
          <div class="col-6 col-md-4 mb-2 mb-md-0"><input id="neEarlyTime" value="08:30~11:30" class="form-control" placeholder="時段（顯示用）"></div>
          <div class="col-4 col-md-3 mb-2 mb-md-0"><input id="neEarlyLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-auto col-md-2"><input id="neEarly" checked type="checkbox"> 開放</div>
        </div>
        <div class="row mb-2 align-items-center">
          <div class="col-12 col-md-3 mb-2 mb-md-0"><span class="tag tag-noon"></span><strong>午診</strong></div>
          <div class="col-6 col-md-4 mb-2 mb-md-0"><input id="neNoonTime" value="14:00~17:00" class="form-control" placeholder="時段（顯示用）"></div>
          <div class="col-4 col-md-3 mb-2 mb-md-0"><input id="neNoonLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-auto col-md-2"><input id="neNoon" checked type="checkbox"> 開放</div>
        </div>
        <div class="row mb-3 align-items-center">
          <div class="col-12 col-md-3 mb-2 mb-md-0"><span class="tag tag-night"></span><strong>晚診</strong></div>
          <div class="col-6 col-md-4 mb-2 mb-md-0"><input id="neNightTime" value="18:00~20:30" class="form-control" placeholder="時段（顯示用）"></div>
          <div class="col-4 col-md-3 mb-2 mb-md-0"><input id="neNightLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-auto col-md-2"><input id="neNight" checked type="checkbox"> 開放</div>
        </div>
        <div class="row">
          <div class="col-8 col-md-6"><input id="neNote" placeholder="備註" class="form-control"></div>
          <div class="col-auto"><button id="addBtn" class="btn-main btn-round">新增</button></div>
        </div>
      </div>

      <div class="card">
        <h5 class="mb-2">目前異動（未過期）</h5>
        <div class="table-responsive">
          <table class="table table-striped" id="tbl">
            <thead>
            <tr><th>日期</th><th>早診</th><th>午診</th><th>晚診</th><th>備註</th><th style="width:140px;">操作</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
/* ====== GAS endpoint（與你 query 同一支） ====== */
const API = "https://script.google.com/macros/s/AKfycbwh6P3SksU1Z90-PehRpk_09PaDw6IreoIaelD7yp7s4WEE5PRxzeDCFuhOZI5BQ_hi/exec";

/* ====== DOM ====== */
const loginBox   = document.getElementById('login');
const appBox     = document.getElementById('app');
const acc        = document.getElementById('acc');
const pw         = document.getElementById('pw');
const btnLoginPW = document.getElementById('btnLoginPW');
const logoutBtn  = document.getElementById('logoutBtn');
const exportBtn  = document.getElementById('exportBtn');

/* Tabs */
const tabBtnToday     = document.getElementById('tabBtnToday');
const tabBtnTomorrow  = document.getElementById('tabBtnTomorrow');
const tabBtnSettings  = document.getElementById('tabBtnSettings');
const tabBtnSpecial   = document.getElementById('tabBtnSpecial');
const views = {
  'tab-today':     document.getElementById('tab-today'),
  'tab-tomorrow':  document.getElementById('tab-tomorrow'),
  'tab-settings':  document.getElementById('tab-settings'),
  'tab-special':   document.getElementById('tab-special'),
};
function switchTab(id){
  [tabBtnToday,tabBtnTomorrow,tabBtnSettings,tabBtnSpecial].forEach(b=>{
    const active = (b.dataset.tab || b.id.replace('tabBtn','tab-')) === id;
    b.classList.toggle('btn-main', active);
    b.classList.toggle('btn-outline-secondary', !active);
  });
  Object.entries(views).forEach(([k,el])=> el.style.display = (k===id?'block':'none'));
}

/* token */
let ADMIN_TOKEN = sessionStorage.getItem('ADMIN_TOKEN') || "";

/* helpers */
function showApp(){ loginBox.style.display="none"; appBox.style.display="block"; switchTab('tab-today'); loadToday(); }
function showLogin(){ appBox.style.display="none"; loginBox.style.display="block"; }
function assertAuthed(){ if(!ADMIN_TOKEN){ showLogin(); throw new Error('no token'); } }
function ymdLocal(d){ const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2); return `${y}-${m}-${da}`; }

/* ====== 把回傳統一整理成好用的物件/陣列 ====== */
function asObj(payload){
  try{ return typeof payload==='string' ? JSON.parse(payload) : (payload||{}); }
  catch{ return {}; }
}
function asArr(payload){
  try{ if(typeof payload==='string') payload = JSON.parse(payload); }catch{}
  if(Array.isArray(payload)) return payload;
  if(Array.isArray(payload?.rows))  return payload.rows;
  if(Array.isArray(payload?.items)) return payload.items;
  if(Array.isArray(payload?.data))  return payload.data;
  return [];
}
const VALID_WD = new Set(['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']);

/* ====== 生日格式化（民國年） ====== */
/** 顯示模式（此專案固定民國年）：'minguo' or 'gregorian' */
const BIRTHDAY_MODE = 'minguo';
function pad2(n){ return n<10 ? '0'+n : ''+n; }
/** 盡可能把任何生日輸入轉成 Date：支援 Date、字串(YYYY-MM-DD/YYYY/MM/DD/瀏覽器字串)、Sheets 日期序號 */
function parseDateLike(v){
  if(!v && v!==0) return null;
  if(v instanceof Date) return isNaN(v) ? null : v;

  if(typeof v === 'number'){ // Google Sheets serial number (epoch 1899-12-30)
    const ms = (v - 25569) * 86400 * 1000;
    const d  = new Date(ms);
    return isNaN(d) ? null : d;
  }

  if(typeof v === 'string'){
    const s = v.trim();
    const m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
    if(m){
      const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
      return isNaN(d) ? null : d;
    }
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }
  return null;
}
/** 依模式輸出生日字串（民國：YYY-MM-DD；西元：YYYY-MM-DD） */
function fmtBirthday(v){
  const d = parseDateLike(v);
  if(!d) return v ?? '';
  const y = d.getFullYear(), m = pad2(d.getMonth()+1), da = pad2(d.getDate());
  if(BIRTHDAY_MODE === 'minguo'){
    const my = y - 1911; // 民國年
    return `${my}-${m}-${da}`; // 例如 103-02-11
  }
  return `${y}-${m}-${da}`;
}

/* ====== Auth ====== */
btnLoginPW.onclick = async () => {
  try{
    const a = (acc.value||'').trim();
    const p = (pw.value||'').trim();
    if(!a || !p){ pw.classList.add('shake'); setTimeout(()=>pw.classList.remove('shake'),350); return; }
    const r = await axios.get(API, { params:{ action:'adminLogin', acc:a, pw:p, t:Date.now() }});
    if(r.data?.ok){
      ADMIN_TOKEN = r.data.token;
      sessionStorage.setItem('ADMIN_TOKEN', ADMIN_TOKEN);
      showApp();
    }else{
      alert(r.data?.message || '帳號或密碼錯誤');
    }
  }catch(e){
    console.error(e);
    alert('登入失敗');
  }
};

/* 登出 / 匯出 */
logoutBtn.onclick = () => { ADMIN_TOKEN=""; sessionStorage.removeItem('ADMIN_TOKEN'); showLogin(); };
exportBtn.onclick = ()=>{ assertAuthed(); window.open(`${API}?action=export&token=${encodeURIComponent(ADMIN_TOKEN)}`,'_blank'); };

/* 綁定 tabs */
[tabBtnToday,tabBtnTomorrow,tabBtnSettings,tabBtnSpecial].forEach(btn=>{
  btn.onclick = async ()=>{
    const id = btn.dataset.tab;
    switchTab(id);
    try{
      if(id==='tab-today'){ await loadToday(); }
      if(id==='tab-tomorrow'){ await loadTomorrow(); }
      if(id==='tab-settings'){ await Promise.all([loadWindow(), loadDaily(), loadSheetLinks()]); }
      if(id==='tab-special'){ await loadSpecials(); }
    }catch(e){ console.error(e); }
  };
});

/* ====== 今天 / 明天 名單 ====== */
const todayInfo   = document.getElementById('todayInfo');
const todayStats  = document.getElementById('todayStats');
const tblToday    = document.getElementById('tblToday').querySelector('tbody');
document.getElementById('btnTodayReload').onclick = loadToday;

const tomorrowInfo  = document.getElementById('tomorrowInfo');
const tomorrowStats = document.getElementById('tomorrowStats');
const tblTomorrow   = document.getElementById('tblTomorrow').querySelector('tbody');
document.getElementById('btnTomorrowReload').onclick = loadTomorrow;

function renderDay(container, data){
  const { infoEl, statsEl, tbodyEl } = container;
  infoEl.textContent = `${data.date || ''}　${data.weekday || ''}`;

  statsEl.innerHTML = '';
  asArr(data.slots).forEach(s=>{
    const tag = s.label==='早診'?'tag-early':(s.label==='午診'?'tag-noon':'tag-night');
    statsEl.insertAdjacentHTML('beforeend', `
      <div class="col-12 col-md-4"><div class="card">
        <div class="mb-1"><span class="tag ${tag}"></span><strong>${s.label}</strong></div>
        <div class="small-note mb-1">時段：${s.time||'—'}</div>
        <div><strong>${s.used||0}</strong> / ${s.limit||0}　<span class="small-note">起始號：${s.startNo||1}</span></div>
      </div></div>
    `);
  });

  tbodyEl.innerHTML = '';
  asArr(data.items).forEach(x=>{
    tbodyEl.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${x.slot||''}</td>
        <td>${x.time||''}</td>
        <td>${x.num||''}</td>
        <td>${x.name||''}</td>
        <td>${fmtBirthday(x.birthday)}</td>
        <td>${x.pid||''}</td>
        <td>${x.phone||''}</td>
        <td>${x.createdAt||''}</td>
        <td><button class="btn btn-outline-danger btn-sm btn-round" onclick="cancelByRow(${x.id})">取消</button></td>
      </tr>
    `);
  });
}

async function loadToday(){
  assertAuthed();
  const r = await axios.get(API,{ params:{ action:'adminToday', token: ADMIN_TOKEN, t:Date.now() }});
  renderDay({infoEl:todayInfo, statsEl:todayStats, tbodyEl:tblToday}, asObj(r.data));
}
async function loadTomorrow(){
  assertAuthed();
  const d = new Date(); d.setDate(d.getDate()+1);
  const ymd = ymdLocal(d);
  const r = await axios.get(API,{ params:{ action:'adminDay', date: ymd, token: ADMIN_TOKEN, t:Date.now() }});
  renderDay({infoEl:tomorrowInfo, statsEl:tomorrowStats, tbodyEl:tblTomorrow}, asObj(r.data));
}
async function cancelByRow(id){
  if(!confirm('確定要取消這筆預約嗎？')) return;
  assertAuthed();
  await axios.get(API,{ params:{ action:'cancel', id, token: ADMIN_TOKEN }});
  // 同步刷新兩個分頁
  if(views['tab-today'].style.display!=='none') await loadToday();
  if(views['tab-tomorrow'].style.display!=='none') await loadTomorrow();
}
window.cancelByRow = cancelByRow;

/* ====== 預約期限 ====== */
const winInfo = document.getElementById('winInfo');
const winStart= document.getElementById('winStart');
const winEnd  = document.getElementById('winEnd');
document.getElementById('btnStartMinus').onclick = ()=> adjustWin(-1, 0);
document.getElementById('btnStartPlus' ).onclick = ()=> adjustWin(+1, 0);
document.getElementById('btnEndMinus'  ).onclick = ()=> adjustWin(0, -1);
document.getElementById('btnEndPlus'   ).onclick = ()=> adjustWin(0, +1);
document.getElementById('btnWinSet').onclick   = setWin;

async function loadWindow(){
  assertAuthed();
  const r = await axios.get(API,{ params:{ action:'adminWindow', token: ADMIN_TOKEN, t:Date.now() }});
  const d = asObj(r.data);
  winStart.value = d.start ?? 2;
  winEnd.value   = d.end ?? 14;
  winInfo.textContent = `目前：起始 D+${winStart.value}（${d.startDate||''}）～ 結束 D+${winEnd.value}（${d.endDate||''}）`;
}
async function setWin(){
  assertAuthed();
  const start = Number(winStart.value), end = Number(winEnd.value);
  const r = await axios.get(API,{ params:{ action:'adminWindowSet', start, end, token: ADMIN_TOKEN }});
  if(r.data?.ok) await loadWindow(); else alert('設定失敗');
}
async function adjustWin(ds,de){
  assertAuthed();
  const r = await axios.get(API,{ params:{ action:'adminWindowAdjust', startDelta:ds, endDelta:de, token: ADMIN_TOKEN }});
  if(r.data?.ok) await loadWindow(); else alert('調整失敗');
}

/* ====== daily_limit（weekday） ====== */
const tblDaily = document.getElementById('tblDaily').querySelector('tbody');
async function loadDaily(){
  assertAuthed();
  const r = await axios.get(API,{ params:{ action:'dailyGet', token: ADMIN_TOKEN, t:Date.now() }});
  const rows = asArr(r.data).filter(w => VALID_WD.has(w.weekdayEn)); // 濾掉試算表表頭那一行
  tblDaily.innerHTML = '';
  rows.forEach(w=>{
    const id = `wd_${w.weekdayEn}`;
    tblDaily.insertAdjacentHTML('beforeend', `
      <tr id="${id}">
        <td>星期${w.weekdayZh||''}<div class="small-note">${w.weekdayEn}</div></td>
        <td class="td-limit"><input class="form-control form-control-sm" type="number" inputmode="numeric" value="${w.limitE||0}" data-k="limitE"></td>
        <td class="td-limit"><input class="form-control form-control-sm" type="number" inputmode="numeric" value="${w.limitN||0}" data-k="limitN"></td>
        <td class="td-limit"><input class="form-control form-control-sm" type="number" inputmode="numeric" value="${w.limitL||0}" data-k="limitL"></td>
        <td class="td-time"><input class="form-control form-control-sm" value="${w.timeE||''}" data-k="timeE"></td>
        <td class="td-time"><input class="form-control form-control-sm" value="${w.timeN||''}" data-k="timeN"></td>
        <td class="td-time"><input class="form-control form-control-sm" value="${w.timeL||''}" data-k="timeL"></td>
        <td class="td-start"><input class="form-control form-control-sm" type="number" inputmode="numeric" value="${w.startNo||1}" data-k="startNo"></td>
        <td class="td-action"><button class="btn-main btn-sm btn-round" onclick="saveWeek('${w.weekdayEn}')">儲存</button></td>
      </tr>
    `);
  });
}
async function saveWeek(wdEn){
  assertAuthed();
  const tr = document.getElementById(`wd_${wdEn}`);
  const q = { action:'dailySet', token: ADMIN_TOKEN, wd: wdEn };
  tr.querySelectorAll('input').forEach(i=>{ q[i.dataset.k]=i.value; });
  const r = await axios.get(API,{ params:q });
  if(!(r.data && r.data.ok)) alert('儲存失敗');
}
window.saveWeek = saveWeek;

/* ====== special_limit（臨時異動） ====== */
const newDate    = document.getElementById('newDate');
const neEarly    = document.getElementById('neEarly');
const neNoon     = document.getElementById('neNoon');
const neNight    = document.getElementById('neNight');
const neEarlyTime= document.getElementById('neEarlyTime');
const neNoonTime = document.getElementById('neNoonTime');
const neNightTime= document.getElementById('neNightTime');
const neEarlyLimit= document.getElementById('neEarlyLimit');
const neNoonLimit = document.getElementById('neNoonLimit');
const neNightLimit= document.getElementById('neNightLimit');
const neNote     = document.getElementById('neNote');
const addBtn     = document.getElementById('addBtn');
const tbl        = document.getElementById('tbl');

addBtn.onclick = async () => {
  try{
    assertAuthed();
    if(!newDate.value) return alert("請選日期");
    await axios.get(API,{ params:{
      action:'adminAdd', token: ADMIN_TOKEN,
      日期    : newDate.value,
      早診上限: neEarly.checked ? Number(neEarlyLimit.value) : 0,
      午診上限: neNoon.checked  ? Number(neNoonLimit.value)  : 0,
      晚診上限: neNight.checked ? Number(neNightLimit.value) : 0,
      備註    : neNote.value
    }});
    alert("新增完成");
    loadSpecials();
  }catch(e){
    console.error(e);
    alert('新增失敗或尚未登入');
  }
};

async function loadSpecials(){
  assertAuthed();
  const r = await axios.get(API,{ params:{ action:'adminGet', token: ADMIN_TOKEN, t:Date.now() }});
  const arr = asArr(r.data);
  const tbody=tbl.querySelector('tbody'); tbody.innerHTML="";
  arr.forEach(x=>{
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${x.日期}</td>
      <td>${x.早診上限||0}</td>
      <td>${x.午診上限||0}</td>
      <td>${x.晚診上限||0}</td>
      <td>${x.備註||""}</td>
      <td>
        <button class="btn btn-warning btn-sm me-1 btn-round" onclick="editRow('${x.id}')">編輯</button>
        <button class="btn btn-danger btn-sm btn-round" onclick="delRow('${x.id}')">刪除</button>
      </td></tr>`);
  })
}

async function delRow(id){
  if(!confirm("確定刪除？")) return;
  try{
    assertAuthed();
    await axios.get(API,{ params:{ action:'adminDel', id, token: ADMIN_TOKEN }});
    loadSpecials();
  }catch(e){
    console.error(e);
    alert('刪除失敗或尚未登入');
  }
}
async function editRow(id){
  assertAuthed();
  const d=await axios.get(API,{ params:{ action:'adminOne', id, token: ADMIN_TOKEN }});
  const f=asObj(d.data);
  const html = `<div class="modal fade" id="editM">
  <div class="modal-dialog"><div class="modal-content">
   <div class="modal-header">
     <h5 class="modal-title">編輯 ${f.日期}</h5>
     <button class="btn-close" data-bs-dismiss="modal"></button>
   </div>
   <div class="modal-body">
     <div class="mb-2"><span class="tag tag-early"></span><strong>早診</strong>
       <input id="edEL" class="form-control d-inline w-25 ms-2" type="number" value="${f["早診上限"]||0}"></div>
     <div class="mb-2"><span class="tag tag-noon"></span><strong>午診</strong>
       <input id="edNL" class="form-control d-inline w-25 ms-2" type="number" value="${f["午診上限"]||0}"></div>
     <div class="mb-2"><span class="tag tag-night"></span><strong>晚診</strong>
       <input id="edTL" class="form-control d-inline w-25 ms-2" type="number" value="${f["晚診上限"]||0}"></div>
     <input id="edNote" class="form-control mt-2" value="${f["備註"]||""}">
   </div>
   <div class="modal-footer">
     <button class="btn btn-outline-secondary btn-round" data-bs-dismiss="modal">取消</button>
     <button id="saveBtn" class="btn-main btn-round">儲存</button>
   </div>
  </div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',html);
  const m=new bootstrap.Modal(document.getElementById("editM")); m.show();
  document.getElementById("saveBtn").onclick=async()=>{
    if(!confirm("確定儲存？"))return;
    await axios.get(API,{ params:{
      action:'adminEdit', id, token: ADMIN_TOKEN,
      早診上限:edEL.value, 午診上限:edNL.value, 晚診上限:edTL.value, 備註:edNote.value
    }});
    m.hide();
    loadSpecials();
  };
}
window.editRow = editRow;
window.delRow  = delRow;

/* ====== 試算表捷徑 ====== */
const sheetsCard = document.getElementById('sheetsCard');
const sheetBtns  = document.getElementById('sheetBtns');
async function loadSheetLinks(){
  try{
    assertAuthed();
    const r = await axios.get(API,{ params:{ action:'sheetLinks', token: ADMIN_TOKEN, t:Date.now() }});
    const data = asObj(r.data);
    const id = data.id;
    const sheets = asArr(data.sheets);
    if(!id || !sheets.length){ sheetsCard.style.display='none'; return; }
    sheets.sort((a,b)=> a.name.localeCompare(b.name,'zh-Hant'));
    sheetBtns.innerHTML = sheets.map(s=>`
      <a class="sheet-chip text-decoration-none" target="_blank" rel="noopener"
         href="https://docs.google.com/spreadsheets/d/${id}/edit#gid=${s.gid}">${s.name}</a>`).join('');
    sheetsCard.style.display='block';
  }catch(e){
    console.warn('sheetLinks 失敗：', e);
    sheetsCard.style.display='none';
  }
}

/* 已有 token 直接進入 */
if(ADMIN_TOKEN){ showApp(); }
</script>
</body>
</html>
