<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>陳萬龍診所預約後台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 網站小圖示：與檔案放在同資料夾時，這樣寫即可 -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg-from:#ecf1f6; --bg-to:#e6edf6; --card-bg:#ffffff;
      --primary:#2563eb; --primary-600:#1e4fd0; --primary-700:#183fa9;
      --slate-700:#334155; --slate-500:#64748b; --ring:#9ab5ff; --chip:#d5d9e2;
    }
    body{ background:linear-gradient(160deg,var(--bg-from),var(--bg-to)); min-height:100vh; color:var(--slate-700); }
    .btn-round{ border-radius:999px; }
    .btn-main{ background:var(--primary); color:#fff; border:0; border-radius:999px; box-shadow:0 6px 14px rgba(37,99,235,.18); }
    .btn-main:hover{ background:var(--primary-600); color:#fff; }
    .btn-outline-secondary{ border-radius:999px; }
    .sheet-chip{ display:inline-block; padding:.375rem .6rem; border:1px solid var(--chip); border-radius:999px; }
    .small-note{ color:var(--slate-500); font-size:.925rem; }
    .small-note code{ background:#f6f6f8; padding:.1rem .25rem; border-radius:6px; }
    .tag{ display:inline-block; width:.8em; height:.8em; border-radius:2px; margin-right:.4em; vertical-align:middle; }
    .tag-early{ background:#10b981; } .tag-noon{ background:#f59e0b; } .tag-night{ background:#6366f1; }
    .date-nav{ display:flex; flex-wrap:wrap; align-items:center; gap:.5rem .5rem; }
    .date-nav .form-control{ width:160px; }
    .totals{ font-weight:700; color:#1f3f57; } .totals .muted{ color:#6b7a90; font-weight:600; }
    #tblToday th,#tblToday td,#tblTomorrow th,#tblTomorrow td{ white-space:nowrap; }
    .card-wrap{ max-width:1180px; margin:24px auto; padding:0 12px; }
    .tabbar{ display:flex; gap:8px; margin:16px 0; }
    .w-ch-4{ width:4.5ch !important; min-width:40px; } .w-ch-3{ width:3.5ch !important; min-width:36px; }
    .text-center{ text-align:center; }

    /* Login / Header 保持原樣式（略） */
    .login-card{ display:grid; place-items:center; min-height:calc(100vh - 6rem); padding:3rem 1rem; }
    .login-card .card{ width:100%; max-width:460px; background:var(--card-bg); border:0; border-radius:28px; padding:28px 24px;
      box-shadow:0 12px 24px rgba(30,79,208,.08), 0 4px 12px rgba(15,23,42,.06); }
    .login-card .header{ display:flex; align-items:center; gap:14px; margin-bottom:10px; }
    .login-card .logo{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:var(--primary); color:#fff; font-weight:700; font-size:18px; box-shadow:0 6px 14px rgba(37,99,235,.25); }
    .login-card h1{ color:var(--slate-700); }
    .login-card .form-control{ border-radius:14px; padding:.625rem .9rem; border:1px solid #e5e7eb; box-shadow:inset 0 1px 0 rgba(0,0,0,.02); }
    .login-card .form-control:focus{ border-color:var(--primary); box-shadow:0 0 0 .2rem rgba(37,99,235,.12), 0 2px 6px rgba(0,0,0,.04); outline:none; }
    .login-card .btn-primary{ background:var(--primary); border:0; border-radius:14px; padding:.7rem 1rem; box-shadow:0 10px 18px rgba(37,99,235,.18); }
    .login-card .btn-primary:hover{ background:var(--primary-600); }
    .login-card .helper{ display:flex; justify-content:space-between; align-items:center; color:var(--slate-500); font-size:.925rem; }
    .card-head .logo{ width:32px; height:32px; border-radius:10px; display:grid; place-items:center; background:var(--primary); color:#fff; font-weight:700;
      box-shadow:0 6px 14px rgba(37,99,235,.18); }
  </style>
</head>
<body>
<!-- Login -->
<div id="login" class="container login-card">
  <div class="card">
    <div class="header">
      <div class="logo">＋</div>
      <div>
        <h1 class="h4 m-0">後台登入</h1>
        <div class="small-note mt-1">請輸入管理帳號與密碼</div>
      </div>
    </div>
    <label for="acc" class="form-label small-note mb-1">帳號</label>
    <input id="acc" class="form-control mb-3" placeholder="輸入帳號">
    <label for="pw" class="form-label small-note mb-1">管理密碼</label>
    <input id="pw" type="password" class="form-control mb-3" placeholder="輸入密碼">
    <button id="btnLoginPW" class="btn btn-primary w-100 mb-2">登入</button>
    <div class="helper"><span>忘記密碼？請聯絡管理者</span></div>
  </div>
</div>

<!-- App -->
<div id="app" style="display:none;">
  <div class="card-wrap">
    <div class="card-head d-flex align-items-center gap-2">
      <div class="logo">＋</div>
      <div>
        <h3 class="m-0">後台管理</h3>
        <div class="subtitle text-muted"><b style="color:#000;">注意事項</b>：今天名單、明天名單、預約設定、臨時異動</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="exportBtn" class="btn btn-outline-secondary btn-round btn-sm">匯出今日起預約名單</button>
        <button id="logoutBtn"  class="btn-main btn-round btn-sm">登出</button>
      </div>
    </div>

    <!-- 分頁按鈕 -->
    <div class="tabbar">
      <button class="btn btn-main" id="tabBtnToday" data-tab="tab-today">今天名單</button>
      <button class="btn btn-outline-secondary" id="tabBtnTomorrow" data-tab="tab-tomorrow">明天名單</button>
      <button class="btn btn-outline-secondary" id="tabBtnSettings" data-tab="tab-settings">預約設定</button>
      <button class="btn btn-outline-secondary" id="tabBtnSpecial" data-tab="tab-special">臨時異動</button>
    </div>

    <!-- 今天名單（原樣，略） -->
    <section id="tab-today"> …（保持你原本內容）… </section>

    <!-- 明天名單（原樣，略） -->
    <section id="tab-tomorrow" style="display:none;"> …（保持你原本內容）… </section>

    <!-- 預約設定（原樣，略） -->
    <section id="tab-settings" style="display:none;"> …（保持你原本內容）… </section>

    <!-- 臨時異動（已補上 E/F/G/H 欄） -->
    <section id="tab-special" style="display:none;">
      <div class="card mb-4 p-3">
        <h5 class="mb-3">新增臨時異動</h5>
        <input type="date" id="newDate" class="form-control mb-3">

        <div class="row g-2 align-items-center">
          <div class="col-12 col-md-3"><span class="tag tag-early"></span><strong>早診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neEarlyLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-6 col-md-6"><input id="neEarlyTime"  value=""   class="form-control" placeholder="早診時段，例如 08:30~11:30"></div>
        </div>

        <div class="row g-2 align-items-center mt-1">
          <div class="col-12 col-md-3"><span class="tag tag-noon"></span><strong>午診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neNoonLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-6 col-md-6"><input id="neNoonTime"  value=""   class="form-control" placeholder="午診時段，例如 14:00~17:00"></div>
        </div>

        <div class="row g-2 align-items-center mt-1">
          <div class="col-12 col-md-3"><span class="tag tag-night"></span><strong>晚診上限</strong></div>
          <div class="col-6 col-md-3"><input id="neNightLimit" value="10" type="number" class="form-control" placeholder="上限"></div>
          <div class="col-6 col-md-6"><input id="neNightTime" value=""   class="form-control" placeholder="晚診時段，例如 18:00~20:30"></div>
        </div>

        <div class="row g-2 align-items-end mt-2">
          <div class="col-6 col-md-3">
            <label class="small-note">起始號碼</label>
            <input id="neStartNo" type="number" class="form-control w-ch-4 text-center" value="1" min="1">
          </div>
          <div class="col-6 col-md-3">
            <label class="small-note">間格位數</label>
            <input id="neStep" type="number" class="form-control w-ch-4 text-center" value="1" min="1">
          </div>
          <div class="col-12 col-md-6">
            <label class="small-note">備註</label>
            <div class="d-flex gap-2">
              <input id="neNote" placeholder="備註" class="form-control">
              <button id="addBtn" class="btn-main btn-round">新增</button>
            </div>
          </div>
        </div>
        <div class="small-note mt-2">時間格式：08:30~11:30 ｜ 奇數／偶數：起始=1／2、間隔=2。</div>
      </div>

      <div class="card p-3">
        <h5 class="mb-2">目前異動（未過期）</h5>
        <div class="table-responsive">
          <table class="table table-striped" id="tbl">
            <colgroup>
              <col style="width:110px;">
              <col style="width:80px;"><col style="width:80px;"><col style="width:80px;">
              <col style="width:160px;"><col style="width:160px;"><col style="width:160px;">
              <col style="width:90px;"><col style="width:90px;">
              <col style="width:200px;">
              <col style="width:220px;">
            </colgroup>
            <thead>
              <tr>
                <th>日期</th>
                <th>早診上限</th><th>午診上限</th><th>晚診上限</th>
                <th>早診時段</th><th>午診時段</th><th>晚診時段</th>
                <th>起始號碼</th><th>間格位數</th>
                <th>備註</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
/* ===== API 與共用（你的原碼保留） ===== */
const API = "https://script.google.com/macros/s/AKfycbw63BV5w0VIHxE7sePmLXhd_pRJyZTGOqmujtwjmwdADv827L0TMg1LrbO0eiSkuMWs/exec";
const loginBox=document.getElementById('login'), appBox=document.getElementById('app');
const acc=document.getElementById('acc'), pw=document.getElementById('pw'), btnLoginPW=document.getElementById('btnLoginPW');
const logoutBtn=document.getElementById('logoutBtn'), exportBtn=document.getElementById('exportBtn');
const tabBtnToday=document.getElementById('tabBtnToday'), tabBtnTomorrow=document.getElementById('tabBtnTomorrow'),
      tabBtnSettings=document.getElementById('tabBtnSettings'), tabBtnSpecial=document.getElementById('tabBtnSpecial');
const views={ 'tab-today':document.getElementById('tab-today'), 'tab-tomorrow':document.getElementById('tab-tomorrow'),
              'tab-settings':document.getElementById('tab-settings'), 'tab-special':document.getElementById('tab-special') };
function switchTab(id){ [tabBtnToday,tabBtnTomorrow,tabBtnSettings,tabBtnSpecial].forEach(b=>{ const a=(b.dataset.tab||b.id.replace('tabBtn','tab-'))===id; b.classList.toggle('btn-main',a); b.classList.toggle('btn-outline-secondary',!a); }); Object.entries(views).forEach(([k,el])=>el.style.display=(k===id?'block':'none')); }
let ADMIN_TOKEN=sessionStorage.getItem('ADMIN_TOKEN')||"";
function showApp(){ loginBox.style.display="none"; appBox.style.display="block"; switchTab('tab-today'); initTodayTab(); }
function showLogin(){ appBox.style.display="none"; loginBox.style.display="block"; }
function assertAuthed(){ if(!ADMIN_TOKEN){ showLogin(); throw new Error('no token'); } }
function ymdLocal(d){ const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),da=('0'+d.getDate()).slice(-2); return `${y}-${m}-${da}`; }
function addDays(ymd,delta){ const d=new Date(ymd); d.setDate(d.getDate()+delta); return ymdLocal(d); }
function todayYmd(){ return ymdLocal(new Date()); }
function asObj(p){ try{ return typeof p==='string'?JSON.parse(p):(p||{});}catch{ return {}; } }
function asArr(p){ try{ if(typeof p==='string') p=JSON.parse(p);}catch{} if(Array.isArray(p))return p; if(Array.isArray(p?.rows))return p.rows; if(Array.isArray(p?.items))return p.items; if(Array.isArray(p?.data))return p.data; return []; }

/* ===== 登入、登出、Tab 切換（保留原碼；略） ===== */
btnLoginPW.onclick = async ()=>{ try{ const a=(acc.value||'').trim(), p=(pw.value||'').trim(); if(!a||!p) return; const r=await axios.get(API,{params:{action:'adminLogin',acc:a,pw:p,t:Date.now()}}); if(r.data?.ok){ ADMIN_TOKEN=r.data.token; sessionStorage.setItem('ADMIN_TOKEN',ADMIN_TOKEN); showApp(); }else{ alert(r.data?.message||'帳號或密碼錯誤'); } }catch(e){ console.error(e); alert('登入失敗'); } };
[acc,pw].forEach(el=>el.addEventListener('keydown',e=>{ if(e.key==='Enter') btnLoginPW.click(); }));
logoutBtn.onclick=()=>{ ADMIN_TOKEN=""; sessionStorage.removeItem('ADMIN_TOKEN'); showLogin(); };
exportBtn.onclick=()=>{ assertAuthed(); window.open(`${API}?action=export&token=${encodeURIComponent(ADMIN_TOKEN)}`,'_blank'); };
[tabBtnToday,tabBtnTomorrow,tabBtnSettings,tabBtnSpecial].forEach(btn=>{ btn.onclick=async()=>{ const id=btn.dataset.tab; switchTab(id); try{ if(id==='tab-today'){ await initTodayTab(); } if(id==='tab-tomorrow'){ await initTomorrowTab(); } if(id==='tab-settings'){ await Promise.all([loadWindow(),loadDaily(),loadSheetLinks(),loadFlags()]); } if(id==='tab-special'){ await loadSpecials(); } }catch(e){ console.error(e);} }; });

/* ===== 今天/明天（保持你的原本函式，略） ===== */
function fmtBirthday(v){ /* 省略：與你原本一致 */ return v??''; }
async function initTodayTab(){ /* 省略：與你原本一致 */ }
async function initTomorrowTab(){ /* 省略：與你原本一致 */ }
async function loadWindow(){ /* 省略：與你原本一致 */ }
async function loadDaily(){ /* 省略：與你原本一致 */ }
async function loadFlags(){ /* 省略：與你原本一致 */ }
async function loadSheetLinks(){ /* 省略：與你原本一致 */ }

/* ===== special_limit：新增／讀取／刪除／編輯 ===== */
const newDate=document.getElementById('newDate');
const neEarlyLimit=document.getElementById('neEarlyLimit');
const neNoonLimit=document.getElementById('neNoonLimit');
const neNightLimit=document.getElementById('neNightLimit');
const neEarlyTime=document.getElementById('neEarlyTime');
const neNoonTime=document.getElementById('neNoonTime');
const neNightTime=document.getElementById('neNightTime');
const neNote=document.getElementById('neNote');
const neStartNo=document.getElementById('neStartNo');
const neStep=document.getElementById('neStep');
const addBtn=document.getElementById('addBtn');
const tbl=document.getElementById('tbl');

addBtn.onclick = async ()=>{
  try{
    assertAuthed();
    if(!newDate.value) return alert("請選日期");
    const q={
      action:'adminAdd', token:ADMIN_TOKEN,
      日期:newDate.value,
      早診上限:Number(neEarlyLimit.value||0),
      午診上限:Number(neNoonLimit.value||0),
      晚診上限:Number(neNightLimit.value||0),
      早診時段:neEarlyTime.value||'',
      午診時段:neNoonTime.value||'',
      晚診時段:neNightTime.value||'',
      起始號碼:Number(neStartNo.value||1),
      間隔位數:Math.max(1,Number(neStep.value||1)),
      備註:neNote.value||''
    };
    await axios.get(API,{params:q});
    alert("新增完成");
    loadSpecials();
  }catch(e){ console.error(e); alert('新增失敗或尚未登入'); }
};

async function loadSpecials(){
  assertAuthed();
  const r=await axios.get(API,{params:{action:'adminGet',token:ADMIN_TOKEN,t:Date.now()}});
  const arr=asArr(r.data);
  const tbody=tbl.querySelector('tbody'); tbody.innerHTML="";
  arr.forEach(x=>{
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${x.日期}</td>
        <td>${x.早診上限||0}</td><td>${x.午診上限||0}</td><td>${x.晚診上限||0}</td>
        <td>${x.早診時段||''}</td><td>${x.午診時段||''}</td><td>${x.晚診時段||''}</td>
        <td>${x.起始號碼||1}</td><td>${x.間格位數||1}</td>
        <td>${x.備註||""}</td>
        <td class="d-flex gap-2">
          <button class="btn btn-warning btn-sm btn-round" onclick="editRow('${x.id}')">編輯</button>
          <button class="btn btn-danger btn-sm btn-round" onclick="delRow('${x.id}')">刪除</button>
        </td>
      </tr>`);
  });
}

async function delRow(id){
  if(!confirm("確定刪除？")) return;
  try{ assertAuthed(); await axios.get(API,{params:{action:'adminDel',id,token:ADMIN_TOKEN}}); loadSpecials(); }
  catch(e){ console.error(e); alert('刪除失敗或尚未登入'); }
}

async function editRow(id){
  assertAuthed();
  const d=await axios.get(API,{params:{action:'adminOne',id,token:ADMIN_TOKEN}});
  const f=asObj(d.data);
  const html=`<div class="modal fade" id="editM"><div class="modal-dialog modal-lg"><div class="modal-content">
   <div class="modal-header"><h5 class="modal-title">編輯 ${f.日期}</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
   <div class="modal-body">
     <div class="row g-2">
       <div class="col-6 col-md-3"><label class="form-label">早診上限</label><input id="edEL" class="form-control" type="number" value="${f["早診上限"]||0}"></div>
       <div class="col-6 col-md-3"><label class="form-label">午診上限</label><input id="edNL" class="form-control" type="number" value="${f["午診上限"]||0}"></div>
       <div class="col-6 col-md-3"><label class="form-label">晚診上限</label><input id="edTL" class="form-control" type="number" value="${f["晚診上限"]||0}"></div>
       <div class="col-12 col-md-6"><label class="form-label">早診時段</label><input id="edTE" class="form-control" value='${f["早診時段"]||""}'></div>
       <div class="col-12 col-md-6"><label class="form-label">午診時段</label><input id="edTN" class="form-control" value='${f["午診時段"]||""}'></div>
       <div class="col-12 col-md-6"><label class="form-label">晚診時段</label><input id="edTLt" class="form-control" value='${f["晚診時段"]||""}'></div>
       <div class="col-12 col-md-6"><label class="form-label">備註</label><input id="edNote" class="form-control" value="${f["備註"]||""}"></div>
       <div class="col-6 col-md-3"><label class="form-label">起始號碼</label><input id="edStartNo" class="form-control w-ch-4 text-center" type="number" value="${f["起始號碼"]||1}" min="1"></div>
       <div class="col-6 col-md-3"><label class="form-label">間格位數</label><input id="edStep" class="form-control w-ch-4 text-center" type="number" value="${f["間格位數"]||1}" min="1"></div>
     </div>
     <div class="small-note mt-2">此處儲存會以 <code>adminAdd</code> 覆蓋該日期設定。</div>
   </div>
   <div class="modal-footer">
     <button class="btn btn-outline-secondary btn-round" data-bs-dismiss="modal">取消</button>
     <button id="saveBtn" class="btn-main btn-round">儲存</button>
   </div>
  </div></div></div>`;
  document.body.insertAdjacentHTML('beforeend', html);
  const mEl=document.getElementById("editM"); const m=new bootstrap.Modal(mEl); m.show();
  document.getElementById("saveBtn").onclick=async()=>{
    if(!confirm("確定儲存？")) return;
    await axios.get(API,{params:{
      action:'adminAdd', token:ADMIN_TOKEN, 日期:f.日期,
      早診上限:document.getElementById('edEL').value,
      午診上限:document.getElementById('edNL').value,
      晚診上限:document.getElementById('edTL').value,
      早診時段:document.getElementById('edTE').value,
      午診時段:document.getElementById('edTN').value,
      晚診時段:document.getElementById('edTLt').value,
      備註:document.getElementById('edNote').value,
      起始號碼:Number(document.getElementById('edStartNo').value||1),
      間隔位數:Math.max(1,Number(document.getElementById('edStep').value||1))
    }});
    m.hide(); mEl.addEventListener('hidden.bs.modal', ()=> mEl.remove(), {once:true});
    loadSpecials();
  };
  mEl.addEventListener('hidden.bs.modal', ()=> mEl.remove(), {once:true});
}
window.editRow=editRow; window.delRow=delRow;

if(ADMIN_TOKEN){ showApp(); }
</script>
</body>
</html>
