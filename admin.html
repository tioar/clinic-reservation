<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>陳萬龍診所預約後台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="3BA4B390-F02A-4049-AF8C-3956BA0C2A4E.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .date-nav{ display:flex; flex-wrap:wrap; align-items:center; gap:.5rem .5rem; }
    .date-nav .form-control{ width:160px; }
    .totals{ font-weight:700; color:#1f3f57; }
    .totals .muted{ color:#6b7a90; font-weight:600; }
    #tblToday th,#tblToday td,#tblTomorrow th,#tblTomorrow td{ white-space: nowrap; }
    .small-note code{ background:#f6f6f8; padding:.1rem .25rem; border-radius:4px; }
  </style>
</head>
<body>
<!-- ====== Login ====== -->
<div id="login" class="container py-5 login-card">
  <div class="card">
    <div class="header">
      <div class="logo">＋</div>
      <h1>後台登入</h1>
    </div>
    <input id="acc" class="form-control mb-2" placeholder="帳號">
    <input id="pw" type="password" class="form-control mb-3" placeholder="管理密碼">
    <button id="btnLoginPW" class="btn btn-outline-secondary w-100">登入</button>
  </div>
</div>

<!-- ====== App ====== -->
<div id="app" style="display:none;">
  <div class="card-wrap">
    <div class="card-head d-flex align-items-center gap-2">
      <div class="logo">＋</div>
      <div>
        <h3 class="m-0">後台管理</h3>
        <div class="subtitle">今天名單、明天名單、預約設定、臨時異動</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="exportBtn" class="btn btn-outline-secondary btn-round btn-sm">匯出今日起預約名單</button>
        <button id="logoutBtn"  class="btn-main btn-round btn-sm">登出</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabbar">
      <button class="btn btn-main"                id="tabBtnToday"     data-tab="tab-today">今天名單</button>
      <button class="btn btn-outline-secondary"   id="tabBtnTomorrow"  data-tab="tab-tomorrow">明天名單</button>
      <button class="btn btn-outline-secondary"   id="tabBtnSettings"  data-tab="tab-settings">預約設定</button>
      <button class="btn btn-outline-secondary"   id="tabBtnSpecial"   data-tab="tab-special">臨時異動</button>
    </div>

    <!-- ====== 今天名單 ====== -->
    <section id="tab-today">
      <div class="card mb-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0">今天名單</h5>
            <div id="todayInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTodayReload" class="btn btn-outline-secondary btn-round btn-sm">重新整理</button></div>
        </div>
        <div class="date-nav mt-2">
          <button id="tPrev" class="btn btn-outline-secondary btn-sm">◀ 前一天</button>
          <input id="tDate" type="date" class="form-control form-control-sm">
          <button id="tNext" class="btn btn-outline-secondary btn-sm">後一天 ▶</button>
          <button id="tToday" class="btn btn-outline-secondary btn-sm">今天</button>
          <button id="tTomorrow" class="btn btn-outline-secondary btn-sm">明天</button>
          <div class="ms-2 totals"><span class="muted">總計：</span><span id="tTotals">—</span></div>
        </div>
        <div id="todayStats" class="row g-3 mt-2"></div>
      </div>
      <div class="card">
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblToday">
            <thead><tr><th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th><th>身分證</th><th>電話</th><th>建立時間</th><th>操作</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 明天名單 ====== -->
    <section id="tab-tomorrow" style="display:none;">
      <div class="card mb-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h5 class="m-0">明天名單</h5>
            <div id="tomorrowInfo" class="small-note mt-1"></div>
          </div>
          <div><button id="btnTomorrowReload" class="btn btn-outline-secondary btn-round btn-sm">重新整理</button></div>
        </div>
        <div class="date-nav mt-2">
          <button id="mPrev" class="btn btn-outline-secondary btn-sm">◀ 前一天</button>
          <input id="mDate" type="date" class="form-control form-control-sm">
          <button id="mNext" class="btn btn-outline-secondary btn-sm">後一天 ▶</button>
          <button id="mToday" class="btn btn-outline-secondary btn-sm">今天</button>
          <button id="mTomorrow" class="btn btn-outline-secondary btn-sm">明天</button>
          <div class="ms-2 totals"><span class="muted">總計：</span><span id="mTotals">—</span></div>
        </div>
        <div id="tomorrowStats" class="row g-3 mt-2"></div>
      </div>
      <div class="card">
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="tblTomorrow">
            <thead><tr><th>診別</th><th>時段</th><th>號碼</th><th>姓名</th><th>生日</th><th>身分證</th><th>電話</th><th>建立時間</th><th>操作</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small-note">註：取消會直接在試算表 I 欄標記 TRUE。</div>
      </div>
    </section>

    <!-- ====== 預約設定 ====== -->
    <section id="tab-settings" style="display:none;">
      <div class="card mb-4">
        <h5 class="m-0">預約期限</h5>
        <div id="winInfo" class="small-note my-2"></div>
        <div class="d-flex flex-wrap align-items-center gap-4">
          <div><div class="small-note mb-1">起始天</div><input id="winStart" type="number" class="form-control"></div>
          <div><div class="small-note mb-1">結束天</div><input id="winEnd" type="number" class="form-control"></div>
          <div class="d-flex align-items-end"><button id="btnWinSet" class="btn-main btn-round">套用</button></div>
        </div>
      </div>
      <div class="card mb-4">
        <h5>每週規則（daily_limit）</h5>
        <div class="table-responsive">
          <table class="table" id="tblDaily">
            <thead><tr><th>星期</th><th>早診上限</th><th>午診上限</th><th>晚診上限</th><th>早診時間</th><th>午診時間</th><th>晚診時間</th><th>起始號碼</th><th>間格位數</th><th>操作</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ====== 臨時異動 ====== -->
    <section id="tab-special" style="display:none;">
      <div class="card mb-4">
        <h5>新增臨時異動</h5>
        <input type="date" id="newDate" class="form-control mb-2">
        <div class="row g-2">
          <div class="col"><input id="neEarlyLimit" type="number" class="form-control" placeholder="早診上限"></div>
          <div class="col"><input id="neNoonLimit" type="number" class="form-control" placeholder="午診上限"></div>
          <div class="col"><input id="neNightLimit" type="number" class="form-control" placeholder="晚診上限"></div>
          <div class="col"><input id="neStartNo" type="number" class="form-control" placeholder="起始號碼" value="1"></div>
          <div class="col"><input id="neStep" type="number" class="form-control" placeholder="間格位數" value="1"></div>
          <div class="col"><input id="neNote" class="form-control" placeholder="備註"></div>
          <div class="col-auto"><button id="addBtn" class="btn-main btn-round">新增</button></div>
        </div>
      </div>
      <div class="card">
        <h5>目前異動</h5>
        <table class="table" id="tbl">
          <thead><tr><th>日期</th><th>早診</th><th>午診</th><th>晚診</th><th>起始號碼</th><th>間格位數</th><th>備註</th><th>操作</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
/* API base */
const API="https://script.google.com/macros/s/AKfycbyqrVJ83UQ0AVAeXhSRBHMkGX8cYHNuh79hFor4CIThIeAnwbJWfNiGM02MBB-glUgp/exec";

/* 簡化 util */
function asObj(p){try{return typeof p==='string'?JSON.parse(p):p||{}}catch{return{}}}
function asArr(p){try{if(typeof p==='string')p=JSON.parse(p)}catch{};return Array.isArray(p)?p:(p?.rows||p?.items||p?.data||[])}

/* login/logout */
let ADMIN_TOKEN=sessionStorage.getItem("ADMIN_TOKEN")||"";
async function login(a,p){const r=await axios.get(API,{params:{action:'adminLogin',acc:a,pw:p}});if(r.data?.ok){ADMIN_TOKEN=r.data.token;sessionStorage.setItem("ADMIN_TOKEN",ADMIN_TOKEN);showApp();}else alert("帳號密碼錯誤");}

/* daily_limit load */
async function loadDaily(){
  const r=await axios.get(API,{params:{action:'dailyGet',token:ADMIN_TOKEN}});
  const rows=asArr(r.data);
  const tb=document.querySelector("#tblDaily tbody");tb.innerHTML="";
  rows.forEach(w=>{
    tb.insertAdjacentHTML("beforeend",`
      <tr>
        <td>星期${w.weekdayZh}</td>
        <td><input value="${w['早診上限']||0}" data-k="limitE"></td>
        <td><input value="${w['午診上限']||0}" data-k="limitN"></td>
        <td><input value="${w['晚診上限']||0}" data-k="limitL"></td>
        <td><input value="${w['早診時間']||''}" data-k="timeE"></td>
        <td><input value="${w['午診時間']||''}" data-k="timeN"></td>
        <td><input value="${w['晚診時間']||''}" data-k="timeL"></td>
        <td><input value="${w['起始號碼']||1}" data-k="startNo"></td>
        <td><input value="${w['間格位數']||1}" data-k="step"></td>
        <td><button onclick="saveWeek('${w.weekdayEn}',this)">儲存</button></td>
      </tr>`);});
}
async function saveWeek(wdEn,btn){
  const tr=btn.closest("tr");const q={action:'dailySet',token:ADMIN_TOKEN,wd:wdEn};
  tr.querySelectorAll("input").forEach(i=>q[i.dataset.k]=i.value);
  await axios.get(API,{params:q});
}

/* special_limit load */
async function loadSpecials(){
  const r=await axios.get(API,{params:{action:'adminGet',token:ADMIN_TOKEN}});
  const arr=asArr(r.data);const tb=document.querySelector("#tbl tbody");tb.innerHTML="";
  arr.forEach(x=>{
    tb.insertAdjacentHTML("beforeend",`<tr>
      <td>${x.日期}</td><td>${x.早診上限}</td><td>${x.午診上限}</td><td>${x.晚診上限}</td>
      <td>${x.起始號碼}</td><td>${x.間格位數}</td><td>${x.備註||""}</td>
      <td><button onclick="editRow('${x.id}')">編輯</button> <button onclick="delRow('${x.id}')">刪除</button></td>
    </tr>`);});
}
async function addSpecial(){
  const q={action:'adminAdd',token:ADMIN_TOKEN,
    日期:document.getElementById("newDate").value,
    早診上限:neEarlyLimit.value,午診上限:neNoonLimit.value,晚診上限:neNightLimit.value,
    起始號碼:neStartNo.value,間格位數:neStep.value,備註:neNote.value};
  await axios.get(API,{params:q});loadSpecials();
}
async function delRow(id){if(confirm("刪除?")){await axios.get(API,{params:{action:'adminDel',id,token:ADMIN_TOKEN}});loadSpecials();}}
async function editRow(id){
  const r=await axios.get(API,{params:{action:'adminOne',id,token:ADMIN_TOKEN}});const f=asObj(r.data);
  const val=(k)=>f[k]||"";
  const html=`<div class="modal fade" id="editM"><div class="modal-dialog"><div class="modal-content">
   <div class="modal-header"><h5>編輯 ${f.日期}</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
   <div class="modal-body">
    早:<input id="edEL" value="${val("早診上限")}"><br>
    午:<input id="edNL" value="${val("午診上限")}"><br>
    晚:<input id="edTL" value="${val("晚診上限")}"><br>
    起始號:<input id="edSN" value="${val("起始號碼")}"><br>
    間格:<input id="edST" value="${val("間格位數")}"><br>
    備註:<input id="edNote" value="${val("備註")}">
   </div>
   <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">取消</button><button class="btn btn-primary" id="svBtn">儲存</button></div>
  </div></div></div>`;
  document.body.insertAdjacentHTML("beforeend",html);
  const m=new bootstrap.Modal(document.getElementById("editM"));m.show();
  document.getElementById("svBtn").onclick=async()=>{
    const q={action:'adminAdd',token:ADMIN_TOKEN,日期:f.日期,
      早診上限:edEL.value,午診上限:edNL.value,晚診上限:edTL.value,
      起始號碼:edSN.value,間格位數:edST.value,備註:edNote.value};
    await axios.get(API,{params:q});m.hide();loadSpecials();
  }
}
document.getElementById("addBtn").onclick=addSpecial;
</script>
</body>
</html>
