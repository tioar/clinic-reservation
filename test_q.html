<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é™³è¬é¾è¨ºæ‰€é–€è¨ºæŸ¥è©¢ï¼å–æ¶ˆé ç´„</title>

<link rel="icon" type="image/png" href="favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- å‚™æ´ï¼šè¿‘ä¼¼æ¥·é«”ï¼ˆè®“æ²’è£ woff2 ä¹Ÿè¼ƒä¸€è‡´ï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ===================== ä¸»é¡Œï¼ˆPANTONEï¼šPonder æ²‰æ€ï¼‰ ===================== */
:root{
  --classic-blue:#34558b;  /* ä¸»è‰² */
  --provence:#678fc9;
  --baby-blue:#bfd2dd;
  --monument:#7b858a;
  --stucco:#9b8577;

  --primary:var(--classic-blue);
  --ink:#1c2430;
  --bg:#f4f6f8;
  --card:#ffffff;
  --line:#e6ebf1;

  --spin-color:#7f93b1;   /* ç°è— spinner è‰² */
  --spin-fade:1.2s;
}

/* ===================== å­—é«”ï¼ˆTW-Kai ç‚ºä¸»ï¼›è«‹æŠŠ fonts/TW-Kai.woff2 æ”¾å¥½ï¼‰ ===================== */
@font-face{
  font-family:"TW-Kai";
  src:url("fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"CwTeXKai";
  src:url("fonts/CwTeXKai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}

*{box-sizing:border-box}
html,body{width:100%;max-width:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:
    "TW-Kai","CwTeXKai","LXGW WenKai TC",
    "DFKai-SB","KaiTi","Kaiti TC","Kaiti SC","BiauKai",
    "STFangsong","FangSong",
    "PingFang TC","Microsoft JhengHei",serif;
  font-weight:400;
}

/* å…¨ç«™æ–¹è§’ï¼ˆä¸è¦åœ“è§’ï¼‰ */
.btn, .form-control, .cardish, .chip, .modal-content, .btn-main, .btn-outline-gray, .btn-cancel { border-radius:0 !important; }

.cardish{max-width:780px;margin:32px auto;background:var(--card);border:1px solid var(--line);padding:28px 22px 32px}
.header{display:flex;align-items:center;gap:14px;margin-bottom:10px}
.header .logo{width:56px;height:56px;display:grid;place-items:center;background:var(--primary);color:#fff;font-weight:700;font-size:30px}
.header h1{margin:0;font-weight:700;font-size:clamp(1.4rem,2.4vw,2rem);color:var(--primary)}

.note-bubble{
  background:#f6f9ff;border:1px solid #e3ecff;color:#314863;
  padding:10px 12px;margin:8px 0 18px; font-weight:700;
}

.form-label{font-weight:700;color:#1f2b3a}
.form-control{border:1px solid #cfd6df;height:46px}

/* ä¸»è¦æŒ‰éˆ•ï¼ˆæ–¹å½¢ï¼‰ */
.btn-main{background:var(--primary);color:#fff;border:1px solid var(--primary);font-weight:700;padding:.9rem 1.15rem}
.btn-main:hover{background:#2f4b79;color:#fff}
.btn-outline-gray{background:#fff;border:1px solid #cfd6df;color:#3a3f47;font-weight:700;padding:.9rem 1.15rem}
.btn-outline-gray:hover{background:#f7f8fb}

/* å–æ¶ˆæŒ‰éˆ•ï¼šç´…åº•ç™½å­—ï¼›disabled æ•´é¡†è®Šç° */
.btn-cancel{
  background:#b91c1c; color:#fff; border:1px solid #b91c1c;
  font-weight:700; padding:.45rem .9rem;
}
.btn-cancel:hover{ background:#991b1b; border-color:#991b1b; color:#fff; }
.btn-cancel:focus{ outline:2px solid #fca5a5; outline-offset:0; }
.btn-cancel:disabled{
  background:#e5e7eb !important; color:#6b7280 !important; border-color:#d1d5db !important;
  cursor:not-allowed; filter:grayscale(1);
}

/* çµæœåˆ—è¡¨ */
.list-head{display:grid;grid-template-columns:1.1fr .7fr .7fr .9fr 1fr .6fr .8fr;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid #e6ebf1;color:#2f3b4a}
.list-row {display:grid;grid-template-columns:1.1fr .7fr .7fr .9fr 1fr .6fr .8fr;gap:8px;align-items:center;padding:8px 10px;border:1px solid #e6ebf1;background:#fff;margin-top:8px}

.row-early { background:#e7f2ea; color:#0b523a; }
.row-noon  { background:#fff2df; color:#7a4d00; }
.row-night { background:#e7f0fb; color:#1646a2; }
.row-appt  { background:#f9e7ee; color:#9b1f79; }

/* ===================== æ”¾å°„æ¢ç‹€è½‰åœˆåœˆï¼ˆç°è—ï¼‰ ===================== */
@keyframes bars-fade { 0%{opacity:1} 100%{opacity:0} }
.spinner-bars{position:relative;display:inline-block;width:56px;height:56px}
.spinner-bars i{position:absolute;left:0;top:0;transform-origin:28px 28px;animation:bars-fade var(--spin-fade) linear infinite}
.spinner-bars i::after{content:"";position:absolute;top:3px;left:26px;width:4px;height:14px;border-radius:2px;background:var(--spin-color)}
.spinner-bars i:nth-child(1)  { transform:rotate(0deg);    animation-delay:-1.1s }
.spinner-bars i:nth-child(2)  { transform:rotate(30deg);   animation-delay:-1.0s }
.spinner-bars i:nth-child(3)  { transform:rotate(60deg);   animation-delay:-0.9s }
.spinner-bars i:nth-child(4)  { transform:rotate(90deg);   animation-delay:-0.8s }
.spinner-bars i:nth-child(5)  { transform:rotate(120deg);  animation-delay:-0.7s }
.spinner-bars i:nth-child(6)  { transform:rotate(150deg);  animation-delay:-0.6s }
.spinner-bars i:nth-child(7)  { transform:rotate(180deg);  animation-delay:-0.5s }
.spinner-bars i:nth-child(8)  { transform:rotate(210deg);  animation-delay:-0.4s }
.spinner-bars i:nth-child(9)  { transform:rotate(240deg);  animation-delay:-0.3s }
.spinner-bars i:nth-child(10) { transform:rotate(270deg);  animation-delay:-0.2s }
.spinner-bars i:nth-child(11) { transform:rotate(300deg);  animation-delay:-0.1s }
.spinner-bars i:nth-child(12) { transform:rotate(330deg);  animation-delay: 0s  }
.spinner-sm{width:22px;height:22px}
.spinner-sm i{transform-origin:11px 11px}
.spinner-sm i::after{top:1px;left:10px;width:2px;height:6px;border-radius:1px}

/* ===================== å…¨é é®ç½©ï¼ˆè½‰åœˆï¼‰ ===================== */
.loading-overlay{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center; flex-direction:column; gap:10px;
  z-index:9999; background:rgba(255,255,255,.94); backdrop-filter:blur(2px);
  color:#475569; font-size:16px; font-weight:700;
}

/* RWD */
@media (max-width:576px){
  .list-head, .list-row{grid-template-columns:1.2fr .7fr .7fr .9fr 1fr .6fr .8fr;font-size:14px}
  .cardish{margin:16px auto;padding:20px 14px}
}
</style>
</head>
<body>
<!-- ç­‰å¾…é®ç½©ï¼ˆè½‰åœˆåœˆï¼‰ -->
<div id="ing" class="loading-overlay">
  <span class="spinner-bars" aria-hidden="true">
    <i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
  </span>
  <div id="ingText" class="loading-text">è™•ç†ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
</div>

<div class="cardish">
  <div class="header">
    <div class="logo">ï¼‹</div>
    <h1>æŸ¥è©¢ï¼å–æ¶ˆé ç´„</h1>
  </div>

  <div class="note-bubble">
    ğŸ”¶ ç·šä¸Šå–æ¶ˆé ç´„çš„æˆªæ­¢æ™‚é–“ç‚ºé–€è¨ºå‰ä¸€å¤©ï¼›é–€è¨ºç•¶å¤©è«‹æ”¹ä»¥é›»è©±å–æ¶ˆã€‚è¨ºæ‰€é›»è©± (03) 515-2971 ğŸ”¶
  </div>

  <div id="normalBox">
    <div class="mb-3">
      <label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label>
      <input type="text" id="pid" class="form-control"
             placeholder="ä¾‹å¦‚ï¼šA123456789" maxlength="10" autocomplete="off"
             autocapitalize="characters" style="text-transform:uppercase">
    </div>
    <div class="d-grid gap-3">
      <button id="btnQuery" class="btn btn-main">æŸ¥è©¢</button>
      <a href="index.html" class="btn btn-outline-gray text-decoration-none text-center">è¿”å›é ç´„é¦–é </a>
    </div>
    <hr class="my-4">
  </div>

  <div id="result" style="display:none;">
    <div class="list-head">
      <div>æ—¥æœŸ</div><div>æ˜ŸæœŸ</div><div>è¨ºåˆ¥</div><div>æ™‚é–“</div><div>å§“å</div><div>è™Ÿç¢¼</div><div>æ“ä½œ</div>
    </div>
    <div id="list"></div>
    <div id="hint" class="text-muted mt-2" style="display:none;">ï¼ˆåƒ…é¡¯ç¤ºæœªå–æ¶ˆçš„é ç´„ï¼‰</div>
  </div>
</div>

<!-- reCAPTCHA v3ï¼ˆä¿æŒä½ çš„ SITE KEYï¼‰ -->
<script src="https://www.google.com/recaptcha/api.js?render=6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu"></script>

<script>
/* ====== åŸºæœ¬è¨­å®š ====== */
const API="https://script.google.com/macros/s/AKfycby37Sxk-a-q9hxqROALi1gmGhWGXWr2xw8WF_pdgMAN_9HvM1PZJfgN6TJnVrGw0x9W/exec";
const RECAPTCHA_SITE_KEY="6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu";

/* ====== å°å·¥å…· ====== */
function normalizeTaiwanId(raw){
  if(raw==null) return "";
  let s = String(raw).trim().normalize('NFKC'); // å…¨å½¢â†’åŠå½¢
  s = s.replace(/\s+/g,'');                      // å»ç©ºç™½
  s = s.toUpperCase();
  return s;
}

/* ====== è½‰åœˆæ§åˆ¶ ====== */
const $ing = document.getElementById('ing');
const $ingText = document.getElementById('ingText');
function showing(txt){ $ing.style.display='flex'; $ingText.textContent = txt || 'è™•ç†ä¸­ï¼Œè«‹ç¨å€™â€¦'; }
function hideing(){ $ing.style.display='none'; }

/* ====== reCAPTCHA ====== */
function recaptchaToken(action){
  return new Promise((resolve)=>{
    if(!RECAPTCHA_SITE_KEY){ resolve(''); return; }
    grecaptcha.ready(()=>{
      grecaptcha.execute(RECAPTCHA_SITE_KEY,{action:action||'query'})
        .then(resolve).catch(()=>resolve(''));
    });
  });
}

/* ====== DOM ====== */
const $pid  = document.getElementById('pid');
const $btn  = document.getElementById('btnQuery');
const $res  = document.getElementById('result');
const $list = document.getElementById('list');
const $hint = document.getElementById('hint');

/* è®“è¼¸å…¥å³æ™‚è½‰å¤§å¯«ï¼ˆä¸å½±éŸ¿æ¸¸æ¨™ä½ç½®ï¼‰ */
$pid.addEventListener('input', e=>{
  const el=e.target, s=el.selectionStart, epos=el.selectionEnd;
  const up=el.value.toUpperCase();
  if(el.value!==up){ el.value=up; try{el.setSelectionRange(s,epos);}catch(_){ } }
});

/* ====== å°æ‡‰æ¬„ä½èˆ‡é¡¯ç¤º ====== */
function slotKey(label){
  if(!label) return '';
  if(label.includes('æ—©')) return 'early';
  if(label.includes('åˆ')) return 'noon';
  if(label.includes('æ™š')) return 'night';
  if(label.includes('ç´„è¨º')) return 'appt';
  return '';
}
function weekday(ymd){
  const d = new Date(ymd+'T09:00:00+08:00');
  return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
}
function guessTime(slot){
  if(!slot) return '';
  if(slot.includes('æ—©')) return '08:30~11:30';
  if(slot.includes('åˆ')) return '14:00~17:00';
  if(slot.includes('æ™š')) return '18:00~20:30';
  if(slot.includes('ç´„è¨º')) return '09:00~12:00';
  return '';
}

function appendRow(item,pid){
  const ymd=item.date||'', w=weekday(ymd), t=item.time||guessTime(item.slot)||'';

  /* âœ… é‡é»ï¼šå…¼å®¹å¤šç¨®æ¬„ä½åç¨± */
  const seatNo = item.num ?? item.number ?? item.no ?? item.No ?? '-';

  /* æ˜¯å¦å¯å–æ¶ˆï¼šå…¼å®¹ canCancel / cancelable */
  const disableCancel = !(item.canCancel ?? item.cancelable ?? false);

  const key = slotKey(item.slot||'');
  const row=document.createElement('div');
  row.className='list-row '+(key?('row-'+key):'');

  row.innerHTML = `
    <div>${ymd||'-'}</div>
    <div>é€±${w||'-'}</div>
    <div>${item.slot||'-'}</div>
    <div>${t||'-'}</div>
    <div>${item.name||'-'}</div>
    <div>${seatNo}</div>
    <div>
      <button class="btn btn-cancel btn-sm" ${disableCancel?'disabled':''}>å–æ¶ˆ</button>
    </div>`;
  row.querySelector('.btn-cancel').onclick = () => { if(!disableCancel) cancelBooking(item.id, pid); };
  $list.appendChild(row);
}

/* ====== è¡Œç‚ºï¼šæŸ¥è©¢ï¼†å–æ¶ˆ ====== */
async function queryByPid(){
  const pid = normalizeTaiwanId($pid.value);
  if(!/^[A-Z][12]\d{8}$/.test(pid)){ alert('è«‹è¼¸å…¥æ­£ç¢ºçš„èº«åˆ†è­‰å­—è™Ÿ'); return; }
  showing('æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™â€¦');
  try{
    const token = await recaptchaToken('queryByPid');
    const r = await axios.get(API,{ params:{ action:'queryByPid', idnum: pid, recaptchaToken: token, t: Date.now() }});
    const payload = (typeof r.data === 'string') ? JSON.parse(r.data) : r.data;

    if(payload && payload.error === 'robot'){ alert('é©—è­‰æœªé€šéï¼Œè«‹é‡è©¦ã€‚'); return; }

    const rows = Array.isArray(payload?.items) ? payload.items.filter(x => !x.cancelled) : [];
    $list.innerHTML = ''; $res.style.display='block';
    if(rows.length===0){ $hint.style.display='none'; $list.innerHTML='<div class="text-muted">æŸ¥ç„¡æœªå–æ¶ˆé ç´„</div>'; return; }
    $hint.style.display='block'; rows.forEach(item => appendRow(item,pid));
  }catch(e){ console.error(e); alert('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'); }
  finally{ hideing(); }
}

async function cancelBooking(rowId, pid){
  if(!confirm(`ç¢ºèªå–æ¶ˆé€™ç­†é ç´„ï¼Ÿ`)) return;
  showing('å–æ¶ˆä¸­ï¼Œè«‹ç¨å€™â€¦');
  try{
    const token = await recaptchaToken('cancel');
    const resp = await axios.get(API,{
      params:{ action:'cancel', id:rowId, idnum:pid, recaptchaToken:token, t:Date.now() }
    });

    if(resp.data && resp.data.error === 'robot'){ alert('é©—è­‰æœªé€šéï¼Œè«‹é‡è©¦ã€‚'); return; }

    if(resp.data && (resp.data.ok||resp.data.success)){
      alert(resp.data.message||'å·²å–æ¶ˆè©²ç­†é ç´„ã€‚');
      await queryByPid();
    }else{
      alert((resp.data&&resp.data.message)||'å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }catch(e){
    console.error(e);
    alert('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{ hideing(); }
}

/* ç¶å®š */
document.getElementById('btnQuery').onclick=queryByPid;
$pid.addEventListener('keydown',e=>{ if(e.key==='Enter') queryByPid(); });
</script>
</body>
</html>
