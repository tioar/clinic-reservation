<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æŸ¥è©¢ï¼å–æ¶ˆé ç´„</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- ğŸ”µ LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {
  try {
    await liff.init({ liffId: '2007979306-0gl4PKb1' });
    if (liff.isInClient() && !liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return;
    }
    document.documentElement.classList.add('liff-ready');
  } catch (e) {
    console.error('LIFF init fail:', e);
  }
})();
</script>

<!-- ğŸ” CryptoJS (AES) -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script>
// èˆ‡ index/success ä¸€è‡´çš„é‡‘é‘°
const AES_KEY = "A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";
function aesEnc(payload, ttlMs = 10 * 60 * 1000) {
  const obj = { ...payload };
  if (ttlMs && Number.isFinite(ttlMs)) obj.exp = Date.now() + ttlMs;
  const plain = JSON.stringify(obj);
  const cipher = CryptoJS.AES.encrypt(plain, AES_KEY).toString();
  return encodeURIComponent(cipher);
}
function aesDec(cipherParam) {
  const bytes = CryptoJS.AES.decrypt(decodeURIComponent(cipherParam), AES_KEY);
  const text  = bytes.toString(CryptoJS.enc.Utf8);
  if (!text) throw new Error("DECRYPT_FAIL");
  const data = JSON.parse(text);
  if (data.exp && Date.now() > data.exp) throw new Error("TOKEN_EXPIRED");
  return data;
}
</script>

<style>
  .list-row{display:grid;grid-template-columns:1.1fr .9fr .7fr 1fr 1fr .6fr .6fr;gap:.5rem;align-items:center}
  .list-head{font-weight:700;color:#27485f;margin-bottom:.5rem}
  .btn-cancel{background:#dc3545;border:none;color:#fff}
  .btn-cancel:hover{background:#b02a37}
  #ing{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:9999;font-size:18px;color:#2e5a79;backdrop-filter:blur(2px)}
  #dots{display:inline-block;width:2ch;text-align:left}
</style>
</head>
<body>
<div id="ing">è™•ç†ä¸­è«‹ç¨ç­‰<span id="dots">...</span></div>

<div class="card" style="max-width:560px;margin:40px auto;">
  <div class="header">
    <div class="logo">ï¼‹</div>
    <h1>æŸ¥è©¢ï¼å–æ¶ˆé ç´„</h1>
  </div>

  <div class="mb-3">
    <label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label>
    <input type="text" id="pid" class="form-control" placeholder="ä¾‹å¦‚ï¼šA123456789" maxlength="10">
  </div>

  <div class="d-grid gap-2">
    <button id="btnQuery" class="btn-main">æŸ¥è©¢</button>
    <a href="index.html" class="btn btn-outline-secondary">è¿”å›é¦–é </a>
  </div>

  <hr class="my-4">

  <div id="result" style="display:none;">
    <div class="list-row list-head">
      <div>æ—¥æœŸ</div><div>æ˜ŸæœŸ</div><div>è¨ºåˆ¥</div><div>æ™‚é–“</div><div>å§“å</div><div>è™Ÿç¢¼</div><div>æ“ä½œ</div>
    </div>
    <div id="list"></div>
    <div id="hint" class="text-muted mt-2" style="display:none;">ï¼ˆåƒ…é¡¯ç¤ºæœªå–æ¶ˆçš„é ç´„ï¼‰</div>
  </div>
</div>

<script>
// âœ… èˆ‡å…¶ä»–é ç›¸åŒçš„ GAS
const API = "https://script.google.com/macros/s/AKfycbwzN5VFnM35ZQ0e316dUEcncVtBsUTrOxkKSGP6hua90p5LqeNSMREWYH-JOe7LXj8/exec";

// DOM
const $pid  = document.getElementById('pid');
const $btn  = document.getElementById('btnQuery');
const $res  = document.getElementById('result');
const $list = document.getElementById('list');
const $hint = document.getElementById('hint');
const $ing  = document.getElementById('ing');
const $dots = document.getElementById('dots');

let dotTimer=null;
function showing(txt){
  $ing.firstChild.nodeValue = (txt||'è™•ç†ä¸­è«‹ç¨ç­‰');
  $ing.style.display='flex';
  if(dotTimer) clearInterval(dotTimer);
  dotTimer = setInterval(()=>{
    $dots.textContent = $dots.textContent==='...' ? '.' : $dots.textContent+'.';
    if($dots.textContent.length>3) $dots.textContent='.';
  }, 340);
}
function hideing(){ if(dotTimer) clearInterval(dotTimer); $ing.style.display='none'; }

function weekday(ymd){
  const d = new Date(ymd+'T09:00:00+08:00');
  return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
}
function guessTime(slot){
  if(!slot) return '';
  if(slot.includes('æ—©')) return '08:00~11:00';
  if(slot.includes('åˆ')) return '14:00~17:00';
  if(slot.includes('æ™š')) return '18:00~20:30';
  return '';
}

// ğŸ” å¾ç¶²å€æˆ– session æ‹¿ booking idï¼ˆæ”¯æ´ cipher / idï¼‰
function getBookingIdFromURL(){
  const qs = new URLSearchParams(location.search);
  const cipher = qs.get('cipher');
  if (cipher){
    try{
      const data = aesDec(cipher);
      return data.id;
    }catch(e){
      console.warn('cipher è§£æå¤±æ•—/éæœŸ', e);
      alert('é€£çµå·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹æ”¹ç”¨èº«åˆ†è­‰å­—è™ŸæŸ¥è©¢ã€‚');
    }
  }
  const id = qs.get('id');
  if (id) return id;
  const backup = sessionStorage.getItem('lastBookingId');
  if (backup) return backup;
  return '';
}

// ğŸ§¾ ä»¥ booking idï¼ˆå–®ç­†ï¼‰æŸ¥è©¢ä¸¦æ¸²æŸ“æˆä¸€åˆ—
async function queryByBookingId(id){
  if(!id) return;
  showing('æŸ¥è©¢ä¸­è«‹ç¨ç­‰');
  try{
    const r = await axios.get(API, { params:{ action:'detail', id, t:Date.now() }});
    const d = (typeof r.data === 'string') ? JSON.parse(r.data) : r.data;
    if (!d || !d.date){
      alert('æŸ¥ç„¡æ­¤é ç´„');
      return;
    }

    // è‹¥å¾Œç«¯æœªæä¾› timeï¼Œä¾ç•¶æ—¥ slot å…œ time
    let timeTxt = d.time || '';
    if(!timeTxt){
      try{
        const s = await axios.get(API, { params:{ action:'getSlots', date: d.date }});
        const hit = (s.data||[]).find(x => String(x.label) === String(d.slot));
        timeTxt = hit?.time || guessTime(d.slot) || '';
      }catch(_){}
    }

    // æ¸²æŸ“ä¸€åˆ—
    $list.innerHTML = '';
    const row = document.createElement('div');
    row.className = 'list-row mb-2';
    row.innerHTML = `
      <div>${d.date}</div>
      <div>æ˜ŸæœŸ${weekday(d.date)}</div>
      <div>${d.slot||''}</div>
      <div>${timeTxt}</div>
      <div>${d.name||''}</div>
      <div>${d.num||''}</div>
      <div>
        <button class="btn btn-cancel btn-sm" data-id="${d.id||id}">å–æ¶ˆ</button>
      </div>
    `;
    row.querySelector('.btn-cancel').onclick = ()=> cancelById(d.id || id);
    $res.style.display='block';
    $hint.style.display='none';
  }catch(e){
    console.error(e);
    alert('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    hideing();
  }
}

// ğŸ‘¤ ä»¥èº«åˆ†è­‰å­—è™ŸæŸ¥è©¢ï¼ˆå¤šç­†ï¼‰
async function queryByPid(){
  const pid = $pid.value.trim().toUpperCase();
  if(!/^[A-Z][12]\d{8}$/.test(pid)){ alert('è«‹è¼¸å…¥æ­£ç¢ºçš„èº«åˆ†è­‰å­—è™Ÿ'); return; }
  showing('æŸ¥è©¢ä¸­è«‹ç¨ç­‰');

  try{
    const r = await axios.get(API,{ params:{ action:'queryByPid', idnum: pid, t: Date.now() }});
    const payload = (typeof r.data === 'string') ? JSON.parse(r.data) : r.data;

    // åªé¡¯ç¤ºæœªå–æ¶ˆ
    const rows = Array.isArray(payload?.items) ? payload.items.filter(x => !x.cancelled) : [];

    $list.innerHTML = '';
    $res.style.display='block';

    if(rows.length===0){
      $hint.style.display='none';
      $list.innerHTML = '<div class="text-muted">æŸ¥ç„¡æœªå–æ¶ˆé ç´„</div>';
      return;
    }

    $hint.style.display='block';

    rows.forEach(item=>{
      const ymd = item.date;
      const w = weekday(ymd);
      const t = item.time || guessTime(item.slot) || '';
      const row = document.createElement('div');
      row.className = 'list-row mb-2';
      row.innerHTML = `
        <div>${ymd}</div>
        <div>æ˜ŸæœŸ${w}</div>
        <div>${item.slot||''}</div>
        <div>${t}</div>
        <div>${item.name||''}</div>
        <div>${item.num||''}</div>
        <div>
          <button class="btn btn-cancel btn-sm" ${item.canCancel ? '' : 'disabled'} data-id="${item.id}">å–æ¶ˆ</button>
        </div>
      `;
      row.querySelector('.btn-cancel').onclick = ()=> cancelOne(item, pid);
      $list.appendChild(row);
    });
  }catch(e){
    console.error(e);
    alert('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    hideing();
  }
}

// âŒ ä»¥ booking id å–æ¶ˆï¼ˆå–®ç­†ï¼‰
async function cancelById(id){
  if(!id){ alert('ç¼ºå°‘é ç´„ä»£ç¢¼'); return; }
  if(!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ')) return;

  showing('å–æ¶ˆä¸­è«‹ç¨ç­‰');
  try{
    const resp = await axios.get(API,{ params:{ action:'cancel', id, t: Date.now() }});
    if(resp.data && (resp.data.ok || resp.data.success)){
      alert(resp.data.message || 'å·²å–æ¶ˆã€‚');
      // å–æ¶ˆå¾Œåˆ·æ–°ç•¶å‰ç•«é¢
      await queryByBookingId(id);
    }else{
      alert((resp.data && resp.data.message) || 'å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }catch(e){
    console.error(e);
    alert('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    hideing();
  }
}

// âŒ ä»¥èº«åˆ†è­‰å­—è™Ÿå–æ¶ˆï¼ˆå¾Œå‚™ï¼‰ï¼Œå¯èƒ½ä¸€æ¬¡å–æ¶ˆå¤šç­†
async function cancelOne(item, pid){
  if(!item?.canCancel){ return; }
  if(!confirm(`ç¢ºèªå–æ¶ˆï¼š\n${item.date}ï¼ˆ${item.slot}ï¼‰\n${item.name}  ç¬¬ ${item.num} è™Ÿï¼Ÿ`)) return;

  showing('å–æ¶ˆä¸­è«‹ç¨ç­‰');
  try{
    let resp = await axios.get(API,{ params:{ action:'cancel', id: item.id, t: Date.now() }});
    if(!(resp.data && (resp.data.ok || resp.data.success))){
      // å¾Œå‚™ï¼šä»¥èº«åˆ†è­‰å­—è™Ÿå–æ¶ˆæ­¤èº«åˆ†çš„æœªå–æ¶ˆé ç´„
      resp = await axios.get(API,{ params:{ action:'cancel', idnum: pid, t: Date.now() }});
    }

    if(resp.data && (resp.data.ok || resp.data.success)){
      alert(resp.data.message || 'å·²å–æ¶ˆã€‚');
      await queryByPid(); // é‡æ–°æŸ¥åˆ—è¡¨
    }else{
      alert((resp.data && resp.data.message) || 'å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }catch(e){
    console.error(e);
    alert('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    hideing();
  }
}

// ç¶å®šäº‹ä»¶
$btn.addEventListener('click', queryByPid);
$pid.addEventListener('keydown', e=>{ if(e.key==='Enter') queryByPid(); });
$pid.addEventListener('input', e=>{
  e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,10);
});

// åˆå§‹ï¼šè‹¥ç¶²å€å¸¶ cipher æˆ– idï¼Œç›´æ¥ä»¥ booking id æŸ¥è©¢
(function init(){
  const id = getBookingIdFromURL();
  if (id){
    sessionStorage.setItem('lastBookingId', String(id));
    queryByBookingId(id);
  }
})();
</script>
</body>
</html>
