<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>陳萬龍診所門診查詢／取消預約</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="favicon.png">
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
  /* 版面微調（沿用紫色主題變數） */
  .wrap { max-width:560px; margin:40px auto; }
  .header{ display:flex; align-items:center; gap:12px; margin-bottom:6px; }
  .logo{ width:48px; height:48px; border-radius:50%; display:grid; place-items:center; background:var(--main); color:#fff; font-weight:900; font-size:24px; }
  .header h1{ margin:0; font-size:1.25rem; font-weight:800; color:var(--main); }
  /* 注意事項：獨立一行，與 logo 左緣對齊 */
  .subnote{ margin:8px 0 0 60px; color:var(--muted); background:#f6f2fc; border:1px solid #ebe6fb; border-radius:12px; padding:10px 12px; font-weight:700; }
  /* 列表 */
  .list-row{display:grid;grid-template-columns:1.1fr .9fr .7fr 1fr 1fr .6fr .8fr;gap:.5rem;align-items:center}
  .list-head{font-weight:800;color:#3d3d57;margin-bottom:.5rem}
  .btn-cancel{background:var(--danger);border:none;color:#fff}
  .btn-cancel:hover{background:var(--danger-hover)}
  /* Loading 遮罩 */
  #ing{position:fixed;inset:0;background:rgba(255,255,255,.88);display:none;align-items:center;justify-content:center;z-index:9999;font-size:18px;color:var(--hover);backdrop-filter:blur(2px)}
  #dots{display:inline-block;width:2ch;text-align:left}
  @media (max-width:576px){
    .list-row{grid-template-columns:1.1fr .7fr .7fr .9fr 1fr .6fr .8fr}
    .subnote{ margin-left:56px; }
  }
</style>
</head>
<body>
<div id="ing">處理中請稍等<span id="dots">...</span></div>

<div class="card wrap">
  <!-- 標題 + 注意事項（注意事項獨立一行） -->
  <div class="header">
    <div class="logo">＋</div>
    <h1>查詢／取消預約</h1>
  </div>
  <div class="subnote">
    線上取消預約只能在預約的門診前一天執行；門診當天請改以電話取消，謝謝。
  </div>

  <!-- 查詢區 -->
  <div id="normalBox" class="p-3">
    <div class="mb-3">
      <label class="form-label">身分證字號</label>
      <input type="text" id="pid" class="form-control" placeholder="例如：A123456789" maxlength="10" autocomplete="off">
    </div>
    <div class="d-grid gap-2">
      <button id="btnQuery" class="btn btn-main">查詢</button>
      <a href="index.html" class="btn btn-outline-secondary">返回首頁</a>
    </div>
    <hr class="my-4">
  </div>

  <!-- 結果列表 -->
  <div id="result" style="display:none;" class="p-3 pt-0">
    <div class="list-row list-head">
      <div>日期</div><div>星期</div><div>診別</div><div>時間</div><div>姓名</div><div>號碼</div><div>操作</div>
    </div>
    <div id="list"></div>
    <div id="hint" class="text-muted mt-2" style="display:none;">（僅顯示未取消的預約）</div>
  </div>
</div>

<script>
/* ===== 設定 ===== */
const API = "https://script.google.com/macros/s/AKfycbzRmUag-TbdRifSp0xB2i4VSH12d3bx5QqawHF0LUM9wqs1iIcRhZX62B0xqqPnX7o9/exec";

/* reCAPTCHA v3（有填就用，沒填會自動略過） */
const RECAPTCHA_SITE_KEY = "6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu";
let recaptchaLoaded=false, recaptchaLoading=null;
function loadRecaptcha(){
  if(!RECAPTCHA_SITE_KEY) return Promise.resolve();
  if(recaptchaLoaded) return Promise.resolve();
  if(recaptchaLoading) return recaptchaLoading;
  recaptchaLoading = new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src='https://www.google.com/recaptcha/api.js?render='+encodeURIComponent(RECAPTCHA_SITE_KEY);
    s.async=true; s.defer=true;
    s.onload=()=>{recaptchaLoaded=true;resolve();};
    s.onerror=()=>reject(new Error('recaptcha_load_fail'));
    document.head.appendChild(s);
  });
  return recaptchaLoading;
}
async function getRecaptchaToken(action='query'){
  try{
    if(!RECAPTCHA_SITE_KEY) return '';
    await loadRecaptcha();
    return await new Promise(res=>{
      grecaptcha.ready(()=> grecaptcha.execute(RECAPTCHA_SITE_KEY,{action}).then(t=>res(t)).catch(()=>res('')));
    });
  }catch(_){ return ''; }
}

/* ===== DOM ===== */
const $pid  = document.getElementById('pid');
const $btn  = document.getElementById('btnQuery');
const $res  = document.getElementById('result');
const $list = document.getElementById('list');
const $hint = document.getElementById('hint');
const $ing  = document.getElementById('ing');
const $dots = document.getElementById('dots');

/* ===== Loading 點點 ===== */
let dotTimer=null;
function showing(txt){
  $ing.firstChild.nodeValue = (txt||'處理中請稍等');
  $ing.style.display='flex';
  if(dotTimer) clearInterval(dotTimer);
  dotTimer = setInterval(()=>{
    $dots.textContent = $dots.textContent==='...' ? '.' : $dots.textContent+'.';
    if($dots.textContent.length>3) $dots.textContent='.';
  }, 340);
}
function hideing(){ if(dotTimer) clearInterval(dotTimer); $ing.style.display='none'; }

/* ===== 小工具 ===== */
function weekday(ymd){
  const d = new Date(ymd+'T09:00:00+08:00');
  return ['日','一','二','三','四','五','六'][d.getDay()];
}
function guessTime(slot){
  if(!slot) return '';
  if(slot.includes('早')) return '08:00~11:00';
  if(slot.includes('午')) return '14:00~17:00';
  if(slot.includes('晚')) return '18:00~20:30';
  return '';
}
function todayYmd(){
  const z = new Date();
  const yyyy = z.getFullYear();
  const mm = ('0'+(z.getMonth()+1)).slice(-2);
  const dd = ('0'+z.getDate()).slice(-2);
  return `${yyyy}-${mm}-${dd}`;
}

/* ===== 查詢（身分證） ===== */
async function queryByPid(){
  const pid = $pid.value.trim().toUpperCase();
  if(!/^[A-Z][12]\d{8}$/.test(pid)){ alert('請輸入正確的身分證字號'); return; }

  showing('查詢中請稍等');
  try{
    const recaptchaToken = await getRecaptchaToken('query');
    const r = await axios.get(API,{ params:{ action:'queryByPid', idnum: pid, recaptchaToken, t: Date.now() }});
    const payload = (typeof r.data === 'string') ? JSON.parse(r.data) : r.data;

    if(payload?.error === 'robot'){ alert('機器人驗證未通過，請重新操作'); return; }

    // 僅顯示未取消
    const rows = Array.isArray(payload?.items) ? payload.items.filter(x => !x.cancelled) : [];

    $list.innerHTML = '';
    $res.style.display='block';

    if(rows.length===0){
      $hint.style.display='none';
      $list.innerHTML = '<div class="text-muted">查無未取消預約</div>';
      return;
    }

    $hint.style.display='block';
    rows.forEach(item => appendRow(item, pid));
  }catch(e){
    console.error(e);
    alert('查詢失敗，請稍後再試');
  }finally{
    hideing();
  }
}

/* ===== 渲染一列（當天禁用取消） ===== */
function appendRow(item, pid){
  const ymd = item.date || '';
  const w   = weekday(ymd);
  const t   = item.time || guessTime(item.slot) || '';

  const disableCancel = (ymd === todayYmd()); // 當天不可取消（前端保險）

  const row = document.createElement('div');
  row.className = 'list-row mb-2';
  row.innerHTML = `
    <div>${ymd}</div>
    <div>星期${w}</div>
    <div>${item.slot||''}</div>
    <div>${t}</div>
    <div>${item.name||''}</div>
    <div>${item.num||''}</div>
    <div>
      <button class="btn btn-cancel btn-sm" ${disableCancel ? 'disabled' : ''} data-id="${item.id||''}">取消</button>
    </div>
  `;
  const btn = row.querySelector('.btn-cancel');
  btn.onclick = () => {
    if(disableCancel) return;
    cancelByPid(pid);
  };
  $list.appendChild(row);
}

/* ===== 取消（用身分證） ===== */
async function cancelByPid(pid){
  const ok = confirm(`確認取消此身分證字號 ${pid} 的所有未取消預約？\n（僅能取消非當天門診）`);
  if(!ok) return;

  showing('取消中請稍等');
  try{
    const recaptchaToken = await getRecaptchaToken('cancel');
    const resp = await axios.get(API,{ params:{ action:'cancel', idnum: pid, recaptchaToken, t: Date.now() }});
    if(resp.data && (resp.data.ok || resp.data.success)){
      alert(resp.data.message || '已取消符合規則的預約。');
      await queryByPid(); // 重新查詢
    }else{
      alert((resp.data && resp.data.message) || '取消失敗，請稍後再試');
    }
  }catch(e){
    console.error(e);
    alert('取消失敗，請稍後再試');
  }finally{
    hideing();
  }
}

/* ===== 綁定事件與輸入限制 ===== */
document.getElementById('btnQuery').onclick = queryByPid;
document.getElementById('pid').addEventListener('input', e=>{
  e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,10);
});
document.getElementById('pid').addEventListener('keydown', e=>{
  if(e.key === 'Enter') queryByPid();
});

/* 預載 reCAPTCHA（若有 key） */
loadRecaptcha().catch(()=>{});
</script>
</body>
</html>
