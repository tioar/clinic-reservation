<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é™³è¬é¾è¨ºæ‰€é–€è¨ºæŸ¥è©¢ï¼å–æ¶ˆé ç´„</title>

<!-- Google Fontsï¼šèˆ‡ index ä¸€è‡´ï¼ˆ400/600/800/900ï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800;900&display=swap" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="favicon.png">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  /* â†“ é€™å…©å€‹ä¿æŒä½ çš„æ—¢æœ‰è¨­å®šå³å¯ï¼ˆå¦‚éœ€æ›ï¼Œæ”¹é€™è£¡ï¼‰ */
  const API = "https://script.google.com/macros/s/AKfycby37Sxk-a-q9hxqROALi1gmGhWGXWr2xw8WF_pdgMAN_9HvM1PZJfgN6TJnVrGw0x9W/exec";
  const RECAPTCHA_SITE_KEY = "6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu";
</script>

<!-- reCAPTCHA v3 -->
<script src="https://www.google.com/recaptcha/api.js?render=6LdqprArAAAAACpuAXemZUH3KNER1t1iw07YjGHu"></script>

<style>
  :root{
    --purple:#6236a7;
    --purple-600:#4b2c86;
    --ink:#2a2341;
    --line:#ebe6fb;
    --outline:#cfd3de;
    --outline-text:#5c6170;
  }
  body{
    background:#f4eefc;
    /* èˆ‡ index ä¸€è‡´çš„å­—é«”é †åº */
    font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
  }
  .card{
    max-width:780px; margin:32px auto; padding:28px 22px 32px;
    border-radius:24px; border:1px solid var(--line); background:#fff;
    box-shadow:0 12px 28px rgba(98,54,167,.10);
  }

  /* æ¨™é¡Œ */
  .header{ display:flex; align-items:center; justify-content:center; gap:14px; margin-bottom:14px; text-align:center; }
  .logo{ width:60px;height:60px;border-radius:50%;display:grid;place-items:center;background:var(--purple);color:#fff;font-weight:900;font-size:32px;box-shadow:0 6px 14px rgba(98,54,167,.20);}
  .header h1{ margin:0; font-size:2rem; font-weight:900; color:var(--ink); }

  .note-bubble{ margin:10px 0 14px 0; padding:12px 14px; background:#f4f0ff; border:1px solid var(--line); border-radius:12px; color:#6b5f92; font-weight:700; font-size:.95rem; }
  .form-label{ font-weight:800; color:#2f2750; }
  .list-head div{ font-weight:800; color:#2f2750; }

  /* è† å›ŠæŒ‰éˆ• */
  .btn-pill{ border-radius:50rem; font-weight:800; padding:1rem 1.25rem; }
  .btn-main{ background:var(--purple); color:#fff; border:none; }
  .btn-main:hover{ background:var(--purple-600); color:#fff; }
  .btn-outline-gray{ background:#fff; color:#5c6170; border:2px solid var(--outline); }
  .btn-outline-gray:hover{ background:#f7f8fb; color:#3a3f47; border-color:#bfc6d2; }

  /* çµæœåˆ—è¡¨ */
  .list-row{display:grid;grid-template-columns:1.1fr .9fr .7fr 1fr 1fr .6fr .8fr;gap:.5rem;align-items:center; padding:6px 10px; border-radius:12px; font-weight:600;}
  .row-early { background:#e7f7ee; color:#0f5132; }
  .row-noon  { background:#fff3df; color:#7a4d00; }
  .row-night { background:#e8f2ff; color:#1d4ed8; }
  .row-appt  { background:#fde7ef; color:#b51695; } /* ç´„è¨ºï¼šæ´‹ç´… */
  .row-closed{ background:#ffe6e6; color:#b02a37; }

  .btn-cancel{background:#dc3545;border:none;color:#fff;font-weight:700;border-radius:50rem;padding:0.25rem 0.75rem;}
  .btn-cancel:hover{background:#b02a37}

  /* ç¦ç”¨ç‹€æ…‹ï¼ˆç°è‰²ã€ä¸å¯é»ï¼‰ */
  .btn-cancel:disabled{
    background:#adb5bd !important;
    color:#fff !important;
    cursor:not-allowed !important;
    opacity:1 !important;
  }

  /* é®ç½© */
  #ing{position:fixed;inset:0;background:rgba(255,255,255,.9);display:none;align-items:center;justify-content:center;z-index:9999;font-size:18px;color:var(--purple-600);backdrop-filter:blur(2px)}
  #dots{display:inline-block;width:2ch;text-align:left}
  @media (max-width:576px){
    .list-row{grid-template-columns:1.2fr .7fr .7fr .9fr 1fr .6fr .8fr;font-size:14px;}
  }
</style>
</head>
<body>
<div id="ing" class="loading-overlay" style="display:none">
  <div class="spinner-border" role="status" aria-hidden="true"></div>
  <div id="ingText" class="loading-text">æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™</div>
</div>


<div class="card">
  <div class="header">
    <div class="logo">ï¼‹</div>
    <h1>æŸ¥è©¢ï¼å–æ¶ˆé ç´„</h1>
  </div>

  <div class="note-bubble">
    ğŸ”¶ç·šä¸Šå–æ¶ˆé ç´„çš„æˆªæ­¢æ™‚é–“ç‚ºé–€è¨ºå‰ä¸€å¤©ï¼›é–€è¨ºç•¶å¤©è«‹æ”¹ä»¥é›»è©±å–æ¶ˆã€‚è¨ºæ‰€é›»è©±(03)5152971ğŸ”¶
  </div>

  <div id="normalBox">
    <div class="mb-3">
      <label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label>
      <!-- â‘  è¦–è¦ºå¤§å¯« â‘¡ iOS å»ºè­°ç”¨è‹±æ–‡å­—æ¯å¤§å¯« -->
      <input type="text" id="pid" class="form-control"
             placeholder="ä¾‹å¦‚ï¼šA123456789" maxlength="10" autocomplete="off"
             autocapitalize="characters" style="text-transform:uppercase">
    </div>
    <div class="d-grid gap-3">
      <button id="btnQuery" class="btn btn-pill btn-main">æŸ¥è©¢</button>
      <a href="index.html" class="btn btn-pill btn-outline-gray text-decoration-none text-center">è¿”å›é ç´„é¦–é </a>
    </div>
    <hr class="my-4">
  </div>

  <div id="result" style="display:none;">
    <div class="list-row list-head" style="background:none; font-weight:800;">
      <div>æ—¥æœŸ</div><div>æ˜ŸæœŸ</div><div>è¨ºåˆ¥</div><div>æ™‚é–“</div><div>å§“å</div><div>è™Ÿç¢¼</div><div>æ“ä½œ</div>
    </div>
    <div id="list"></div>
    <div id="hint" class="text-muted mt-2" style="display:none;">ï¼ˆåƒ…é¡¯ç¤ºæœªå–æ¶ˆçš„é ç´„ï¼‰</div>
  </div>
</div>

<script>
function slotKey(label){
  if(!label) return '';
  if(label.includes('æ—©')) return 'early';
  if(label.includes('åˆ')) return 'noon';
  iflabel = label.includes('æ™š'); if(label.includes('æ™š')) return 'night';
  if(label.includes('ç´„è¨º')) return 'appt';
  if(label.includes('æœªé–‹æ”¾')) return 'closed';
  return '';
}

const $pid  = document.getElementById('pid');
const $btn  = document.getElementById('btnQuery');
const $res  = document.getElementById('result');
const $list = document.getElementById('list');
const $hint = document.getElementById('hint');
const $ing  = document.getElementById('ing');
const $dots = document.getElementById('dots');

/* â‘¢ å¯¦éš›å€¼å³æ™‚è½‰å¤§å¯«ï¼ˆä¸å½±éŸ¿æ¸¸æ¨™ä½ç½®ï¼‰ */
$pid.addEventListener('input', (e)=>{
  const el = e.target;
  const start = el.selectionStart, end = el.selectionEnd;
  const up = el.value.toUpperCase();
  if(el.value !== up){
    el.value = up;
    try{ el.setSelectionRange(start, end); }catch(_){}
  }
});

/* é®ç½©å‹•ç•« */
let dotTimer=null;
function showing(txt){
  $ing.childNodes[0].nodeValue = (txt||'è™•ç†ä¸­è«‹ç¨ç­‰');
  $ing.style.display='flex';
  if(dotTimer) clearInterval(dotTimer);
  dotTimer = setInterval(()=>{
    $dots.textContent = $dots.textContent==='...' ? '.' : $dots.textContent+'.';
    if($dots.textContent.length>3) $dots.textContent='.';
  }, 340);
}
function hideing(){ if(dotTimer) clearInterval(dotTimer); $ing.style.display='none'; }

/* å–å¾— reCAPTCHA tokenï¼ˆè‹¥è¼‰ä¸åˆ°ä¹Ÿå›ç©ºå­—ä¸²ï¼Œé¿å…å¡æµç¨‹ï¼‰ */
function recaptchaToken(action){
  return new Promise((resolve)=>{
    if(!window.grecaptcha){ resolve(''); return; }
    grecaptcha.ready(()=>{
      grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: action||'query'})
        .then(resolve)
        .catch(()=>resolve(''));
    });
  });
}

async function queryByPid(){
  const pid = $pid.value.trim().toUpperCase();
  if(!/^[A-Z][12]\d{8}$/.test(pid)){ alert('è«‹è¼¸å…¥æ­£ç¢ºçš„èº«åˆ†è­‰å­—è™Ÿ'); return; }
  showing('æŸ¥è©¢ä¸­è«‹ç¨ç­‰');
  try{
    const token = await recaptchaToken('queryByPid');
    const r = await axios.get(API,{ params:{ action:'queryByPid', idnum: pid, recaptchaToken: token, t: Date.now() }});
    const payload = (typeof r.data === 'string') ? JSON.parse(r.data) : r.data;

    if(payload && payload.error === 'robot'){ alert('é©—è­‰æœªé€šéï¼Œè«‹é‡è©¦ã€‚'); return; }

    const rows = Array.isArray(payload?.items) ? payload.items.filter(x => !x.cancelled) : [];
    $list.innerHTML = ''; $res.style.display='block';
    if(rows.length===0){ $hint.style.display='none'; $list.innerHTML='<div class="text-muted">æŸ¥ç„¡æœªå–æ¶ˆé ç´„</div>'; return; }
    $hint.style.display='block'; rows.forEach(item => appendRow(item,pid));
  }catch(e){ console.error(e); alert('æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'); }
  finally{ hideing(); }
}

function weekday(ymd){
  const d = new Date(ymd+'T09:00:00+08:00');
  return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
}
function guessTime(slot){
  if(!slot) return '';
  if(slot.includes('æ—©')) return '08:30~11:30';
  if(slot.includes('åˆ')) return '14:00~17:00';
  ifslot = slot.includes('æ™š'); if(slot.includes('æ™š')) return '18:00~20:30';
  if(slot.includes('ç´„è¨º')) return '09:00~12:00';
  return '';
}

function appendRow(item,pid){
  const ymd=item.date||'', w=weekday(ymd), t=item.time||guessTime(item.slot)||'';
  const disableCancel = !item.canCancel;
  const key = slotKey(item.slot||'');
  const row=document.createElement('div');
  row.className='list-row row-'+key+' mb-2';
  row.innerHTML=`
    <div>${ymd}</div><div>æ˜ŸæœŸ${w}</div><div>${item.slot||''}</div>
    <div>${t}</div><div>${item.name||''}</div><div>${item.num||''}</div>
    <div>
      <button class="btn btn-cancel btn-sm"
              ${disableCancel ? 'disabled title="ç•¶å¤©æˆ–å·²éæœŸï¼Œè«‹æ”¹é›»è©±å–æ¶ˆ"' : ''}>
        å–æ¶ˆ
      </button>
    </div>`;

  row.querySelector('.btn-cancel').onclick = () => {
    if (!disableCancel) cancelBooking(item.id, pid);
  };

  $list.appendChild(row);
}

async function cancelBooking(rowId, pid){
  if(!confirm(`ç¢ºèªå–æ¶ˆé€™ç­†é ç´„ï¼Ÿ`)) return;
  showing('å–æ¶ˆä¸­è«‹ç¨ç­‰');
  try{
    const token = await recaptchaToken('cancel');
    const resp = await axios.get(API, {
      params:{
        action:'cancel',
        id: rowId,
        idnum: pid,
        recaptchaToken: token,
        t: Date.now()
      }
    });
    if(resp.data && resp.data.error === 'robot'){
      alert('é©—è­‰æœªé€šéï¼Œè«‹é‡è©¦ã€‚');
      return;
    }
    if(resp.data && (resp.data.ok||resp.data.success)){
      alert(resp.data.message||'å·²å–æ¶ˆè©²ç­†é ç´„ã€‚');
      await queryByPid();
    }else{
      alert((resp.data&&resp.data.message)||'å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }catch(e){
    console.error(e);
    alert('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }finally{
    hideing();
  }
}

$btn.onclick=queryByPid;
$pid.addEventListener('keydown',e=>{ if(e.key==='Enter') queryByPid(); });
</script>
</body>
</html>





