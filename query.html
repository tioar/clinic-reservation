<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>查詢／取消預約</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
  /* 小幅補充：列表對齊 & 紅色按鈕 */
  .list-row{display:grid;grid-template-columns:1.1fr .9fr .7fr 1fr 1fr .6fr .6fr;gap:.5rem;align-items:center}
  .list-head{font-weight:700;color:#27485f;margin-bottom:.5rem}
  .btn-cancel{background:#dc3545;border:none}
  .btn-cancel:hover{background:#b02a37}
  /* 全螢幕 Loading overlay（與 success 一致的體驗） */
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:9999;font-size:18px;color:#2e5a79;backdrop-filter:blur(2px)}
  #dots{display:inline-block;width:2ch;text-align:left}
</style>
</head>
<body>
<div id="loading">處理中請稍等<span id="dots">...</span></div>

<div class="card" style="max-width:560px;margin:40px auto;">
  <div class="header">
    <div class="logo">＋</div>
    <h1>查詢／取消預約</h1>
  </div>

  <div class="mb-3">
    <label class="form-label">身分證字號</label>
    <input type="text" id="pid" class="form-control" placeholder="例如：A123456789" maxlength="10">
  </div>

  <div class="d-grid gap-2">
    <button id="btnQuery" class="btn-main">查詢</button>
    <a href="index.html" class="btn btn-outline-secondary">返回首頁</a>
  </div>

  <hr class="my-4">

  <div id="result" style="display:none;">
    <div class="list-row list-head">
      <div>日期</div><div>星期</div><div>診別</div><div>時間</div><div>姓名</div><div>號碼</div><div>操作</div>
    </div>
    <div id="list"></div>
    <div id="hint" class="text-muted mt-2" style="display:none;">（僅顯示未取消的預約）</div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxsOExfA5g1rpeW-eaC3btBv3t9YmOxZlTF77O37lNlzfLRuwndnZREi0Cf_3xF9Ek/exec";

const $pid = document.getElementById('pid');
const $btn = document.getElementById('btnQuery');
const $res = document.getElementById('result');
const $list = document.getElementById('list');
const $hint = document.getElementById('hint');
const $loading = document.getElementById('loading');
const $dots = document.getElementById('dots');

let dotTimer=null;
function showLoading(txt){
  $loading.firstChild.nodeValue = (txt||'處理中請稍等');
  $loading.style.display='flex';
  if(dotTimer) clearInterval(dotTimer);
  dotTimer = setInterval(()=>{
    $dots.textContent = $dots.textContent==='...' ? '.' : $dots.textContent+'.';
    if($dots.textContent.length>3) $dots.textContent='.';
  }, 340);
}
function hideLoading(){ if(dotTimer) clearInterval(dotTimer); $loading.style.display='none'; }

function weekday(ymd){
  const d = new Date(ymd+'T09:00:00+08:00');
  return ['日','一','二','三','四','五','六'][d.getDay()];
}
function guessTime(slot){
  if(!slot) return '';
  if(slot.includes('早')) return '08:00~11:00';
  if(slot.includes('午')) return '14:00~17:00';
  if(slot.includes('晚')) return '18:00~20:30';
  return '';
}

async function query(){
  const pid = $pid.value.trim().toUpperCase();
  if(!/^[A-Z][12]\d{8}$/.test(pid)){ alert('請輸入正確的身分證字號'); return; }
  showLoading('查詢中請稍等');

  try{
    const r = await axios.get(API,{params:{action:'listByPid', pid}});
    const rows = Array.isArray(r.data)? r.data : [];
    $list.innerHTML = '';
    if(rows.length===0){
      $res.style.display='block';
      $hint.style.display='none';
      $list.innerHTML = '<div class="text-muted">查無未取消預約</div>';
      return;
    }
    $res.style.display='block';
    $hint.style.display='block';

    rows.forEach(item=>{
      // item: {id,date,slot,name,num,time}
      const ymd = item.date;
      const w = weekday(ymd);
      const t = item.time || guessTime(item.slot) || '';
      const row = document.createElement('div');
      row.className = 'list-row mb-2';
      row.innerHTML = `
        <div>${ymd}</div>
        <div>星期${w}</div>
        <div>${item.slot||''}</div>
        <div>${t}</div>
        <div>${item.name||''}</div>
        <div>${item.num||''}</div>
        <div>
          <button class="btn btn-cancel btn-sm" data-id="${item.id}">取消</button>
        </div>
      `;
      row.querySelector('.btn-cancel').onclick = ()=> cancel(item.id, ymd, item.slot, item.name, item.num);
      $list.appendChild(row);
    });
  }catch(e){
    console.error(e);
    alert('查詢失敗，請稍後再試');
  }finally{
    hideLoading();
  }
}

async function cancel(id, ymd, slot, name, num){
  if(!confirm(`確認取消：\n${ymd}（${slot}）\n${name}  第 ${num} 號？`)) return;
  showLoading('取消中請稍等');
  try{
    const r = await axios.get(API,{params:{action:'cancel', id}});
    if(r.data && r.data.ok){
      alert('已取消。');
      await query(); // 重新查一次列表
    }else{
      alert('取消失敗，請稍後再試');
    }
  }catch(e){
    console.error(e);
    alert('取消失敗，請稍後再試');
  }finally{
    hideLoading();
  }
}

$btn.onclick = query;
$pid.addEventListener('input', e=>{
  e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,10);
});
</script>
</body>
</html>
