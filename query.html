<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>查詢／取消預約</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
(async () => {
  try {
    await liff.init({ liffId: '2007979306-0gl4PKb1' });
    if (liff.isInClient() && !liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return;
    }
    document.documentElement.classList.add('liff-ready');
  } catch (e) {
    console.error('LIFF init fail:', e);
  }
})();
</script>

<!-- CryptoJS (AES) -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script>
// === 常數 ===
const API = "https://script.google.com/macros/s/AKfycbwzN5VFnM35ZQ0e316dUEcncVtBsUTrOxkKSGP6hua90p5LqeNSMREWYH-JOe7LXj8/exec";
const AES_KEY = "A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";

// === AES ===
function aesDec(v){
  const txt = CryptoJS.AES.decrypt(decodeURIComponent(v), AES_KEY).toString(CryptoJS.enc.Utf8);
  if(!txt) throw new Error("DECRYPT_FAIL");
  const data = JSON.parse(txt);
  if(data.exp && Date.now() > data.exp) throw new Error("TOKEN_EXPIRED");
  return data;
}

// === URL 工具（支援 liff.state）+ 清參數 ===
function getSearchParamsAnywhere(){
  const p = new URLSearchParams(location.search);
  const state = p.get('liff.state');
  if(state){
    const u = new URL(state, location.origin);
    return new URLSearchParams(u.search);
  }
  return p;
}
function scrubUrl(newPathName){
  history.replaceState({}, "", newPathName || location.pathname);
}

// === 日期工具 ===
function weekday(ymd){
  const d = new Date(ymd+'T09:00:00+08:00');
  return ['日','一','二','三','四','五','六'][d.getDay()];
}
function guessTime(slot){
  if(!slot) return '';
  if(slot.includes('早')) return '08:00~11:00';
  if(slot.includes('午')) return '14:00~17:00';
  if(slot.includes('晚')) return '18:00~20:30';
  return '';
}
</script>

<style>
  .list-row{display:grid;grid-template-columns:1.1fr .9fr .7fr 1fr 1fr .6fr .6fr;gap:.5rem;align-items:center}
  .list-head{font-weight:700;color:#27485f;margin-bottom:.5rem}
  .btn-cancel{background:#dc3545;border:none;color:#fff}
  .btn-cancel:hover{background:#b02a37}
  #ing{position:fixed;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:9999;font-size:18px;color:#2e5a79;backdrop-filter:blur(2px)}
  #dots{display:inline-block;width:2ch;text-align:left}
</style>
</head>
<body>
<div id="ing">處理中請稍等<span id="dots">...</span></div>

<div class="card" style="max-width:560px;margin:40px auto;">
  <div class="header">
    <div class="logo">＋</div>
    <h1>查詢／取消預約</h1>
  </div>

  <!-- 一般查詢區 -->
  <div id="normalBox">
    <div class="mb-3">
      <label class="form-label">身分證字號</label>
      <input type="text" id="pid" class="form-control" placeholder="例如：A123456789" maxlength="10">
    </div>
    <div class="d-grid gap-2">
      <button id="btnQuery" class="btn-main">查詢</button>
      <a href="index.html" class="btn btn-outline-secondary">返回首頁</a>
    </div>
    <hr class="my-4">
  </div>

  <!-- 結果列表 -->
  <div id="result" style="display:none;">
    <div class="list-row list-head">
      <div>日期</div><div>星期</div><div>診別</div><div>時間</div><div>姓名</div><div>號碼</div><div>操作</div>
    </div>
    <div id="list"></div>
    <div id="hint" class="text-muted mt-2" style="display:none;">（僅顯示未取消的預約）</div>
  </div>
</div>

<script>
const $pid = document.getElementById('pid');
const $btn = document.getElementById('btnQuery');
const $res = document.getElementById('result');
const $list = document.getElementById('list');
const $hint = document.getElementById('hint');
const $ing = document.getElementById('ing');
const $dots = document.getElementById('dots');
const $normal = document.getElementById('normalBox');

let dotTimer=null;
function showing(txt){
  $ing.firstChild.nodeValue = (txt||'處理中請稍等');
  $ing.style.display='flex';
  if(dotTimer) clearInterval(dotTimer);
  dotTimer = setInterval(()=>{
    $dots.textContent = $dots.textContent==='...' ? '.' : $dots.textContent+'.';
    if($dots.textContent.length>3) $dots.textContent='.';
  }, 340);
}
function hideing(){ if(dotTimer) clearInterval(dotTimer); $ing.style.display='none'; }

// === 以身分證字號查詢（原功能） ===
async function queryByPid(){
  const pid = $pid.value.trim().toUpperCase();
  if(!/^[A-Z][12]\d{8}$/.test(pid)){ alert('請輸入正確的身分證字號'); return; }
  showing('查詢中請稍等');

  try{
    const r = await axios.get(API,{ params:{ action:'queryByPid', idnum: pid, t: Date.now() }});
    const payload = (typeof r.data === 'string') ? JSON.parse(r.data) : r.data;
    const rows = Array.isArray(payload?.items) ? payload.items.filter(x => !x.cancelled) : [];

    $list.innerHTML = '';
    $res.style.display='block';

    if(rows.length===0){
      $hint.style.display='none';
      $list.innerHTML = '<div class="text-muted">查無未取消預約</div>';
      return;
    }

    $hint.style.display='block';
    rows.forEach(item=> appendRow(item, pid));
  }catch(e){
    console.error(e);
    alert('查詢失敗，請稍後再試');
  }finally{
    hideing();
  }
}

// === 以 booking id 顯示單筆（來自 cipher） ===
async function showByBookingId(bookingId){
  showing('載入中');
  try{
    const r = await axios.get(API, { params:{ action:'detail', id: bookingId }});
    const d = r.data || {};
    // 簡化成 rows 介面以共用 appendRow
    const item = {
      id: bookingId,
      date: d.date,
      slot: d.slot,
      time: d.time,
      name: d.name,
      num: d.num,
      canCancel: true,   // 若後端有條件，可依回傳調整
    };

    $normal.style.display = 'none';
    $res.style.display = 'block';
    $hint.style.display = 'none';
    $list.innerHTML = '';
    appendRow(item, null); // 無 pid
  }catch(e){
    console.error(e);
    alert('無法載入預約資料');
  }finally{
    hideing();
  }
}

// === 渲染一列 ===
function appendRow(item, pid){
  const ymd = item.date;
  const w = weekday(ymd);
  const t = item.time || guessTime(item.slot) || '';
  const row = document.createElement('div');
  row.className = 'list-row mb-2';
  row.innerHTML = `
    <div>${ymd || ''}</div>
    <div>星期${w || ''}</div>
    <div>${item.slot || ''}</div>
    <div>${t}</div>
    <div>${item.name || ''}</div>
    <div>${item.num || ''}</div>
    <div>
      <button class="btn btn-cancel btn-sm" ${item.canCancel ? '' : 'disabled'}>取消</button>
    </div>
  `;
  row.querySelector('.btn-cancel').onclick = ()=> cancelOne(item, pid);
  $list.appendChild(row);
}

// === 取消：優先用 row id，失敗才用 idnum ===
async function cancelOne(item, pid){
  if(!item?.canCancel){ return; }
  if(!confirm(`確認取消：\n${item.date}（${item.slot}）\n${item.name}  第 ${item.num} 號？`)) return;

  showing('取消中請稍等');
  try{
    let resp = await axios.get(API,{ params:{ action:'cancel', id: item.id, t: Date.now() }});
    if(!(resp.data && (resp.data.ok || resp.data.success))){
      if(pid){
        resp = await axios.get(API,{ params:{ action:'cancel', idnum: pid, t: Date.now() }});
      }
    }

    if(resp.data && (resp.data.ok || resp.data.success)){
      alert(resp.data.message || '已取消。');
      if(pid){ await queryByPid(); }
      else { // 單筆模式：移除畫面即可
        $list.innerHTML = '<div class="text-muted">此預約已取消</div>';
      }
    }else{
      alert((resp.data && resp.data.message) || '取消失敗，請稍後再試');
    }
  }catch(e){
    console.error(e);
    alert('取消失敗，請稍後再試');
  }finally{
    hideing();
  }
}

// === 事件 ===
$btn.onclick = queryByPid;
$pid.addEventListener('input', e=>{
  e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,10);
});

// === 進站判斷：若有 cipher 就走單筆模式，並立刻清掉 URL 參數 ===
(function boot(){
  const qs = getSearchParamsAnywhere();
  const cipher = qs.get('cipher');
  if(cipher){
    try{
      const { id } = aesDec(cipher);
      scrubUrl(location.pathname); // 清掉網址上的密文
      showByBookingId(id);
      return;
    }catch(e){
      console.warn('cipher 解密失敗：', e);
      scrubUrl(location.pathname);
      // 繼續顯示一般查詢
    }
  }
})();
</script>
</body>
</html>
