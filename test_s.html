<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é ç´„æˆåŠŸ</title>

<link rel="icon" type="image/png" href="favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<script>
/* ============= å¾Œç«¯è¨­å®šï¼ˆèˆ‡ index / query ä¸€è‡´ï¼‰ ============= */
const API = "https://script.google.com/macros/s/AKfycby37Sxk-a-q9hxqROALi1gmGhWGXWr2xw8WF_pdgMAN_9HvM1PZJfgN6TJnVrGw0x9W/exec";

/* AES è§£å¯†ï¼ˆå¾ index å¸¶éä¾†çš„ cipherï¼‰ */
const AES_KEY = "A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";
function aesDec(v){
  const txt = CryptoJS.AES.decrypt(decodeURIComponent(v), AES_KEY).toString(CryptoJS.enc.Utf8);
  if(!txt) throw new Error("DECRYPT_FAIL");
  const data = JSON.parse(txt);
  if(data.exp && Date.now() > data.exp) throw new Error("TOKEN_EXPIRED");
  return data;
}

/* å°å·¥å…· */
const qs = (k)=>new URL(location.href).searchParams.get(k);
const pad2=(n)=>String(n).padStart(2,'0');
function weekdayZh(ymd){ const d=new Date(ymd+'T09:00:00+08:00'); return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]||''; }
function fmtTsTW(input){ if(!input) return ''; const d=new Date(input); if(isNaN(d)) return ''; return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; }
function toYMD(d){ const z=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),1,0,0)); return `${z.getUTCFullYear()}-${pad2(z.getUTCMonth()+1)}-${pad2(z.getUTCDate())}`; }
function normalizeYMD(input){
  if(!input) return '';
  if(typeof input==='string'){ if(/^\d{4}-\d{2}-\d{2}$/.test(input)) return input; const d=new Date(input); return isNaN(d)?'':toYMD(d); }
  const d=new Date(input); return isNaN(d)?'':toYMD(d);
}
/* slot -> é¡è‰²åˆ†é¡ */
function slotClass(slot){
  if(!slot) return 'slot-plain';
  if(slot.includes('æ—©')) return 'slot-early';
  if(slot.includes('åˆ')) return 'slot-noon';
  if(slot.includes('æ™š')) return 'slot-night';
  if(slot.includes('ç´„')) return 'slot-appt';
  return 'slot-plain';
}
/* å ±åˆ°æ™‚é–“æç¤º */
function slotCheckinText(slot, meta) {
  if (!slot) return "";
  if (slot.includes("ç´„")) {
    if (meta && meta.checkinBy) return `ç´„è¨ºè«‹åœ¨ ${meta.checkinBy} å‰å ±åˆ°`;
    return "æœ€æ™šå ±åˆ°æ™‚é–“ç‚ºé–€è¨ºçµæŸå‰ä¸€å°æ™‚";
  }
  if (slot.includes("æ—©")) return "æ—©è¨ºè«‹åœ¨ 10:30 å‰å ±åˆ°";
  if (slot.includes("åˆ")) return "åˆè¨ºè«‹åœ¨ 16:00 å‰å ±åˆ°";
  if (slot.includes("æ™š")) return "æ™šè¨ºè«‹åœ¨ 20:00 å‰å ±åˆ°";
  return "";
}
</script>

<style>
/* ===================== Ponder æ²‰æ€é…è‰²ï¼ˆClassic Blueï¼‰ ===================== */
:root{
  --classic-blue:#34558b;  /* Classic Blue */
  --provence:#678fc9;      /* Provence */
  --baby-blue:#bfd2dd;     /* Baby Blue */
  --monument:#7b858a;      /* Monument */
  --stucco:#9b8577;        /* Stucco */

  --primary:var(--classic-blue);
  --ink:#1c2430;
  --bg:#f4f6f8;
  --card:#ffffff;
  --line:#e6ebf1;

  --spin-color:#7f93b1;   /* ç°è— spinner è‰² */
  --spin-fade:1.2s;
}

/* = å­—é«”èˆ‡å…¨ç«™æ–¹è§’ = */
*{box-sizing:border-box}
html,body{width:100%;max-width:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
  font-weight:400;
}
/* é‡è¦ï¼šå…¨éƒ¨æ”¹ç‚ºæ–¹è§’ */
.btn, .cardish, .slot-card, .btn-main, .btn-ghost { border-radius:0 !important; }

.wrap{ max-width:920px; margin:42px auto; padding:0 12px; }
.cardish{ background:var(--card); border:1px solid var(--line); padding:26px 18px 28px; }

/* æ¨™é ­ */
.head{ display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:8px; }
.logo{ width:56px;height:56px;display:grid;place-items:center;background:var(--primary);color:#fff;font-weight:800;font-size:30px }
.title{ margin:0; font-weight:900; font-size:clamp(1.6rem,3vw,2.2rem); color:var(--primary); }

/* æŒ‰éˆ• */
.btn-main{ background:var(--primary); color:#fff; border:1px solid var(--primary); font-weight:800; padding:.85rem 1.15rem }
.btn-main:hover{ background:#2f4b79; border-color:#2f4b79; color:#fff }
.btn-ghost{ background:#fff; color:#3a3f47; border:1px solid #cfd6df; font-weight:800; padding:.85rem 1.15rem }
.btn-ghost:hover{ background:#f7f8fb }

/* slot å¡ç‰‡ï¼ˆæ–¹è§’ã€1px å¯¦ç·šï¼‰ */
.slot-card{
  border:1px solid #d7dbe5; background:#fff; color:#1f2b3a;
  padding:14px 16px; text-align:center; margin:0 auto 14px; max-width:760px;
  font-weight:800; line-height:1.7;
}
.slot-main{ font-size:1.07rem; }
.slot-sub { font-size:1.02rem; }
.slot-note{ font-size:.95rem; margin-top:2px; color:#304056 }

/* è¨ºåˆ¥è‰² */
.slot-early{ background:#e7f7ee; border-color:#b8ead4; color:#065f46; }
.slot-noon { background:#fff3df; border-color:#ffd79a; color:#7a4d00; }
.slot-night{ background:#e8f2ff; border-color:#cfe2ff; color:#1d4ed8; }
.slot-appt { background:#fde7ef; border-color:#ff99e6; color:#b51695; }

/* æç¤º */
.notice{ color:#5b6a7c; font-weight:700; line-height:1.7; }

/* ===================== æ”¾å°„æ¢ç‹€è½‰åœˆåœˆï¼ˆç°è—ï¼‰ ===================== */
@keyframes bars-fade { 0%{opacity:1} 100%{opacity:0} }
.spinner-bars{position:relative;display:inline-block;width:56px;height:56px}
.spinner-bars i{position:absolute;left:0;top:0;transform-origin:28px 28px;animation:bars-fade var(--spin-fade) linear infinite}
.spinner-bars i::after{content:"";position:absolute;top:3px;left:26px;width:4px;height:14px;border-radius:2px;background:var(--spin-color)}
.spinner-bars i:nth-child(1)  { transform:rotate(0deg);    animation-delay:-1.1s }
.spinner-bars i:nth-child(2)  { transform:rotate(30deg);   animation-delay:-1.0s }
.spinner-bars i:nth-child(3)  { transform:rotate(60deg);   animation-delay:-0.9s }
.spinner-bars i:nth-child(4)  { transform:rotate(90deg);   animation-delay:-0.8s }
.spinner-bars i:nth-child(5)  { transform:rotate(120deg);  animation-delay:-0.7s }
.spinner-bars i:nth-child(6)  { transform:rotate(150deg);  animation-delay:-0.6s }
.spinner-bars i:nth-child(7)  { transform:rotate(180deg);  animation-delay:-0.5s }
.spinner-bars i:nth-child(8)  { transform:rotate(210deg);  animation-delay:-0.4s }
.spinner-bars i:nth-child(9)  { transform:rotate(240deg);  animation-delay:-0.3s }
.spinner-bars i:nth-child(10) { transform:rotate(270deg);  animation-delay:-0.2s }
.spinner-bars i:nth-child(11) { transform:rotate(300deg);  animation-delay:-0.1s }
.spinner-bars i:nth-child(12) { transform:rotate(330deg);  animation-delay: 0s  }

/* å…¨é é®ç½©ï¼ˆè½‰åœˆï¼‰ */
#loading{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px;
  z-index:9999; background:rgba(255,255,255,.94); backdrop-filter:blur(2px);
  color:#475569; font-size:16px; font-weight:700;
}

/* RWD */
@media (max-width:600px){
  .wrap{ margin:24px auto; }
}
</style>
</head>
<body>
<!-- è½‰åœˆåœˆé®ç½©ï¼ˆèˆ‡ query ä¸€è‡´æ¨£å¼ï¼‰ -->
<div id="loading">
  <span class="spinner-bars" aria-hidden="true">
    <i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i>
  </span>
  <div class="loading-text">è®€å–ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
</div>

<div class="wrap">
  <div class="cardish text-center">
    <div class="head">
      <div class="logo">ï¼‹</div>
      <h1 class="title">é  ç´„ æˆ åŠŸ</h1>
    </div>

    <div class="mb-2" style="color:#6b7280;font-weight:700">æ‚¨çš„é ç´„è³‡è¨Šå¦‚ä¸‹</div>

    <div id="slotCard" class="slot-card slot-plain">
      <div id="slotMain" class="slot-main"></div>
      <div id="slotSub"  class="slot-sub"></div>
      <div id="slotNotice" class="slot-note"></div>
    </div>

    <div class="d-flex justify-content-center align-items-start gap-2 mb-3 notice">
      <div>ğŸ”¸</div>
      <div>æœ€æ™šå ±åˆ°æ™‚é–“ç‚ºé–€è¨ºçµæŸå‰ä¸€å°æ™‚ï¼›é€¾æ™‚åé¡å°‡é‡‹å‡ºçµ¦ç¾å ´æ›è™Ÿã€‚é–€è¨ºç•¶å¤©è«‹ä»¥é›»è©±å–æ¶ˆ â˜ (03) 515-2971ã€‚</div>
    </div>

    <div class="d-grid gap-2 mb-2" style="max-width:640px;margin:0 auto">
      <a class="btn btn-main" href="index.html">è¿”å›é ç´„é¦–é </a>
      <a class="btn btn-ghost" href="query.html">æŸ¥è©¢ï¼å–æ¶ˆé ç´„</a>
    </div>

    <div class="mt-3">
      <button id="shareBtn" class="btn btn-link p-0" style="text-decoration:underline;color:var(--primary);font-weight:800">ğŸ“¤ åˆ†äº«</button>
    </div>

    <div id="filledAt" class="mt-1" style="color:#6b7280;font-size:.92rem"></div>
  </div>
</div>

<script>
const $loading  = document.getElementById('loading');
const slotCard  = document.getElementById('slotCard');
const slotMain  = document.getElementById('slotMain');
const slotSub   = document.getElementById('slotSub');
const slotNotice= document.getElementById('slotNotice');
const filledAt  = document.getElementById('filledAt');
const shareBtn  = document.getElementById('shareBtn');

(async function init(){
  try{
    // 1) å¾ URL æˆ– session å– id/receipt
    let id=null, receipt='';
    const paramCipher = qs('cipher');
    if(paramCipher){
      try{
        const obj = aesDec(paramCipher);
        id = obj.id || obj.bookingId || null;
        receipt = obj.receipt || obj.rcpt || '';
        try{ sessionStorage.setItem('lastBookingId', String(id||'')); }catch(_){}
        try{ if(receipt) sessionStorage.setItem('rcpt:'+String(id||''), String(receipt)); }catch(_){}
      }catch(_){}
      history.replaceState({}, "", location.pathname);
    }
    if(!id) id = sessionStorage.getItem('lastBookingId') || null;
    if(!receipt && id) receipt = sessionStorage.getItem('rcpt:'+id) || '';

    if(!id){
      alert('é€£çµç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹å›é¦–é é‡æ–°æ“ä½œã€‚');
      location.href='index.html'; return;
    }

    // 2) å–è©³ç´°è³‡æ–™
    const r = await axios.get(API, { params:{ action:'detail', id, receipt } });
    const d = r.data || {};
    if (d.error) { alert('ç„¡æ³•å–å¾—é ç´„è³‡æ–™ï¼Œè«‹å›é¦–é ã€‚'); location.href='index.html'; return; }

    const ymd = normalizeYMD(d.date);
    const wk  = weekdayZh(ymd);

    // 3) ç›¡é‡è£œæ™‚æ®µèˆ‡é†«å¸«
    let timeRange = '';
    let doctor = (d.doctor || '').trim();
    let slotMeta = null;
    try{
      const slotsResp = await axios.get(API, { params:{ action:'getSlots', date: ymd } });
      const data = slotsResp.data;
      const slots = Array.isArray(data) ? data : (Array.isArray(data?.slots) ? data.slots : []);
      const hit = slots.find(x => String(x.label) === String(d.slot));
      slotMeta  = hit || null;
      timeRange = hit?.time || '';
      if(!doctor && hit && hit.doctor) doctor = String(hit.doctor);
    }catch(_){}

    // 4) é¡¯ç¤º
    slotCard.className = 'slot-card ' + slotClass(d.slot||'');
    const docTxt = doctor ? `ã€${doctor}ã€‘` : '';
    slotMain.textContent = `${ymd} æ˜ŸæœŸ${wk}ï¼ˆ${d.slot||''}ï¼‰ ${timeRange||''} ${docTxt}`;

    // âœ… å…¼å®¹è™Ÿç¢¼æ¬„ä½ï¼šnum/number/no/No
    const seatNo = d.num ?? d.number ?? d.no ?? d.No ?? '-';
    slotSub.textContent  = `å§“åï¼š${d.name||''}ï¼Œè™Ÿç¢¼ï¼š${seatNo} è™Ÿã€‚`;

    const noticeText = slotCheckinText(d.slot || "", slotMeta);
    slotNotice.innerHTML = noticeText ? `â­ ${noticeText}` : "";

    filledAt.textContent = d.submittedAt ? fmtTsTW(d.submittedAt) : '';

    // 5) åˆ†äº«
    const shareText =
`âœ”ï¸ é™³è¬é¾è¨ºæ‰€é ç´„æˆåŠŸ

${ymd} æ˜ŸæœŸ${wk}ï¼ˆ${d.slot||''}ï¼‰ ${timeRange||''} ${docTxt}
å§“åï¼š${d.name||''}ï¼Œè™Ÿç¢¼ï¼š${seatNo} è™Ÿ

æé†’ï¼šæœ€æ™šå ±åˆ°æ™‚é–“ç‚ºé–€è¨ºçµæŸå‰ä¸€å°æ™‚ã€‚`;
    shareBtn.onclick = async ()=>{
      try{
        if(navigator.share) await navigator.share({ text: shareText });
        else{ await navigator.clipboard.writeText(shareText); alert('å·²è¤‡è£½åˆ†äº«å…§å®¹ï¼'); }
      }catch(_){}
    };

  }catch(e){
    console.error(e);
    alert('ç³»çµ±å¿™ç¢Œæˆ–ç¶²è·¯ä¸ç©©ï¼Œè«‹å›é¦–é å†è©¦ä¸€æ¬¡ã€‚');
    location.href='index.html';
  }finally{
    // é—œé–‰é®ç½©
    $loading.style.display='none';
  }
})();
</script>
</body>
</html>
