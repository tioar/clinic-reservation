<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é ç´„æˆåŠŸ</title>

<!-- å­—é«”ï¼šèˆ‡ index ä¸€è‡´ï¼ˆTW-Kai å„ªå…ˆï¼Œç„¡æª”æ¡ˆæœƒè‡ªå‹•é€€åˆ°å‚™æ´ï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="favicon.png">

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<style>
:root{
  /* Ponder è—ç³»ä¸»é¡Œï¼ˆå’Œ index ä¸€æ¨£ï¼‰ */
  --classic-blue:#34558b;
  --provence:#678fc9;
  --baby-blue:#bfd2dd;
  --ink:#1c2430;
  --card:#ffffff;
  --line:#e6ebf1;

  /* è½‰åœˆåœˆï¼ˆç°è—ï¼‰ */
  --spin-color:#7f93b1;
  --spin-fade:1.2s;

  /* å„è¨ºåˆ¥è‰² */
  --early-bg:#e7f2ea; --early-bd:#b7d9c6; --early-tx:#0b523a;
  --noon-bg:#fff2df;  --noon-bd:#ffd79a; --noon-tx:#7a4d00;
  --night-bg:#e7f0fb; --night-bd:#c8dcff; --night-tx:#1646a2;
  --appt-bg:#f9e7ee;  --appt-bd:#f6b6dc; --appt-tx:#9b1f79;
}

/* åµŒå…¥æœ¬åœ° TW-Kaiï¼ˆæœ‰æª”æ‰æœƒç”Ÿæ•ˆï¼Œæ²’æª”å°±é€€åˆ°å‚™æ´ï¼‰ */
@font-face{
  font-family:"TW-Kai";
  src:url("/fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}

*{box-sizing:border-box}
html,body{width:100%;max-width:100%}
body{
  margin:0;background:#f4f6f8;color:var(--ink);
  font-family:"TW-Kai","LXGW WenKai TC","DFKai-SB","KaiTi",
              "PingFang TC","Microsoft JhengHei",serif;
}

/* æ–¹è§’é¢¨æ ¼ï¼ˆå’Œ index ä¸€è‡´ï¼‰ */
button, .btn, .cardish, .slot-card, .modal-content{ border-radius:0 !important; }

/* å®¹å™¨ */
.wrap{ max-width:min(880px,94vw); margin:40px auto; padding:0 12px; }
.cardish{
  background:var(--card); border:1px solid var(--line);
  box-shadow:0 10px 24px rgba(52,85,139,.10);
  padding:28px 20px 30px;
}

/* æ¨™é ­ */
.title-row{ display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:4px; }
.logo{ width:56px; height:56px; display:grid; place-items:center; background:var(--classic-blue); color:#fff; font-weight:700; font-size:32px; }
.h1x{ margin:0; color:var(--classic-blue); font-weight:700; font-size:clamp(1.6rem,3vw,2rem); }

/* è¨ºåˆ¥å¡ */
.slot-card{
  border:2px dashed; padding:16px 16px; text-align:center;
  margin:12px auto 16px; max-width:720px; line-height:1.7;
  border-color:#d7d9e3; background:#f7f7fb; color:#3a3f47;
}
.slot-early{ background:var(--early-bg); border-color:var(--early-bd); color:var(--early-tx); }
.slot-noon { background:var(--noon-bg);  border-color:var(--noon-bd);  color:var(--noon-tx); }
.slot-night{ background:var(--night-bg); border-color:var(--night-bd); color:var(--night-tx); }
.slot-appt { background:var(--appt-bg);  border-color:var(--appt-bd);  color:var(--appt-tx); }

.slot-main{ font-weight:700; font-size:1.1rem; }
.slot-sub { font-weight:700; font-size:1.05rem; }
.slot-note{ font-size:.95rem; margin-top:2px; }

/* åˆ†äº«æé†’æ¢ */
.share-tip{
  background:#eef3fb; border:1px solid #dae5f6; color:#334155;
  padding:10px 12px; display:flex; gap:10px; align-items:flex-start; margin:10px 0 16px;
  font-weight:700;
}

/* æŒ‰éˆ•ï¼ˆæ–¹è§’ï¼‰ */
.btn-main{ background:var(--classic-blue); color:#fff; border:1px solid var(--classic-blue); font-weight:700; padding:.85rem 1.2rem; }
.btn-main:hover{ background:#27426f; color:#fff; }
.btn-ghost{ background:#fff; color:#3a3f47; border:1px solid #d7dbe5; font-weight:700; padding:.85rem 1.2rem; }
.btn-ghost:hover{ background:#f2f6ff; }

/* è½‰åœˆåœˆï¼šç°è—æ”¾å°„æ¢ç‹€ï¼ˆå’Œ index åŒæ¬¾ï¼‰ */
@keyframes bars-fade { 0%{opacity:1} 100%{opacity:0} }
.spinner-bars{position:relative;display:inline-block;width:56px;height:56px}
.spinner-bars i{
  position:absolute;left:0;top:0;transform-origin:28px 28px;
  animation:bars-fade var(--spin-fade) linear infinite;
}
.spinner-bars i::after{
  content:""; position:absolute; top:3px; left:26px;
  width:4px; height:14px; border-radius:2px; background:var(--spin-color);
}
.spinner-bars i:nth-child(1)  { transform:rotate(0deg);    animation-delay:-1.1s }
.spinner-bars i:nth-child(2)  { transform:rotate(30deg);   animation-delay:-1.0s }
.spinner-bars i:nth-child(3)  { transform:rotate(60deg);   animation-delay:-0.9s }
.spinner-bars i:nth-child(4)  { transform:rotate(90deg);   animation-delay:-0.8s }
.spinner-bars i:nth-child(5)  { transform:rotate(120deg);  animation-delay:-0.7s }
.spinner-bars i:nth-child(6)  { transform:rotate(150deg);  animation-delay:-0.6s }
.spinner-bars i:nth-child(7)  { transform:rotate(180deg);  animation-delay:-0.5s }
.spinner-bars i:nth-child(8)  { transform:rotate(210deg);  animation-delay:-0.4s }
.spinner-bars i:nth-child(9)  { transform:rotate(240deg);  animation-delay:-0.3s }
.spinner-bars i:nth-child(10) { transform:rotate(270deg);  animation-delay:-0.2s }
.spinner-bars i:nth-child(11) { transform:rotate(300deg);  animation-delay:-0.1s }
.spinner-bars i:nth-child(12) { transform:rotate(330deg);  animation-delay: 0s  }

/* å…¨é é®ç½© */
#loading{
  position:fixed; inset:0; background:rgba(255,255,255,.94);
  display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px;
  z-index:9999; color:#475569; font-weight:700;
}
</style>
</head>
<body>
<!-- è½‰åœˆåœˆé®ç½© -->
<div id="loading">
  <span class="spinner-bars" aria-hidden="true">
    <i></i><i></i><i></i><i></i><i></i><i></i>
    <i></i><i></i><i></i><i></i><i></i><i></i>
  </span>
  <div class="loading-text">è®€å–ä¸­è«‹ç¨ç­‰</div>
</div>

<div class="wrap">
  <div class="cardish text-center">
    <div class="title-row">
      <div class="logo">ï¼‹</div>
      <h1 class="h1x">é  ç´„ æˆ åŠŸ</h1>
    </div>
    <div class="text-secondary mb-2" style="font-weight:700">æ‚¨çš„é ç´„è³‡è¨Šï¼š</div>

    <div id="slotCard" class="slot-card">
      <div id="slotMain" class="slot-main">â€”</div>
      <div id="slotSub"  class="slot-sub">â€”</div>
      <div id="slotNote" class="slot-note"></div>
    </div>

    <!-- åˆ†äº«æé†’æ¢ -->
    <div class="share-tip">
      <div style="font-size:20px;line-height:1">ğŸ“¤</div>
      <div class="text-start flex-grow-1">
        æé†’ï¼šå¯ä»¥é»ä¸‹æ–¹ã€Œåˆ†äº«ã€æŠŠé–€è¨ºæ—¥æœŸï¼è™Ÿç¢¼å‚³çµ¦å®¶äººï¼Œæˆ–è¤‡è£½æ–‡å­—åˆ° Lineï¼Messengerã€‚
      </div>
    </div>

    <div class="d-flex gap-2 justify-content-center mb-3">
      <a class="btn btn-main flex-fill" href="index.html">è¿”å›é ç´„é¦–é </a>
      <a class="btn btn-ghost flex-fill" href="query.html">æŸ¥è©¢ï¼å–æ¶ˆé ç´„</a>
      <button id="shareBtn" class="btn btn-ghost">åˆ†äº«</button>
    </div>

    <div id="filledAt" class="text-secondary small"></div>
  </div>
</div>

<script>
/* ===== å¸¸æ•¸ï¼ˆæ­£å¼æ¨¡å¼æœƒç”¨åˆ°ï¼‰ ===== */
const API = "https://script.google.com/macros/s/AKfycby37Sxk-a-q9hxqROALi1gmGhWGXWr2xw8WF_pdgMAN_9HvM1PZJfgN6TJnVrGw0x9W/exec";
const AES_KEY = "A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";

/* ===== å°å·¥å…· ===== */
const qs = (k)=>new URL(location.href).searchParams.get(k);
const pad2 = n => String(n).padStart(2,'0');
function weekdayZh(ymd){ const d=new Date(ymd+'T09:00:00+08:00'); return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]||''; }
function ymdNorm(input){
  if(!input) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(input)) return input;
  const d=new Date(input); if(isNaN(d)) return '';
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function guessTime(slot){
  if(!slot) return '';
  if(slot.includes('æ—©')) return '08:30~11:30';
  if(slot.includes('åˆ')) return '14:00~17:00';
  if(slot.includes('æ™š')) return '18:00~20:30';
  if(slot.includes('ç´„')) return '09:00~12:00';
  return '';
}
function slotClass(slot){
  if(!slot) return '';
  if(slot.includes('æ—©')) return 'slot-early';
  if(slot.includes('åˆ')) return 'slot-noon';
  if(slot.includes('æ™š')) return 'slot-night';
  if(slot.includes('ç´„')) return 'slot-appt';
  return '';
}
function slotCheckinText(slot){
  if(!slot) return '';
  if(slot.includes('æ—©')) return 'æ—©è¨ºè«‹åœ¨ 10:30 å‰å ±åˆ°';
  if(slot.includes('åˆ')) return 'åˆè¨ºè«‹åœ¨ 16:00 å‰å ±åˆ°';
  if(slot.includes('æ™š')) return 'æ™šè¨ºè«‹åœ¨ 20:00 å‰å ±åˆ°';
  if(slot.includes('ç´„')) return 'ç´„è¨ºè«‹æ–¼é–€è¨ºçµæŸå‰ä¸€å°æ™‚å‰å ±åˆ°';
  return '';
}
function aesDec(v){
  const txt = CryptoJS.AES.decrypt(decodeURIComponent(v), AES_KEY).toString(CryptoJS.enc.Utf8);
  if(!txt) throw new Error("DECRYPT_FAIL");
  const data = JSON.parse(txt);
  if(data.exp && Date.now() > data.exp) throw new Error("TOKEN_EXPIRED");
  return data;
}

/* ===== DOM ===== */
const $loading  = document.getElementById('loading');
const slotCard  = document.getElementById('slotCard');
const slotMain  = document.getElementById('slotMain');
const slotSub   = document.getElementById('slotSub');
const slotNote  = document.getElementById('slotNote');
const filledAt  = document.getElementById('filledAt');
const shareBtn  = document.getElementById('shareBtn');

/* ===== ä¸»æµç¨‹ ===== */
(async function init(){
  const isDemo = qs('demo') === '1';
  const stay   = qs('stay') === '1';

  try{
    let ymd='', slot='', time='', doctor='', name='', num='';
    if(isDemo){
      // 1) Demo æ¨¡å¼ï¼šå…¨éƒ¨å¾ç¶²å€å¸¶ï¼Œç¼ºçš„ç”¨é è¨­
      ymd    = ymdNorm(qs('date')) || ymdNorm(new Date());
      slot   = qs('slot') || 'æ—©è¨º';
      time   = qs('time') || guessTime(slot);
      doctor = qs('doctor') || 'é™³è¬é¾é†«å¸«';
      name   = qs('name') || 'ç‹å°æ˜';
      num    = qs('num') || '12';
    }else{
      // 2) æ­£å¼æ¨¡å¼ï¼šå¾ cipher / sessionStorage å– idï¼Œå† call API
      let id=null, receipt='';
      const cipher = qs('cipher');
      if(cipher){
        try{
          const obj = aesDec(cipher);
          id = obj.id || obj.bookingId || null;
          receipt = obj.receipt || obj.rcpt || '';
        }catch(_){}
        // ç§»é™¤ query ä»¥å…é‡æ•´é‡è¤‡
        if(history.replaceState) history.replaceState({}, "", location.pathname);
      }
      if(!id) id = sessionStorage.getItem('lastBookingId') || null;
      if(!receipt && id) receipt = sessionStorage.getItem('rcpt:'+id) || '';

      if(!id){
        if(stay){
          // åœç•™è§€å¯Ÿæ¨£å¼
          throw new Error('NO_ID_BUT_STAY');
        }else{
          alert('é€£çµç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹å›é¦–é é‡æ–°æ“ä½œã€‚');
          location.href = 'index.html';
          return;
        }
      }

      const r = await axios.get(API, { params:{ action:'detail', id, receipt } });
      const d = r.data || {};
      if(d.error){ throw new Error('DETAIL_FAIL'); }

      ymd    = ymdNorm(d.date);
      slot   = d.slot || '';
      time   = d.time || '';
      doctor = d.doctor || '';
      name   = d.name || '';
      num    = d.num || '';
      if(!time){
        // è£œæŠ“ç•¶æ—¥ slots ä»¥æ‹¿æ™‚é–“å€é–“
        try{
          const s2 = await axios.get(API, { params:{ action:'getSlots', date: ymd } });
          const arr = Array.isArray(s2.data) ? s2.data : (Array.isArray(s2.data?.slots) ? s2.data.slots : []);
          const hit = arr.find(x => String(x.label) === String(slot));
          time = hit?.time || '';
          if(!doctor && hit?.doctor) doctor = String(hit.doctor);
        }catch(_){}
      }
      if(!time) time = guessTime(slot);
    }

    // å¯«ç•«é¢
    const wk = weekdayZh(ymd);
    slotCard.classList.add(slotClass(slot));
    const docTxt = doctor ? `ã€${doctor}ã€‘` : '';
    slotMain.textContent = `${ymd} æ˜ŸæœŸ${wk}ï¼ˆ${slot}ï¼‰ ${time} ${docTxt}`;
    slotSub.textContent  = `å§“åï¼š${name}ï¼Œè™Ÿç¢¼ï¼š${num} è™Ÿã€‚`;
    const note = slotCheckinText(slot);
    slotNote.innerHTML = note ? `â­ ${note}` : '';

    // åˆ†äº«
    const shareText =
`âœ”ï¸é™³è¬é¾è¨ºæ‰€é–€è¨ºé ç´„æˆåŠŸ

${ymd} æ˜ŸæœŸ${wk}ï¼ˆ${slot}ï¼‰ ${time} ${docTxt}
å§“åï¼š${name}ï¼Œè™Ÿç¢¼ï¼š${num} è™Ÿ

ğŸ”ºè«‹æ–¼é–€è¨ºçµæŸå‰ä¸€å°æ™‚å‰å®Œæˆå ±åˆ°ã€‚`;
    shareBtn.onclick = async ()=>{
      try{
        if(navigator.share) await navigator.share({ text: shareText });
        else{ await navigator.clipboard.writeText(shareText); alert('å·²è¤‡è£½åˆ†äº«å…§å®¹ï¼'); }
      }catch(_){}
    };

    // ç¤ºæ„å¡«å–®æ™‚é–“ï¼ˆdemo å°±ä¸é¡¯ç¤ºï¼‰
    if(!isDemo && typeof d!=='undefined' && d?.submittedAt){
      const t=new Date(d.submittedAt);
      filledAt.textContent = `${t.getFullYear()}/${pad2(t.getMonth()+1)}/${pad2(t.getDate())} ${pad2(t.getHours())}:${pad2(t.getMinutes())}:${pad2(t.getSeconds())}`;
    }

  }catch(err){
    // stay=1 æ™‚å°±ç•™åœ¨ç•«é¢ä¸Šçµ¦ä½ çœ‹æ¨£å¼
    if(qs('stay')!=='1'){
      console.error(err);
      alert('ç³»çµ±å¿™ç¢Œæˆ–é€£ç·šä¸ç©©ï¼Œè«‹å›é¦–é å†è©¦ä¸€æ¬¡ã€‚');
      location.href='index.html';
      return;
    }
  }finally{
    document.getElementById('loading').style.display='none';
  }
})();
</script>
</body>
</html>
