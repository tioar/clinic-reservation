<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é ç´„æˆåŠŸ</title>
<link rel="icon" type="image/png" href="favicon.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<!-- èˆ‡ index ç›¸åŒçš„å­—å‹å‚™æ´ -->
<link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ===================== ä¸»é¡Œï¼ˆèˆ‡ index ä¸€è‡´ï¼‰ ===================== */
:root{
  --classic-blue:#34558b;
  --provence:#678fc9;
  --baby-blue:#bfd2dd;
  --monument:#7b858a;
  --stucco:#9b8577;

  --primary:var(--classic-blue);
  --ink:#1c2430;
  --bg:#f4f6f8;
  --card:#ffffff;
  --line:#e6ebf1;

  --spin-color:#7f93b1;
  --spin-fade:1.2s;
}

/* ===================== å­—å‹ï¼ˆèˆ‡ index ç›¸åŒï¼‰ ===================== */
@font-face{
  font-family:"TW-Kai";
  src:url("/fonts/TW-Kai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"CwTeXKai";
  src:url("/fonts/CwTeXKai.woff2") format("woff2");
  font-weight:400; font-style:normal; font-display:swap;
}

*{box-sizing:border-box}
html,body{width:100%;max-width:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family:
    "TW-Kai","CwTeXKai","LXGW WenKai TC",
    "DFKai-SB","KaiTi","Kaiti TC","Kaiti SC","BiauKai",
    "STFangsong","FangSong",
    "PingFang TC","Microsoft JhengHei",serif;
  font-weight:400;
}
/* å…¨ç«™æ–¹è§’ */
button, .btn, input, .cardish, .pill, .modal-content { border-radius:0 !important; }

.wrap{max-width:960px;margin:16px auto;padding:12px}

/* ===================== Header ===================== */
.page-head{display:flex;align-items:center;justify-content:center;gap:14px;margin:6px 8px 14px}
.page-head .logo{width:64px;height:64px;display:grid;place-items:center;background:var(--primary);color:#fff;font-weight:700;font-size:34px}
.page-head h1{margin:0;font-weight:700;font-size:clamp(1.5rem,2.6vw,2.2rem);color:var(--primary)}

/* ===================== å¡ç‰‡å®¹å™¨ ===================== */
.cardish{background:var(--card);border:1px solid var(--line)}
.section{padding:14px}

/* æˆåŠŸè³‡è¨Š */
.success-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.badge-ok{display:inline-block;background:#e7f2ea;border:1px solid #b7d9c6;color:#0b523a;padding:.2rem .5rem;font-weight:700}
.kv{display:grid;grid-template-columns:100px 1fr;row-gap:8px;column-gap:8px}
.kv .k{color:#475569;font-weight:700}
.kv .v{font-weight:700}

/* è¨ºåˆ¥ pillï¼ˆæ²¿ç”¨ index è¦–è¦ºï¼‰ */
.pill{display:inline-flex;align-items:center;justify-content:center;gap:.3rem;border:1px solid #d7dde6;padding:.18rem .6rem;font-weight:700;font-size:.95rem;line-height:1.1;white-space:nowrap}
.pill.early{background:#e7f2ea;color:#0b523a;border-color:#b7d9c6}
.pill.noon {background:#fff2df;color:#7a4d00;border-color:#ffd79a}
.pill.night{background:#e7f0fb;color:#1646a2;border-color:#c8dcff}
.pill.appt {background:#f9e7ee;color:#9b1f79;border-color:#f6b6dc}

/* æ–¹å½¢æŒ‰éˆ•ï¼ˆèˆ‡ index ä¸€è‡´ï¼‰ */
.btn-main,.btn-ghost{font-weight:700;padding:.9rem 1.15rem;font-size:1.05rem}
.btn-main{background:var(--primary);color:#fff;border:1px solid var(--primary)}
.btn-main:hover{filter:brightness(0.95)}
.btn-ghost{background:#fff;border:1px solid #d7dbe5;color:#3a3f47}
.btn-ghost:hover{background:#f7fafc}

/* åˆ†äº«æé†’æ¢ï¼ˆæ–¹è§’ã€æ·¡è—åº•ï¼‰ */
.share-box{
  margin-top:14px;padding:12px 14px;
  background:#f6f9ff;border:1px solid #e3ecff;color:#334155;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.share-box .hint{font-weight:700}
.share-box .btn-share{margin-left:auto}

/* ===================== è½‰åœˆåœˆï¼ˆèˆ‡ index åŒæ¬¾ï¼‰ ===================== */
@keyframes bars-fade { 0%{opacity:1} 100%{opacity:0} }
.spinner-bars{position:relative;display:inline-block;width:56px;height:56px}
.spinner-bars i{
  position:absolute;left:0;top:0;transform-origin:28px 28px;
  animation:bars-fade var(--spin-fade) linear infinite;
}
.spinner-bars i::after{
  content:""; position:absolute; top:3px; left:26px;
  width:4px; height:14px; border-radius:2px; background:var(--spin-color);
}
.spinner-bars i:nth-child(1)  { transform:rotate(0deg);    animation-delay:-1.1s }
.spinner-bars i:nth-child(2)  { transform:rotate(30deg);   animation-delay:-1.0s }
.spinner-bars i:nth-child(3)  { transform:rotate(60deg);   animation-delay:-0.9s }
.spinner-bars i:nth-child(4)  { transform:rotate(90deg);   animation-delay:-0.8s }
.spinner-bars i:nth-child(5)  { transform:rotate(120deg);  animation-delay:-0.7s }
.spinner-bars i:nth-child(6)  { transform:rotate(150deg);  animation-delay:-0.6s }
.spinner-bars i:nth-child(7)  { transform:rotate(180deg);  animation-delay:-0.5s }
.spinner-bars i:nth-child(8)  { transform:rotate(210deg);  animation-delay:-0.4s }
.spinner-bars i:nth-child(9)  { transform:rotate(240deg);  animation-delay:-0.3s }
.spinner-bars i:nth-child(10) { transform:rotate(270deg);  animation-delay:-0.2s }
.spinner-bars i:nth-child(11) { transform:rotate(300deg);  animation-delay:-0.1s }
.spinner-bars i:nth-child(12) { transform:rotate(330deg);  animation-delay: 0s  }
.spinner-sm{width:22px;height:22px}
.spinner-sm i{transform-origin:11px 11px}
.spinner-sm i::after{top:1px;left:10px;width:2px;height:6px;border-radius:1px}

/* å…¨é é®ç½©ï¼ˆåŒæ¬¾è½‰åœˆï¼‰ */
#mask{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center; flex-direction:column; gap:12px;
  z-index:9999; background:rgba(255,255,255,.94); backdrop-filter:blur(2px);
  color:#475569; font-size:16px; font-weight:700;
}

/* Mobile */
@media (max-width:600px){
  .wrap{padding:8px}
  .page-head{margin:4px 4px 12px}
  .page-head .logo{width:56px;height:56px;font-size:30px}
  .kv{grid-template-columns:84px 1fr}
  .share-box{gap:8px}
  .share-box .btn-share{margin-left:0}
}
</style>
</head>
<body>
<!-- è½‰åœˆè¼‰å…¥ä¸­ï¼ˆèˆ‡ index åŒæ¬¾ï¼‰ -->
<div id="mask" style="display:flex">
  <div class="spin-here"></div>
  <div class="loading-text">è®€å–ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
</div>

<div class="wrap">
  <div class="page-head"><div class="logo">ï¼‹</div><h1>é ç´„æˆåŠŸ</h1></div>

  <div class="cardish section">
    <div class="success-head">
      <span class="badge-ok">å·²å»ºç«‹é ç´„</span>
      <span style="color:var(--monument);font-weight:700">ä»¥ä¸‹ç‚ºæ‚¨çš„é ç´„è³‡è¨Š</span>
    </div>

    <div class="kv">
      <div class="k">æ—¥æœŸ</div><div class="v" id="vDate">â€”</div>
      <div class="k">è¨ºåˆ¥</div>
      <div class="v">
        <span id="vSlotPill" class="pill">â€”</span>
        <span id="vTime" style="margin-left:.5rem"></span>
      </div>
      <div class="k">é†«å¸«</div><div class="v" id="vDoc">â€”</div>
      <div class="k">å§“å</div><div class="v" id="vName">â€”</div>
      <div class="k">è™Ÿç¢¼</div><div class="v" id="vNum">â€”</div>
    </div>

    <!-- åˆ†äº«æé†’æ¢ï¼ˆå·²åŠ å…¥æŒ‰éˆ•ï¼‰ -->
    <div class="share-box">
      <span class="hint">ğŸ“¤ å°‡æœ¬æ¬¡é ç´„è³‡è¨Šåˆ†äº«çµ¦å®¶äººï¼åŒè¡Œè€…ï¼Œæ–¹ä¾¿å ±åˆ°ã€‚</span>
      <button id="shareBtn" class="btn btn-main btn-share">åˆ†äº«</button>
    </div>

    <div class="mt-3" style="color:#475569">
      â­ æœ€æ™šå ±åˆ°æ™‚é–“ç‚ºé–€è¨ºçµæŸå‰ä¸€å°æ™‚ï¼›é–€è¨ºç•¶å¤©åƒ…æ¥å—é›»è©±å–æ¶ˆï¼š<strong>(03) 515-2971</strong>
    </div>

    <div class="d-grid gap-2 mt-3">
      <a class="btn btn-main text-center text-decoration-none" href="index.html">è¿”å›é ç´„é¦–é </a>
      <a class="btn btn-ghost text-center text-decoration-none" href="query.html">æŸ¥è©¢ï¼å–æ¶ˆé ç´„</a>
    </div>
  </div>
</div>

<script>
/* ====== èˆ‡ index / query ä¸€è‡´çš„è¨­å®š ====== */
const API="https://script.google.com/macros/s/AKfycby37Sxk-a-q9hxqROALi1gmGhWGXWr2xw8WF_pdgMAN_9HvM1PZJfgN6TJnVrGw0x9W/exec";
const AES_KEY="A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";

/* è½‰åœˆå…ƒä»¶ï¼ˆåŒæ¬¾ï¼‰ */
function createSpinner(size="md"){
  const root=document.createElement("span");
  root.className="spinner-bars"+(size==="sm"?" spinner-sm":"");
  for(let i=0;i<12;i++){ root.appendChild(document.createElement("i")); }
  return root;
}
function mountSpinner(target,{size="md",label=""}={}){
  const el=(typeof target==="string")?document.querySelector(target):target;
  if(!el) return null; el.innerHTML="";
  const s=createSpinner(size); el.appendChild(s);
  if(label){ const t=document.createElement("span"); t.className="ms-2"; t.textContent=label; el.appendChild(t); }
  return s;
}
const $mask=document.getElementById('mask');
function showMask(txt){ $mask.style.display='flex'; mountSpinner($mask.querySelector('.spin-here'),{size:"md"}); const t=$mask.querySelector('.loading-text'); if(t) t.textContent=txt||'è®€å–ä¸­ï¼Œè«‹ç¨å€™â€¦'; }
function hideMask(){ $mask.style.display='none'; }

/* å°å·¥å…· */
const pad2=n=>String(n).padStart(2,'0');
const weekdayZh=d=>['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(d+'T09:00:00+08:00').getDay()];
function normalizeYMD(input){
  if(!input) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(input)) return input;
  const d=new Date(input); if(isNaN(d)) return ''; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function aesDec(q){
  const txt=CryptoJS.AES.decrypt(decodeURIComponent(q),AES_KEY).toString(CryptoJS.enc.Utf8);
  if(!txt) throw new Error('DECRYPT_FAIL');
  const data=JSON.parse(txt); if(data.exp && Date.now()>data.exp) throw new Error('TOKEN_EXPIRED'); return data;
}

/* DOM */
const vDate=document.getElementById('vDate');
const vTime=document.getElementById('vTime');
const vDoc =document.getElementById('vDoc');
const vName=document.getElementById('vName');
const vNum =document.getElementById('vNum');
const vSlotPill=document.getElementById('vSlotPill');
const shareBtn=document.getElementById('shareBtn');

/* slot â†’ pill class/æ–‡å­— */
function slotInfo(slot){
  if(!slot) return {cls:'',txt:'â€”'};
  if(slot.includes('æ—©')) return {cls:'early', txt:'æ—©è¨º'};
  if(slot.includes('åˆ')) return {cls:'noon' , txt:'åˆè¨º'};
  if(slot.includes('æ™š')) return {cls:'night',txt:'æ™šè¨º'};
  if(slot.includes('ç´„')) return {cls:'appt', txt:'ç´„è¨º'};
  return {cls:'',txt:slot};
}

(async function init(){
  try{
    showMask();

    // 1) å–å¾— id/receiptï¼ˆ?cipher æˆ– sessionStorageï¼‰
    const params=new URL(location.href).searchParams;
    let id=null, receipt='';
    const cipher=params.get('cipher');
    if(cipher){
      try{
        const obj=aesDec(cipher);
        id=obj.id||obj.bookingId||null; receipt=obj.receipt||obj.rcpt||'';
        try{ sessionStorage.setItem('lastBookingId', String(id||'')); }catch(_){}
        try{ if(receipt) sessionStorage.setItem('rcpt:'+String(id||''), String(receipt)); }catch(_){}
      }catch(_){}
      history.replaceState({}, "", location.pathname);
    }
    if(!id) id=sessionStorage.getItem('lastBookingId')||null;
    if(!receipt && id) receipt=sessionStorage.getItem('rcpt:'+id)||'';
    if(!id){ alert('é€£çµç„¡æ•ˆæˆ–å·²éæœŸï¼Œè«‹å›é¦–é é‡æ–°æ“ä½œã€‚'); location.href='index.html'; return; }

    // 2) è©³ç´°è³‡æ–™
    const r=await axios.get(API,{params:{action:'detail',id,receipt}});
    const d=r.data||{};
    if(d.error){ alert('ç„¡æ³•å–å¾—é ç´„è³‡æ–™ï¼Œè«‹å›é¦–é ã€‚'); location.href='index.html'; return; }

    const ymd=normalizeYMD(d.date);
    const wk =weekdayZh(ymd)||'';
    const slot = String(d.slot||'');
    const {cls,txt}=slotInfo(slot);

    // 3) è£œé½Šæ™‚æ®µ/é†«å¸«
    let timeRange='', doctor=(d.doctor||'').trim();
    try{
      const q=await axios.get(API,{params:{action:'getSlots',date:ymd}});
      const data=q.data; const slots=Array.isArray(data)?data:(Array.isArray(data?.slots)?data.slots:[]);
      const hit=slots.find(x=>String(x.label)===slot);
      timeRange=hit?.time||''; if(!doctor && hit?.doctor) doctor=String(hit.doctor);
    }catch(_){}

    // 4) å¯«ç•«é¢
    vDate.textContent = `${ymd}ï¼ˆé€±${wk}ï¼‰`;
    vSlotPill.className = `pill ${cls||''}`;
    vSlotPill.textContent = txt;
    vTime.textContent = timeRange ? timeRange : '';
    vDoc.textContent  = doctor || 'â€”';
    vName.textContent = d.name || 'â€”';
    vNum.textContent  = (d.num!=null && d.num!=='') ? String(d.num) : 'â€”';

    // 5) åˆ†äº«
    const shareText =
`âœ”ï¸ é™³è¬é¾è¨ºæ‰€é–€è¨ºé ç´„æˆåŠŸ
æ—¥æœŸï¼š${ymd}ï¼ˆé€±${wk}ï¼‰
è¨ºåˆ¥ï¼š${txt} ${timeRange||''} ${doctor?`ã€${doctor}ã€‘`:''}
å§“åï¼š${d.name||''}
è™Ÿç¢¼ï¼š${(d.num!=null && d.num!=='')?d.num:'â€”'} è™Ÿ
â€» æœ€æ™šå ±åˆ°æ™‚é–“ç‚ºé–€è¨ºçµæŸå‰ä¸€å°æ™‚ã€‚`;
    shareBtn.onclick = async ()=>{
      try{
        if(navigator.share){ await navigator.share({text:shareText}); }
        else{ await navigator.clipboard.writeText(shareText); alert('å·²è¤‡è£½åˆ†äº«å…§å®¹ï¼'); }
      }catch(_){}
    };

  }catch(e){
    console.error(e);
    alert('ç³»çµ±å¿™ç¢Œæˆ–ç¶²è·¯ä¸ç©©ï¼Œè«‹å›é¦–é å†è©¦ä¸€æ¬¡ã€‚');
    location.href='index.html';
  }finally{
    hideMask();
  }
})();
</script>
</body>
</html>
