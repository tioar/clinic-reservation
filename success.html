<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>預約成功</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="favicon.png">

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- CryptoJS (AES) ─ 前端僅遮蔽用 -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

<script>
/* === 後端 API（⚠️請與 index.html / query.html 完全一致） === */
const API = "https://script.google.com/macros/s/AKfycbz1jtOWBJEETvotCU2y022ow4lOlm_TauYpRMG6riUIj88_Vde5d9LHGH5cLC4HYe7X/exec";

/* === AES（遮蔽，不等於安全） === */
const AES_KEY = "A2x5fT9qR7nC1vB8mK3pZ6sD4uH0yW2j";
function aesEnc(payload, ttlMs = 10 * 60 * 1000){
  const obj = { ...payload, exp: Date.now() + ttlMs };
  return encodeURIComponent(CryptoJS.AES.encrypt(JSON.stringify(obj), AES_KEY).toString());
}
function aesDec(v){
  const txt = CryptoJS.AES.decrypt(decodeURIComponent(v), AES_KEY).toString(CryptoJS.enc.Utf8);
  const obj = JSON.parse(txt||"{}");
  if (!obj || !obj.exp || Date.now()>Number(obj.exp)) throw new Error("expired");
  return obj;
}
</script>

<style>
:root{
  --lavender:#f7f6fb; --panel:#ffffff; --text:#2a183d; --text-deep:#2a183d;
  --primary:#6236a7; --muted:#6b5f92; --soft:#efe9ff; --soft-bd:#e5dcff;

  --early-bg:#e7f7ee; --early-bd:#b8ead4; --early-tx:#065f46;
  --noon-bg:#fff3df;  --noon-bd:#ffd79a;  --noon-tx:#7a4d00;
  --night-bg:#e8f2ff; --night-bd:#cfe2ff; --night-tx:#1d4ed8;
  --appt-bg:#fde7ef;  --appt-bd:#ff99e6;  --appt-tx:#b51695;
}

html,body{width:100%;max-width:100%}
body{
  background:var(--lavender);
  font-family: "Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
  color:var(--text-deep);
}
.wrap{ max-width:min(880px,94vw); margin:52px auto; padding:0 16px; }
.cardx{
  background:#fff; border-radius:24px;
  padding:36px clamp(24px,4vw,44px);
  box-shadow:0 12px 28px rgba(100,61,168,.14);
  border:1px solid #efe9ff;
}

/* 標題 */
.title-row{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:18px}
.title-row .icon{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:var(--soft);color:#5b35a1}
.title-row .txt{font-size:clamp(28px,4vw,40px);font-weight:900;letter-spacing:6px}

/* 區塊 */
.info-block{
  border:2px dashed #ebb6e7;
  background:#fae6f0;
  border-radius:22px;
  padding:24px 18px;
}

/* 內容行 */
.bigline{font-size:clamp(20px,2.6vw,28px);font-weight:800;color:#b51695;text-align:center;margin:4px 0 12px}

/* 次資訊 */
.subline{font-size:clamp(16px,2.2vw,20px);text-align:center;margin-bottom:6px}
.note{display:flex;align-items:center;gap:8px;justify-content:center;margin-top:8px;color:#8a66b6;font-weight:700}
.note .star{display:inline-block;width:18px;text-align:center}

/* 按鈕列 */
.btns{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:20px}
.btnx{
  display:flex;align-items:center;justify-content:center;gap:10px;
  background:#6a3cc6;border:none;color:#fff;border-radius:18px;
  padding:16px 10px;font-weight:900;font-size:18px;
}
.btnx.ghost{background:#efe9ff;color:#4a2f82}

/* 底部分享 */
.bottom{display:flex;align-items:center;gap:8px;justify-content:center;color:#5a3bb0;margin:18px 0 4px;font-weight:800}
.time{color:#7a679f;text-align:center;margin-top:6px}

@media (max-width:600px){
  .wrap{margin:28px auto}
  .btns{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="cardx">
    <div class="title-row">
      <div class="icon">✔</div>
      <div class="txt">預 約 成 功</div>
    </div>

    <div class="info-block">
      <div id="mainInfo" class="bigline">—</div>
      <div id="nameInfo" class="subline">—</div>
      <div class="note"><span class="star">🔸</span><span>最晚報到時間為門診結束前一小時</span></div>
    </div>

    <div class="time" id="ts">—</div>

    <div class="btns mt-4">
      <a href="index.html" class="btnx">返回預約首頁</a>
      <a href="query.html" class="btnx ghost">查詢 / 取消預約</a>
    </div>

    <div class="bottom"><span>📎</span><span>分享</span></div>
  </div>
</div>

<script>
/* 從 URL 取憑證並解密 */
function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name)||"";
}
function setText(id,txt){const el=document.getElementById(id); if(el) el.textContent=txt;}

/* 格式化 */
const pad2 = n=>String(n).padStart(2,'0');
const W = ["日","一","二","三","四","五","六"];

/* 解析 success 內容 */
(function boot(){
  const cipher = getParam("cipher") || sessionStorage.getItem("cipher");
  if(!cipher){
    document.body.innerHTML = '<div style="display:grid;place-items:center;height:70vh;color:#4b2c86;font-weight:800">讀取中請稍等..</div>';
    return;
  }
  let obj={};
  try{obj=aesDec(cipher);}catch(_){ /* ignore */ }

  // 若沒提供完整內容，可嘗試從 API 查詢（可視情況保留）
  // 這裡示意直接從 sessionStorage 取
  try{
    const id = obj.id || sessionStorage.getItem("lastBookingId") || "";
    const rcpt = sessionStorage.getItem('rcpt:'+String(id)) || "";
    if(rcpt) obj.receipt = rcpt;
  }catch(_){}

  // 組版顯示
  const dateStr = obj.date || obj.Date || "";
  const slot    = obj.slot || obj.Slot || obj.kind || "";
  const time    = obj.time || obj.Time || "";
  const doctor  = obj.doctor || obj.Doctor || "";
  const name    = obj.name || obj.Name || "";

  let wd="";
  try{ wd = "星期" + W[new Date(dateStr).getDay()]; }catch(_){}
  const line1 = `${dateStr}　${wd}（ ${slot} ） ${time} ［ ${doctor} ］`;
  const line2 = name ? `姓名：${name}，號碼：${obj?.number??"—"}號。` : "";

  setText("mainInfo", line1);
  setText("nameInfo", line2);
  setText("ts", new Date().toISOString().slice(0,19).replace("T"," "));

})();
</script>
</body>
</html>
