<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>預約成功</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="card" style="max-width:720px;margin:40px auto;">
  <div class="text-center">
    <div style="font-size:52px;line-height:1">✅</div>
    <h2 class="mt-2">預約成功！</h2>
    <p class="text-muted">您的預約資訊：</p>

    <div id="info" class="fw-bold" style="white-space:pre-wrap"></div>

    <div class="d-flex gap-3 justify-content-center mt-4">
      <a class="btn btn-primary" href="index.html">返回預約首頁</a>
      <a class="btn btn-outline-primary" href="query.html">查詢/取消預約</a>
    </div>

    <div class="mt-3">
      <a id="share" href="#" class="text-decoration-none">📮 分享</a>
    </div>
  </div>
</div>

<script>
// 👉 同一支 GAS
const API = "https://script.google.com/macros/s/AKfycbyO-CCSC7NAUfF10O34J4pd-Bn3YL7QgyCUNxgKfg-UWzQ7U_ajiI0jayCvHxD3NSKQ/exec";

const qs   = new URLSearchParams(location.search);
const id   = qs.get('id');

if(!id){
  document.getElementById('info').textContent = '無法取得預約資料（缺少 id）。';
}else{
  load();
}

async function load(){
  try{
    // 1) 讀取單筆詳情
    const r1 = await axios.get(API, { params: { action:'detail', id }});
    const data = r1.data || {};

    // data 會有：date(YYYY-MM-DD), slot, name, num, time(ISO)
    const dateStr = data.date;     // '2025-08-22'
    const slot    = data.slot || '';
    const name    = data.name || '';
    const num     = data.num  || '';

    // 2) 用 date 再查該日的時段，找出對應診別的 time range
    let timeRange = '';
    if(dateStr && slot){
      const r2 = await axios.get(API, { params: { action:'getSlots', date: dateStr }});
      const slots = r2.data || [];
      const hit = slots.find(s => String(s.label) === String(slot));
      timeRange = hit?.time || '';
    }

    // 3) 轉本地（台灣）格式
    const weekdayText = (d) => {
      const wd = new Date(d + 'T00:00:00+08:00').toLocaleDateString('zh-TW', {
        timeZone:'Asia/Taipei', weekday:'long'
      });
      return wd.replace('星期', '星期'); // 保持原樣，保險寫法
    };
    const displayDate = new Date(dateStr + 'T00:00:00+08:00').toLocaleDateString('zh-TW', {
      timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit'
    }) + ` ${weekdayText(dateStr)}`;

    const createdAt = data.time
      ? new Date(data.time).toLocaleString('zh-TW', {
          timeZone:'Asia/Taipei', hour12:false,
          year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
        })
      : '';

    // 4) 組畫面
    const info = document.getElementById('info');
    info.innerHTML =
      `${displayDate}（${slot}${timeRange ? '・' + timeRange : ''}）\n` +
      `${createdAt ? createdAt + '\n' : ''}\n` +
      `姓名：${name}，號碼：${num} 號。`;

    // 分享
    document.getElementById('share').onclick = async (e)=>{
      e.preventDefault();
      const text =
        `預約成功\n` +
        `${displayDate}（${slot}${timeRange ? '・' + timeRange : ''}）\n` +
        `姓名：${name}，號碼：${num}號`;
      try{
        if(navigator.share){
          await navigator.share({ title:'預約成功', text, url: location.href });
        }else{
          await navigator.clipboard.writeText(text + '\n' + location.href);
          alert('已複製分享內容！');
        }
      }catch(_){}
    };
  }catch(err){
    console.error(err);
    document.getElementById('info').textContent = '無法取得預約資料';
  }
}
</script>
</body>
</html>
