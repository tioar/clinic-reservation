<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>預約成功</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="result-card container py-5">
  <div class="mx-auto bg-white shadow rounded-4 p-4 p-md-5" style="max-width:820px;">
    <div class="text-center mb-3">
      <div style="font-size:64px; line-height:1;">✅</div>
      <h2 class="fw-bold mt-3">預約成功！</h2>
      <div class="text-secondary mt-2">您的預約資訊：</div>
    </div>

    <div class="text-center my-4">
      <div id="line1" class="fs-4 fw-semibold"></div>
      <div id="line2" class="fs-5 mt-2"></div>
      <div id="line3" class="fs-5 mt-3"></div>
    </div>

    <div class="text-center mt-4">
      <a href="index.html" class="btn btn-primary px-4 me-2">返回預約首頁</a>
      <a href="query.html" class="btn btn-outline-secondary px-4">查詢/取消預約</a>
    </div>

    <div class="text-center mt-3">
      <button id="shareBtn" class="btn btn-link text-decoration-none">
        📄 分享
      </button>
    </div>

    <div id="filledAt" class="text-center text-secondary mt-2 small"></div>

    <div class="text-secondary mt-4" style="display:flex;align-items:flex-start;gap:.5rem;">
      <span style="font-size:20px;line-height:1.1;">🌟</span>
      <span>請在預約的門診時間內到場報到，過號則須等待現場安排叫名字，逾期自動取消。</span>
    </div>
  </div>
</div>

<script>
// 👉 你的 GAS /exec
const API = "https://script.google.com/macros/s/AKfycbxIAVoc2Rwdtpm9dYecLQ5fLQb64yjk12D1IIId1_TwN2ptzh6is23mTMjye0VJI71p/exec";

// 讀 URL 參數
const params = new URLSearchParams(location.search);
const id = params.get('id');

// DOM
const line1   = document.getElementById('line1'); // 日期 + 星期 +（診別）+ 時段
const line2   = document.getElementById('line2'); // 填表時間（格式化）… → 需求：移到最底，所以這行改顯示在 line2 for now? 依需求：line2 顯示空，填表時間改放 filledAt
const line3   = document.getElementById('line3'); // 姓名 + 號碼
const filledAt = document.getElementById('filledAt');
const shareBtn = document.getElementById('shareBtn');

const WEEK = ['日','一','二','三','四','五','六'];

// 取預約詳細（GAS: action=detail），再用 getSlots 取得該日該診別的時段字串
(async function init(){
  if(!id){
    alert('無法取得預約資料'); location.href='index.html'; return;
  }
  try{
    // 1) 明細
    const r = await axios.get(API, { params:{ action:'detail', id } });
    const d = r.data || {};
    // d: {date, slot, name, birthday, pid, phone, num, time}

    // 2) 取該日門診時段（從 getSlots 找 label 對應）
    let timeRange = '';
    try{
      const s = await axios.get(API, { params:{ action:'getSlots', date:d.date } });
      const hit = (s.data||[]).find(x => x.label === d.slot);
      timeRange = hit?.time || '';
    }catch(e){ /* keep empty */ }

    // 顯示行
    const dt = new Date(d.date + 'T00:00:00');
    const w  = WEEK[dt.getDay()];
    line1.textContent = `${d.date} 星期${w}（${d.slot}）${timeRange? ' ' + timeRange : ''}`;
    line2.textContent = ''; // 需求：填表時間放最下方，所以這行不顯示內容
    line3.textContent = `姓名：${d.name}，號碼：${d.num} 號。`;

    // 底部填表時間
    const ft = d.time ? new Date(d.time) : null;
    if(ft && !isNaN(ft)){
      filledAt.textContent = formatDateTime(ft);
    }else{
      // GAS 若回的是 Apps Script 內部日期（非 ISO），試著直接顯示字串
      filledAt.textContent = d.time || '';
    }

    // 分享
    const shareText = [
      '✔️陳萬龍診所門診預約成功！',
      '預約資訊：',
      '',
      `${d.date} 星期${w}（${d.slot}）${timeRange}`,
      '',
      `姓名：${d.name}，號碼：${d.num} 號。`,
      '🌟請在預約的門診時間內到場報到，過號則須等待現場安排叫名字，逾期自動取消。`
    ].join('\n');

    shareBtn.onclick = async ()=>{
      try{
        if(navigator.share){
          await navigator.share({ text: shareText });
        }else{
          await navigator.clipboard.writeText(shareText);
          alert('已複製分享內容！');
        }
      }catch(_){}
    };

  }catch(e){
    console.error(e);
    alert('無法取得預約資料'); location.href='index.html';
  }
})();

function pad2(n){ return n<10? '0'+n : ''+n; }
function formatDateTime(dt){
  // 顯示為：YYYY/MM/DD HH:MM:SS
  const Y = dt.getFullYear();
  const M = pad2(dt.getMonth()+1);
  const D = pad2(dt.getDate());
  const h = pad2(dt.getHours());
  const m = pad2(dt.getMinutes());
  const s = pad2(dt.getSeconds());
  return `${Y}/${M}/${D} ${h}:${m}:${s}`;
}
</script>
</body>
</html>
