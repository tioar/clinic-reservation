<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>é ç´„æˆåŠŸ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="card" style="max-width:720px;margin:40px auto;">
  <div class="text-center">
    <div style="font-size:52px;line-height:1">âœ…</div>
    <h2 class="mt-2">é ç´„æˆåŠŸï¼</h2>
    <p class="text-muted">æ‚¨çš„é ç´„è³‡è¨Šï¼š</p>

    <div id="info" class="fw-bold" style="white-space:pre-wrap"></div>

    <div class="d-flex gap-3 justify-content-center mt-4">
      <a class="btn btn-primary" href="index.html">è¿”å›é ç´„é¦–é </a>
      <a class="btn btn-outline-primary" href="query.html">æŸ¥è©¢/å–æ¶ˆé ç´„</a>
    </div>

    <div class="mt-3">
      <a id="share" href="#" class="text-decoration-none">ğŸ“® åˆ†äº«</a>
    </div>
  </div>
</div>

<script>
// ğŸ‘‰ åŒä¸€æ”¯ GAS
const API = "https://script.google.com/macros/s/AKfycbyO-CCSC7NAUfF10O34J4pd-Bn3YL7QgyCUNxgKfg-UWzQ7U_ajiI0jayCvHxD3NSKQ/exec";

const qs   = new URLSearchParams(location.search);
const id   = qs.get('id');

if(!id){
  document.getElementById('info').textContent = 'ç„¡æ³•å–å¾—é ç´„è³‡æ–™ï¼ˆç¼ºå°‘ idï¼‰ã€‚';
}else{
  load();
}

async function load(){
  try{
    // 1) è®€å–å–®ç­†è©³æƒ…
    const r1 = await axios.get(API, { params: { action:'detail', id }});
    const data = r1.data || {};

    // data æœƒæœ‰ï¼šdate(YYYY-MM-DD), slot, name, num, time(ISO)
    const dateStr = data.date;     // '2025-08-22'
    const slot    = data.slot || '';
    const name    = data.name || '';
    const num     = data.num  || '';

    // 2) ç”¨ date å†æŸ¥è©²æ—¥çš„æ™‚æ®µï¼Œæ‰¾å‡ºå°æ‡‰è¨ºåˆ¥çš„ time range
    let timeRange = '';
    if(dateStr && slot){
      const r2 = await axios.get(API, { params: { action:'getSlots', date: dateStr }});
      const slots = r2.data || [];
      const hit = slots.find(s => String(s.label) === String(slot));
      timeRange = hit?.time || '';
    }

    // 3) è½‰æœ¬åœ°ï¼ˆå°ç£ï¼‰æ ¼å¼
    const weekdayText = (d) => {
      const wd = new Date(d + 'T00:00:00+08:00').toLocaleDateString('zh-TW', {
        timeZone:'Asia/Taipei', weekday:'long'
      });
      return wd.replace('æ˜ŸæœŸ', 'æ˜ŸæœŸ'); // ä¿æŒåŸæ¨£ï¼Œä¿éšªå¯«æ³•
    };
    const displayDate = new Date(dateStr + 'T00:00:00+08:00').toLocaleDateString('zh-TW', {
      timeZone:'Asia/Taipei', year:'numeric', month:'2-digit', day:'2-digit'
    }) + ` ${weekdayText(dateStr)}`;

    const createdAt = data.time
      ? new Date(data.time).toLocaleString('zh-TW', {
          timeZone:'Asia/Taipei', hour12:false,
          year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
        })
      : '';

    // 4) çµ„ç•«é¢
    const info = document.getElementById('info');
    info.innerHTML =
      `${displayDate}ï¼ˆ${slot}${timeRange ? 'ãƒ»' + timeRange : ''}ï¼‰\n` +
      `${createdAt ? createdAt + '\n' : ''}\n` +
      `å§“åï¼š${name}ï¼Œè™Ÿç¢¼ï¼š${num} è™Ÿã€‚`;

    // åˆ†äº«
    document.getElementById('share').onclick = async (e)=>{
      e.preventDefault();
      const text =
        `é ç´„æˆåŠŸ\n` +
        `${displayDate}ï¼ˆ${slot}${timeRange ? 'ãƒ»' + timeRange : ''}ï¼‰\n` +
        `å§“åï¼š${name}ï¼Œè™Ÿç¢¼ï¼š${num}è™Ÿ`;
      try{
        if(navigator.share){
          await navigator.share({ title:'é ç´„æˆåŠŸ', text, url: location.href });
        }else{
          await navigator.clipboard.writeText(text + '\n' + location.href);
          alert('å·²è¤‡è£½åˆ†äº«å…§å®¹ï¼');
        }
      }catch(_){}
    };
  }catch(err){
    console.error(err);
    document.getElementById('info').textContent = 'ç„¡æ³•å–å¾—é ç´„è³‡æ–™';
  }
}
</script>
</body>
</html>
