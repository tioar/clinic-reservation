<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>é ç´„æˆåŠŸ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="result-card container py-5">
  <div class="mx-auto bg-white shadow rounded-4 p-4 p-md-5" style="max-width:820px;">
    <div class="text-center mb-3">
      <div style="font-size:64px; line-height:1;">âœ…</div>
      <h2 class="fw-bold mt-3">é ç´„æˆåŠŸï¼</h2>
      <div class="text-secondary mt-2">æ‚¨çš„é ç´„è³‡è¨Šï¼š</div>
    </div>

    <div class="text-center my-4">
      <div id="line1" class="fs-4 fw-semibold"></div>
      <div id="line2" class="fs-5 mt-2"></div>
      <div id="line3" class="fs-5 mt-3"></div>
    </div>

    <div class="text-center mt-4">
      <a href="index.html" class="btn btn-primary px-4 me-2">è¿”å›é ç´„é¦–é </a>
      <a href="query.html" class="btn btn-outline-secondary px-4">æŸ¥è©¢/å–æ¶ˆé ç´„</a>
    </div>

    <div class="text-center mt-3">
      <button id="shareBtn" class="btn btn-link text-decoration-none">
        ğŸ“„ åˆ†äº«
      </button>
    </div>

    <div id="filledAt" class="text-center text-secondary mt-2 small"></div>

    <div class="text-secondary mt-4" style="display:flex;align-items:flex-start;gap:.5rem;">
      <span style="font-size:20px;line-height:1.1;">ğŸŒŸ</span>
      <span>è«‹åœ¨é ç´„çš„é–€è¨ºæ™‚é–“å…§åˆ°å ´å ±åˆ°ï¼Œéè™Ÿå‰‡é ˆç­‰å¾…ç¾å ´å®‰æ’å«åå­—ï¼Œé€¾æœŸè‡ªå‹•å–æ¶ˆã€‚</span>
    </div>
  </div>
</div>

<script>
// ğŸ‘‰ ä½ çš„ GAS /exec
const API = "https://script.google.com/macros/s/AKfycbxIAVoc2Rwdtpm9dYecLQ5fLQb64yjk12D1IIId1_TwN2ptzh6is23mTMjye0VJI71p/exec";

// è®€ URL åƒæ•¸
const params = new URLSearchParams(location.search);
const id = params.get('id');

// DOM
const line1   = document.getElementById('line1'); // æ—¥æœŸ + æ˜ŸæœŸ +ï¼ˆè¨ºåˆ¥ï¼‰+ æ™‚æ®µ
const line2   = document.getElementById('line2'); // å¡«è¡¨æ™‚é–“ï¼ˆæ ¼å¼åŒ–ï¼‰â€¦ â†’ éœ€æ±‚ï¼šç§»åˆ°æœ€åº•ï¼Œæ‰€ä»¥é€™è¡Œæ”¹é¡¯ç¤ºåœ¨ line2 for now? ä¾éœ€æ±‚ï¼šline2 é¡¯ç¤ºç©ºï¼Œå¡«è¡¨æ™‚é–“æ”¹æ”¾ filledAt
const line3   = document.getElementById('line3'); // å§“å + è™Ÿç¢¼
const filledAt = document.getElementById('filledAt');
const shareBtn = document.getElementById('shareBtn');

const WEEK = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

// å–é ç´„è©³ç´°ï¼ˆGAS: action=detailï¼‰ï¼Œå†ç”¨ getSlots å–å¾—è©²æ—¥è©²è¨ºåˆ¥çš„æ™‚æ®µå­—ä¸²
(async function init(){
  if(!id){
    alert('ç„¡æ³•å–å¾—é ç´„è³‡æ–™'); location.href='index.html'; return;
  }
  try{
    // 1) æ˜ç´°
    const r = await axios.get(API, { params:{ action:'detail', id } });
    const d = r.data || {};
    // d: {date, slot, name, birthday, pid, phone, num, time}

    // 2) å–è©²æ—¥é–€è¨ºæ™‚æ®µï¼ˆå¾ getSlots æ‰¾ label å°æ‡‰ï¼‰
    let timeRange = '';
    try{
      const s = await axios.get(API, { params:{ action:'getSlots', date:d.date } });
      const hit = (s.data||[]).find(x => x.label === d.slot);
      timeRange = hit?.time || '';
    }catch(e){ /* keep empty */ }

    // é¡¯ç¤ºè¡Œ
    const dt = new Date(d.date + 'T00:00:00');
    const w  = WEEK[dt.getDay()];
    line1.textContent = `${d.date} æ˜ŸæœŸ${w}ï¼ˆ${d.slot}ï¼‰${timeRange? ' ' + timeRange : ''}`;
    line2.textContent = ''; // éœ€æ±‚ï¼šå¡«è¡¨æ™‚é–“æ”¾æœ€ä¸‹æ–¹ï¼Œæ‰€ä»¥é€™è¡Œä¸é¡¯ç¤ºå…§å®¹
    line3.textContent = `å§“åï¼š${d.name}ï¼Œè™Ÿç¢¼ï¼š${d.num} è™Ÿã€‚`;

    // åº•éƒ¨å¡«è¡¨æ™‚é–“
    const ft = d.time ? new Date(d.time) : null;
    if(ft && !isNaN(ft)){
      filledAt.textContent = formatDateTime(ft);
    }else{
      // GAS è‹¥å›çš„æ˜¯ Apps Script å…§éƒ¨æ—¥æœŸï¼ˆé ISOï¼‰ï¼Œè©¦è‘—ç›´æ¥é¡¯ç¤ºå­—ä¸²
      filledAt.textContent = d.time || '';
    }

    // åˆ†äº«
    const shareText = [
      'âœ”ï¸é™³è¬é¾è¨ºæ‰€é–€è¨ºé ç´„æˆåŠŸï¼',
      'é ç´„è³‡è¨Šï¼š',
      '',
      `${d.date} æ˜ŸæœŸ${w}ï¼ˆ${d.slot}ï¼‰${timeRange}`,
      '',
      `å§“åï¼š${d.name}ï¼Œè™Ÿç¢¼ï¼š${d.num} è™Ÿã€‚`,
      'ğŸŒŸè«‹åœ¨é ç´„çš„é–€è¨ºæ™‚é–“å…§åˆ°å ´å ±åˆ°ï¼Œéè™Ÿå‰‡é ˆç­‰å¾…ç¾å ´å®‰æ’å«åå­—ï¼Œé€¾æœŸè‡ªå‹•å–æ¶ˆã€‚`
    ].join('\n');

    shareBtn.onclick = async ()=>{
      try{
        if(navigator.share){
          await navigator.share({ text: shareText });
        }else{
          await navigator.clipboard.writeText(shareText);
          alert('å·²è¤‡è£½åˆ†äº«å…§å®¹ï¼');
        }
      }catch(_){}
    };

  }catch(e){
    console.error(e);
    alert('ç„¡æ³•å–å¾—é ç´„è³‡æ–™'); location.href='index.html';
  }
})();

function pad2(n){ return n<10? '0'+n : ''+n; }
function formatDateTime(dt){
  // é¡¯ç¤ºç‚ºï¼šYYYY/MM/DD HH:MM:SS
  const Y = dt.getFullYear();
  const M = pad2(dt.getMonth()+1);
  const D = pad2(dt.getDate());
  const h = pad2(dt.getHours());
  const m = pad2(dt.getMinutes());
  const s = pad2(dt.getSeconds());
  return `${Y}/${M}/${D} ${h}:${m}:${s}`;
}
</script>
</body>
</html>
